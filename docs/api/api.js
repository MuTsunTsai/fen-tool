(()=>{var t=/\/|\d+|\(!?[kqbnrp]\d?\)|[-~]?(\*\d)?([kqbsnrpcx]|'[^']|''..)|./giu;var e={pattern:void 0,bg:void 0,border:"1",blackWhite:!1,knightOffset:.6,SN:!1,size:44,w:8,h:8,set:"1echecs"},n=/^\d+(,\d+)*$/,s=[26,32,38,44],r=["1echecs","alpha","goodCompanion","merida","skak"];function o(t){const e=t.split(",").map((t=>{const e=Number(t);return isNaN(e)?0:Math.abs(Math.floor(e))})),n=e.reduce(((t,e)=>t+e),0);return{array:e,size:n}}var a="０１２３４５６７８９".split(""),i=function(){const t=new Map,e="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ,./<>?;':\"[]\\{}|!@#$%^&*()_+-=`~".split(""),n="ａｂｃｄｅｆｇｈｉｊｋｌｍｎｏｐｑｒｓｔｕｖｗｘｙｚＡＢＣＤＥＦＧＨＩＪＫＬＭＮＯＰＱＲＳＴＵＶＷＸＹＺ，．／＜＞？；’：”〔〕＼｛｝｜！＠＃＄％︿＆＊（）ˍ＋－＝‘～".split("");for(let s=0;s<e.length;s++)t.set(e[s],n[s]);for(let e=0;e<10;e++)t.set(e.toString(),a[e]);return t}();var c=["k","q","b","n","r","p","c","x"],l=document.createElement("canvas"),f=l.getContext("2d"),h=document.createElement("canvas"),g=h.getContext("2d"),u={26:[0,0,0,0,0,0,97,213,97,0,0,213,255,213,0,0,97,213,97,0,0,0,0,0,0],32:[0,0,10,0,0,0,163,255,163,0,10,255,255,255,10,0,163,255,163,0,0,0,10,0,0],38:[0,12,62,12,0,12,220,255,220,12,62,255,255,255,62,12,220,255,220,12,0,12,62,12,0],44:[0,47,114,47,0,47,249,255,249,47,114,255,255,255,114,47,249,255,249,47,0,47,114,47,0]};function d(t,e,n,s,r){const a=o(s.border),i=s.w*s.size+2*a.size,c=s.h*s.size+2*a.size;t.canvas.width=i,t.canvas.height=c;const d="classic"==s.bg,w=r||d;w&&t.clearRect(0,0,i,c),t.save(),t.translate(a.size,a.size);for(let r=0;r<s.h;r++)for(let o=0;o<s.w;o++)w||m(t,r,o,s),b(t,e,r,o,n[r*s.w+o],s);if(t.restore(),d&&!r){!function(t,e){const n=t.canvas;h.width=l.width=n.width,h.height=l.height=n.height,f.drawImage(n,0,0),t.save(),t.fillStyle="white",t.fillRect(0,0,n.width,n.height),t.globalCompositeOperation="destination-in",t.drawImage(l,0,0),t.restore(),t.save();for(let s=0;s<5;s++)for(let r=0;r<5;r++){const o=u[e][5*r+s];0!=o&&(t.globalAlpha=o/255,g.drawImage(n,s-2,r-2))}t.restore()}(t,s.size),t.save(),t.translate(a.size,a.size);for(let e=0;e<s.h;e++)for(let n=0;n<s.w;n++)m(t,e,n,s);t.restore(),t.drawImage(h,0,0),t.drawImage(h,0,0),t.drawImage(h,0,0),t.drawImage(l,0,0)}r||function(t,e,n,s){t.save();let r=0;for(let o=0;o<e.array.length;o++){const a=e.array[o];if(t.strokeStyle=o%2?"white":"black",0==a)continue;t.lineWidth=a;const i=e.size-r-a/2;t.strokeRect(i,i,n-2*i,s-2*i),r+=a}t.restore()}(t,a,i,c)}function b(t,e,n,s,r,o){const a=o.size,l=r.startsWith("-");l&&(r=r.substring(1));const f=r.match(/^\*(\d)/);let h=f&&f[1]||void 0;void 0!==h&&(r=r.substring(2)),h=Number(h)%4,"s"==r&&(r="n"),"S"==r&&(r="N");const g=r.toLowerCase(),u=c.indexOf(g),d=r.startsWith("'");if(u<0&&!d)return;t.save();const b=o.blackWhite,m=l?b?0:2:r==g?0:1,w=l&&b?"n"==g?o.knightOffset:.5:1,[p,v]=[h+1&2?1:0,2&h?1:0];if(t.translate((s+p)*a,(n+v)*a),0!==h&&t.rotate(Math.PI/2*h),d){const e=r.substring(1);!function(t,e,n){t.save();const s=/\p{Extended_Pictographic}/u.test(e),r=n-4;t.font=`${r}px arial`;const o=n-2;let a=t.measureText(e);if(s&&a.width>o){const n=o/a.width;t.font=r*n+"px arial",a=t.measureText(e)}const i=a.actualBoundingBoxAscent-a.actualBoundingBoxDescent,c=(n-Math.min(a.width,o))/2,l=Math.max((n-i)/2,0);t.fillStyle="black",t.fillText(e,c,n-l,o),t.restore()}(t,r.startsWith("''")?r.substring(2):(k=e,((z=!1)&&"c"==k.toLowerCase()?"‧":z&&"x"==k.toLowerCase()?"╳":i.get(k))||e),a)}else t.drawImage(e,m*a,u*a,a*w,a,0,0,a*w,a),l&&b&&t.drawImage(e,(1+w)*a,u*a,a*(1-w),a,a*w,0,a*(1-w),a);var k,z;t.restore()}function m(t,e,n,s){const r=function(t,e,n){if("mono"==t)return 1;let s=(e+n)%2;return"inverted"!=t&&(s=1-s),s}(s.pattern,e,n),o=s.size;if(t.save(),t.translate(n*o,e*o),"classic"==s.bg){if(t.strokeStyle="black",t.lineWidth=o/60,t.fillStyle="#fff",t.fillRect(0,0,o,o),!r){t.beginPath();const e=o/8;for(let n=0;n<o;n+=e)t.moveTo(o-n,0),t.lineTo(0,o-n),n>0&&(t.moveTo(n,o),t.lineTo(o,n));t.stroke()}}else t.fillStyle=function(t,e){return"classic"==e?"none":"gray"==e?t?"#fff":"#bbb":"green"==e?t?"#EEEED2":"#769656":t?"#FFCE9E":"#D18B47"}(r,s.bg),t.fillRect(0,0,o,o);t.restore()}var w=document.getElementById("CN"),p=w.getContext("2d");var v=new Map;parent.postMessage(null,"*"),onmessage=async a=>{if(a.source!=parent||!a.ports[0])return;gtag("event","fen_sdk_gen");const i=function(t){const o=Object.assign({},e);if(t){const e=Number(t.size),a=Math.floor(Number(t.w)),i=Math.floor(Number(t.h));s.includes(e)&&(o.size=e),r.includes(t.set)&&(o.set=t.set),t.border&&t.border.match(n)&&(o.border=t.border),0<t.knightOffset&&t.knightOffset<1&&(o.knightOffset=t.offset),o.blackWhite=Boolean(t.blackWhite),o.pattern=t.pattern,o.bg=t.bg,o.SN=t.SN,a>0&&(o.w=a),i>0&&(o.h=i)}return o}(a.data.options),c=a.data.fen||"8/8/8/8/8/8/8/8",{w:l,h:f}=function(e){const n=e.match(t)||[],s=[0];let r=0;for(const t of n)"/"==t?s[++r]=0:t.match(/^\d+$/)?s[r]+=Number(t):s[r]++;const o=s.length;if(1==o)return;const a=s[0];for(const t of s)if(t!=a)return;return{w:a,h:o}}(c)||i,h=function(e,n=8,s=8){const r=e.match(t)||[],o=[];let a=!1;for(const t of r){if("/"==t){if(!a){const t=o.length+n-o.length%n;for(;o.length<t;)o.push("")}}else if(t.match(/^\d+$/)){const e=Number(t);for(let t=0;t<e;t++)o.push("")}else o.push(t);if(a="/"!=t&&o.length%n==0,o.length==n*s)break}for(;o.length<n*s;)o.push("");return o}(c,l,f);i.w=l,i.h=f;const g=await function(t){const e=t.set+t.size;if(v.has(e))return v.get(e);{const n=new Promise((e=>{const n=new Image;n.onload=()=>e(n),n.src=`../assets/${t.set}${t.size}.png`}));return v.set(e,n),n}}(i),u=function(t,e,n){const s=o(n.border),r=n.w*n.size+2*s.size,a=n.h*n.size+2*s.size;return w.width=r,w.height=a,d(p,t,e,n),w}(g,h,i);a.ports[0].postMessage(u.toDataURL())}})();