const{createApp:createApp,reactive:reactive}=PetiteVue,savedSettings=JSON.parse(localStorage.getItem("settings"))||{},settings={BBS:{PDB:!0,coordinates:!0,notes:!0,uncoloredNotes:!1,redBlue:!1},PDB:{exact:!1},board:{uncolored:!1,inverted:!1,grayBG:!1,blackWhite:!1,knightOffset:.5,SN:!1,size:44,set:"1echecs"},message:{touchTip:!0}};for(let e in settings)Object.assign(settings[e],savedSettings[e]);const store=reactive(settings),state=reactive({loading:!0});function saveSettings(){localStorage.setItem("settings",JSON.stringify(store))}let horMode=!1,collapseMode=!1;const squares=new Array(64),CN=document.getElementById("CN"),TP=document.getElementById("TP"),CG=document.getElementById("CanvasGhost"),TPG=document.getElementById("TemplateGhost"),ctx=CN.getContext("2d"),gCtx=CG.getContext("2d");createSquares();const fullWidthMap=function(){const e=new Map,t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ,./<>?;':\"[]\\{}|!@#$%^&*()_+-=`~".split(""),o="ａｂｃｄｅｆｇｈｉｊｋｌｍｎｏｐｑｒｓｔｕｖｗｘｙｚＡＢＣＤＥＦＧＨＩＪＫＬＭＮＯＰＱＲＳＴＵＶＷＸＹＺ，．／＜＞？；’：”〔〕＼｛｝｜！＠＃＄％︿＆＊（）ˍ＋－＝‘～".split("");for(let s=0;s<t.length;s++)e.set(t[s],o[s]);return e}(),us=unescape("%1B"),A1="０１２３４５６７８９".split(""),A2="黑白,ｐＰ ＝ 小兵,ｒＲ ＝ 城堡,ｎＮ ＝ 騎士,ｂＢ ＝ 主教,ｑＱ ＝ 皇后,ｋＫ ＝ 國王,".split(","),A3=",ｐ ＝ 小兵,ｒ ＝ 城堡,ｎ ＝ 騎士,ｂ ＝ 主教,ｑ ＝ 皇后,ｋ ＝ 國王,".split(","),FEN=document.getElementById("FEN"),PDB=document.getElementById("PDB"),Zone=document.getElementById("Zone"),DragZone=document.getElementById("DragZone"),EditZone=document.getElementById("EditZone"),img=new Image;function load(e){store.board.set=e,state.loading=!0,img.src=TPG.src=`assets/${store.board.set}${store.board.size}.png`}function setSize(e,t){const o=parseFloat(getComputedStyle(document.documentElement).fontSize),s=document.body.clientWidth<11*e+2*o;if(s!==horMode||e!==store.board.size||t){horMode=s,store.board.size=e;const t=8*e+2;CN.style.width=t+"px",CG.width=CN.width=t,CG.height=CN.height=t,ctx.font=gCtx.font=e-4+"px arial",horMode?(TPG.height=TP.height=3*e+2,TPG.width=TP.width=t,CN.classList.add("mb-3"),TP.classList.remove("ms-4")):(TPG.width=TP.width=3*e+2,TPG.height=TP.height=t,CN.classList.remove("mb-3"),TP.classList.add("ms-4")),load(store.board.set)}resize()}function resize(){CG.style.width=CG.style.height=CN.style.height=CN.clientWidth+"px",TPG.style.width=TP.clientWidth+"px",TPG.style.height=TP.clientHeight+"px",setSquareSize();const e=parseFloat(getComputedStyle(document.documentElement).fontSize);Zone.clientWidth<DragZone.clientWidth+CN.clientWidth+6*e?(EditZone.style.marginTop=-DragZone.clientHeight+"px",EditZone.style.width=DragZone.clientWidth+"px",EditZone.style.textAlign=horMode?"center":"start",collapseMode=!0):(EditZone.style.marginTop="0",EditZone.style.width="unset",EditZone.style.textAlign="unset",collapseMode=!1)}img.onload=()=>{state.loading=!1,drawTemplate()},"https:"==location.protocol?img.crossOrigin="anonymous":document.getElementById("B64").disabled=!0,window.addEventListener("resize",(()=>setSize(store.board.size))),setSize(store.board.size,!0),setTimeout(resize,1e3);const types=["k","q","b","n","r","p","c","x"];function drawTemplate(){const e=store.board.size,t=TP.getContext("2d"),o=TPG.getContext("2d");let s=3*e+2,n=8*e+2;horMode&&([s,n]=[n,s]),t.fillStyle="black",t.fillRect(0,0,s,n),o.clearRect(0,0,s,n);const a=store.board.grayBG;for(let s=0;s<3;s++)for(let n=0;n<8;n++){const r=a?6:(s+n)%2?0:3,l=store.board.blackWhite&&2==s,i=l?3==n?store.board.knightOffset:.5:1,c=l?0:s;a&&(t.fillStyle=(s+n)%2?"#bbb":"#fff",t.fillRect((horMode?n:s)*e+1,(horMode?s:n)*e+1,e,e)),t.drawImage(img,(c+r)*e,n*e,e*i,e,(horMode?n:s)*e+1,(horMode?s:n)*e+1,e*i,e),o.drawImage(img,(c+6)*e,n*e,e*i,e,(horMode?n:s)*e,(horMode?s:n)*e,e*i,e),l&&(t.drawImage(img,(1+i+r)*e,n*e,e*(1-i),e,(i+(horMode?n:s))*e+1,(horMode?s:n)*e+1,e*(1-i),e),o.drawImage(img,(7+i)*e,n*e,e*(1-i),e,(i+(horMode?n:s))*e,(horMode?s:n)*e,e*(1-i),e))}draw()}async function draw(){const e=8*store.board.size+2;ctx.fillStyle="black",ctx.fillRect(0,0,e,e),dragging||gCtx.clearRect(0,0,e,e);for(let e=0;e<8;e++)for(let t=0;t<8;t++){const o=store.board.uncolored||store.board.inverted==Boolean((e+t)%2),s=squares[8*e+t].value;drawBlank(e,t,o),drawPiece(e,t,s,o)}if("https:"==location.protocol){const e=document.getElementById("Save");e.href&&URL.revokeObjectURL(e.href),e.href=URL.createObjectURL(await getBlob())}}function drawPiece(e,t,o,s){const n=store.board.size,a=o.startsWith("-");a&&(o=o.substring(1));const r=o.match(/^\*(\d)/);let l=r&&r[1]||void 0;void 0!==l&&(o=o.substring(2)),l=Number(l)%4,"s"==o&&(o="n"),"S"==o&&(o="N");const i=o.toLowerCase(),c=types.indexOf(i),u=o.startsWith("'");if(c<0&&!u)return!1;u&&drawBlank(e,t,s),bCtx.save();const d=store.board.blackWhite,g=a?d?0:2:o==i?0:1,f=a&&d?"n"==i?store.board.knightOffset:.5:1,h=store.board.grayBG?6:s?3:0,[p,m]=[l+1&2?1:0,2&l?1:0];if(bCtx.translate((t+p)*n+1,(e+m)*n+1),0!==l&&bCtx.rotate(Math.PI/2*l),u){const e=o.substring(1),t=o.startsWith("''")?o.substring(2):fullWidth(e,!1)||e;ctx.fillStyle=gCtx.fillStyle="black";const s=ctx.measureText(t),a=s.actualBoundingBoxAscent-s.actualBoundingBoxDescent,r=Math.max((n-s.width)/2,0),l=Math.max((n-a)/2,0);bCtx.fillText(t,r,n-l,n)}else ctx.drawImage(img,(g+h)*n,c*n,n*f,n,0,0,n*f,n),gCtx.drawImage(img,(g+6)*n,c*n,n*f,n,0,0,n*f,n),a&&d&&(ctx.drawImage(img,(1+f+h)*n,c*n,n*(1-f),n,n*f,0,n*(1-f),n),gCtx.drawImage(img,(7+f)*n,c*n,n*(1-f),n,n*f,0,n*(1-f),n));return bCtx.restore(),!0}const bCtx=new Proxy({},{get:(e,t)=>function(...e){ctx[t](...e),dragging||gCtx[t](...e)}});function drawBlank(e,t,o){store.board.grayBG?ctx.fillStyle=o?"#fff":"#bbb":ctx.fillStyle=o?"#FFCE9E":"#D18B47";const s=store.board.size;ctx.fillRect(t*s+1,e*s+1,s,s)}function updateBG(){setSquareBG(),drawTemplate()}function toFEN(){let e=0,t="";for(let o=0;o<8;o++){for(let s=0;s<8;s++){const n=8*o+s;e&&""!=squares[n].value&&(t+=e,e=0),""==squares[n].value?(e++,7==s&&(t+=e,e=0)):t+=squares[n].value}o<7&&(t+="/")}FEN.value=t,draw()}function toSquares(e){let t=0,o=[...FEN.value],s=!1;function n(e){return o.slice(t,t+e).join("")}for(let e=0;e<8;e++)for(let a=0;a<8;a++){const r=8*e+a;let l=o[t]||"";if("/"==l)t++,a--;else if("*"==l)squares[r].value=n(3),t+=3;else if("-"==l||"~"==l)"*"==o[t+1]?(squares[r].value=n(4),t+=4):(squares[r].value=n(2),t+=2);else if("'"==l)"'"==o[t+1]?(squares[r].value=n(4),t+=4):(squares[r].value=n(2),t+=2);else if(l.match(/\d/)){let o=Number(l);for(let t=0;t<o;t++)t&&(a++,8==a&&(e++,a=0)),squares[8*e+a].value="";t++}else squares[r].value=l,t++;s=checkInputCore(squares[r])||s}s||e?toFEN():draw()}function squareOnFocus(){this.select()}function squareOnBlur(){this.style.zIndex="unset"}function createSquares(){const e=document.getElementById("Squares");for(let t=0;t<8;t++)for(let o=0;o<8;o++){const s=8*t+o;squares[s]=document.createElement("input"),squares[s].type="text",squares[s].onchange=checkInput,squares[s].onfocus=squareOnFocus,squares[s].onblur=squareOnBlur,squares[s].style.background=(t+o)%2?"#D18B47":"#FFCE9E",squares[s].classList.add("square"),e.appendChild(squares[s])}setSquareBG()}function setSquareSize(){const e=document.getElementById("Squares"),t=realSize();e.style.height=e.style.width=CN.clientWidth+"px";for(let e=0;e<8;e++)for(let o=0;o<8;o++)squares[8*e+o].style.fontSize=t-10+"px",squares[8*e+o].style.lineHeight=t-10+"px"}function setSquareBG(){for(let e=0;e<8;e++)for(let t=0;t<8;t++){const o=squares[8*e+t],s=!store.board.uncolored&&Boolean((e+t)%2)!=store.board.inverted;store.board.grayBG?o.style.background=s?"#bbb":"#fff":o.style.background=s?"#D18B47":"#FFCE9E"}}const test=/^[-~]?(\*\d)?([kqbsnrpcx]|'.|''..)$/iu;function checkInput(){checkInputCore(this),toFEN()}function checkInputCore(e){let t=e.value;t.match(test)||(t=""),t=t.replace(/^~/,"-").replace(/^-(?=.*')/,""),t.startsWith("-")&&(t=t.toLowerCase()),t.match(/^-?(\*\d)?[sn]$/i)&&(t=store.board.SN?t.replace("n","s").replace("N","S"):t.replace("s","n").replace("S","N"));const o=t!=e.value;return e.value=t,o}function updateSN(){for(const e of squares)checkInputCore(e);toFEN()}function copyFEN(){gtag("event","fen_copy"),navigator.clipboard.writeText(FEN.value)}async function pasteFEN(){gtag("event","fen_paste"),FEN.value=await navigator.clipboard.readText(),toSquares(!0)}function toBase64(){gtag("event","link_copy"),navigator.clipboard.writeText(CN.toDataURL())}async function share(){gtag("event","img_share");const e=await getBlob(),t=[new File([e],"board.png",{type:"image/png"})];navigator.share({files:t})}function getBlob(){return new Promise((e=>CN.toBlob(e)))}function rotate(e){const t=squares.map((e=>e.value));for(let o=0;o<8;o++)for(let s=0;s<8;s++){const n=1==e?8*(7-s)+o:8*s+(7-o);squares[8*o+s].value=t[n]}toFEN()}function color(e){for(let t=0;t<64;t++){let o=squares[t].value;"'"!=o.substr(0,1)&&""!=o&&("-"!=o.substr(0,1)&&"~"!=o.substr(0,1)||(o=o.substr(1)),o=o.toLowerCase(),0==e&&(o="-"+o),1==e&&(o=o.toUpperCase()),squares[t].value=o)}toFEN()}function invertColor(e){for(let o=0;o<64;o++){let s=squares[o].value;""!=s&&"-"!=s.substr(0,1)&&((e||"'"!=s.substr(0,1))&&(t=s.toLowerCase(),s=s==t?s.toUpperCase():t,squares[o].value=s))}toFEN()}async function getPDB_FEN(){gtag("event","pdb_get");const e=document.getElementById("PDB_GET");e.disabled=!0,e.value="Fetching...";const t=pdbURL+encodeURIComponent(`PROBID='${PDB.value}'`),o=await fetch("https://corsproxy.io/?"+encodeURIComponent(t)),s=await o.text();FEN.value=s.match(/<b>FEN:<\/b> (.+)/)[1],toSquares(!0),e.disabled=!1,e.value="Get FEN"}const pdbURL="https://pdb.dieschwalbe.de/search.jsp?expression=",pdbMap=["K","D","L","S","T","B"];function getPDB_query(){let e=[];for(let t=0;t<8;t++)for(let o=0;o<8;o++){const s=squares[8*t+o].value;if(!s.match(/^[kqbsnrp]$/i))continue;const n=pdbMap[types.indexOf(s.toLowerCase().replace("s","n"))],a=s==s.toLowerCase()?"s":"w";e.push(a+n+String.fromCharCode(97+o)+(8-t))}let t=`POSITION='${e.join(" ")}'`;return store.PDB.exact&&(t+=` AND APIECES=${e.length}`),t}function searchPDB(){gtag("event","pdb_search"),window.open(pdbURL+encodeURIComponent(getPDB_query()))}function copyPDB(){gtag("event","pdb_copy"),navigator.clipboard.writeText(getPDB_query())}function generateBBS(){let e,t=[...FEN.value.replace(/\//g,"")],o="",s=0;function n(){"*"==e&&(s+=2,e=t[s])}for(let a=0;a<8;a++){store.BBS.coordinates&&(o+=us+"[m"+A1[8-a]+"　");for(let r=0;r<8;r++){if(e=t[s],n(),"~"==e&&(s++,e=t[s]),"-"==e)s++,e=t[s],n(),o+=us+"[0;37;"+BackgroundColor(a,r)+fullWidth(e,!0);else if("'"==e)o+=us+"[0;30;",o+=BackgroundColor(a,r),"'"==t[s+1]?(o+=t.slice(s+2,s+4).join(""),s+=3):(t[s+1].match(/\d/)?o+=A1[Number(t[s+1])]:o+=fullWidth(t[s+1],!1),s++);else if(e.match(/\d/)){let t=Number(e);for(let e=0;e<t;e++)e&&(r++,8==r&&(a++,r=0)),o+=us+"[0;30;",o+=BackgroundColor(a,r),o+="　"}else o+=us+"[",store.BBS.redBlue?(e==e.toUpperCase()?o+="1;31;":o+="1;34;",o+=BackgroundColor(a,r)+fullWidth(e.toLowerCase(),!0)):(e==e.toUpperCase()?o+="1;37;":o+="0;30;",o+=BackgroundColor(a,r)+fullWidth(e,!0));s++}store.BBS.notes&&(o+=us+"[m　　"+(store.BBS.uncoloredNotes?A3[a]:A2[a])),a<7&&(o+="\r\n")}o+=us+"[m\r\n",store.BBS.PDB&&(o+=us+"[0;30;40m"+PDB.value+us+"[m"),store.BBS.coordinates&&(o+="\r\n　　ａｂｃｄｅｆｇｈ\r\n"),o+=us+"[0;30;40m"+FEN.value+us+"[m\r\n",gtag("event","bbs_copy"),navigator.clipboard.writeText(o)}function BackgroundColor(e,t){return store.board.uncolored?"43;m":(e+t)%2?"42;m":"43;m"}function fullWidth(e,t){return t&&"c"==e.toLowerCase()?"‧":t&&"x"==e.toLowerCase()?"╳":fullWidthMap.get(e)}CN.onmousedown=mouseDown,CN.ontouchstart=mouseDown,TP.onmousedown=mouseDown,TP.ontouchstart=mouseDown;const TPv="k,K,-k,q,Q,-q,b,B,-b,n,N,-n,r,R,-r,p,P,-p,c,C,-c,x,X,-x".split(",");let startX,startY,sqX,sqY,sq,ghost,draggingValue,offset,lastTap=0,dragging=!1;function mousemove(e){wrapEvent(e),"pending"==dragging&&getDisplacement(e)>5&&(draggingValue?dragStart(e,!0):dragging=!1),!0===dragging&&dragMove(e)}function mouseup(e){if(collapseMode&&"pending"==dragging){const t=performance.now();t-lastTap<300&&(sq.style.zIndex="10",sq.focus()),lastTap=t,e.preventDefault(),dragging=!1}if(!dragging)return;if(dragging=!1,!draggingValue)return;wrapEvent(e);const t=realSize(),o=CN.getBoundingClientRect(),s=Math.floor((e.clientY-o.top-1)/t),n=Math.floor((e.clientX-o.left-1)/t),a=8*s+n;if(ghost.style.display="none",s>-1&&s<8&&n>-1&&n<8){const e=squares[a].value!==draggingValue;squares[a].value=draggingValue,e&&toFEN()}}function realSize(){return(CN.clientWidth-2)/8}function mouseDown(e){if(state.loading||0!=e.button&&!e.targetTouches||e.targetTouches&&e.targetTouches.length>1)return;wrapEvent(e),document.activeElement&&document.activeElement.blur();const t=realSize(),o=this==CN;startX=e.offsetX,startY=e.offsetY,sqX=Math.floor((startX-1)/t),sqY=Math.floor((startY-1)/t);const s=sqY*(o?8:3)+sqX;ghost=document.getElementById(o?"CanvasGhost":"TemplateGhost"),o&&(sq=squares[s],dragging="pending",draggingValue=void 0),o&&""==sq.value||(e.preventDefault(),ghost.style.clip=`rect(${2+sqY*t}px,${(sqX+1)*t}px,${(sqY+1)*t}px,${2+sqX*t}px)`,offset=o?0:1,o?draggingValue=sq.value:(draggingValue=horMode?TPv[3*sqX+sqY]:TPv[s],dragStart(e)))}function dragStart(e,t){ghost.style.display="block",t&&(sq.value="",toFEN()),dragging=!0,dragMove(e)}function getDisplacement(e){const t=e.offsetX-startX,o=e.offsetY-startY;return Math.sqrt(t*t+o*o)}function dragMove(e){const t=realSize(),o=CN.getBoundingClientRect(),s=Math.floor((e.clientY-o.top-1)/t),n=Math.floor((e.clientX-o.left-1)/t),{scrollLeft:a,scrollTop:r}=document.documentElement;s>-1&&s<8&&n>-1&&n<8?(ghost.style.left=o.left+(n-sqX)*t+offset+a+"px",ghost.style.top=o.top+(s-sqY)*t+offset+r+"px"):(ghost.style.left=e.clientX+a-startX+"px",ghost.style.top=e.clientY+r-startY+"px")}function wrapEvent(e){if(e.targetTouches){const t=e.target.getBoundingClientRect(),o=e.targetTouches[0]||e.changedTouches[0];e.clientX=o.clientX,e.clientY=o.clientY,e.offsetX=e.clientX-t.x,e.offsetY=e.clientY-t.y}}document.body.onmousemove=mousemove,document.body.ontouchmove=mousemove,document.body.onmouseup=mouseup,document.body.ontouchend=mouseup;let checkboxId=0;function Checkbox(e,t,o){const s=e.split(".");e=s.pop();let n=store;for(;s.length;)n=n[s.shift()];return{$template:"#checkbox",id:"chk"+checkboxId++,label:t,checked:()=>n[e],change:()=>{n[e]=!n[e],o&&o()}}}createApp({Checkbox:Checkbox,draw:draw,drawTemplate:drawTemplate,updateBG:updateBG,updateSN:updateSN,store:store,state:state,tab:0,saveSettings:saveSettings}).mount();