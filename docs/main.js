(()=>{Object.create;var t=Object.freeze,n=Object.defineProperty,o=(Object.getOwnPropertyDescriptor,Object.getOwnPropertyNames,Object.getPrototypeOf,Object.prototype.hasOwnProperty,(e,o)=>t(n(e,"raw",{value:t(o||e.slice())}))),r=Object.defineProperty,s=(e,t,n)=>(((e,t,n)=>{t in e?r(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);function a(e){if(y(e)){const t={};for(let n=0;n<e.length;n++){const o=e[n],r=w(o)?l(o):a(o);if(r)for(const e in r)t[e]=r[e]}return t}return w(e)||k(e)?e:void 0}var c=/;(?![^(]*\))/g,i=/:(.+)/;function l(e){const t={};return e.split(c).forEach((e=>{if(e){const n=e.split(i);n.length>1&&(t[n[0].trim()]=n[1].trim())}})),t}function u(e){let t="";if(w(e))t=e;else if(y(e))for(let n=0;n<e.length;n++){const o=u(e[n]);o&&(t+=o+" ")}else if(k(e))for(const n in e)e[n]&&(t+=n+" ");return t.trim()}function f(e,t){if(e===t)return!0;let n=v(e),o=v(t);if(n||o)return!(!n||!o)&&e.getTime()===t.getTime();if(n=y(e),o=y(t),n||o)return!(!n||!o)&&function(e,t){if(e.length!==t.length)return!1;let n=!0;for(let o=0;n&&o<e.length;o++)n=f(e[o],t[o]);return n}(e,t);if(n=k(e),o=k(t),n||o){if(!n||!o)return!1;if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const n in e){const o=e.hasOwnProperty(n),r=t.hasOwnProperty(n);if(o&&!r||!o&&r||!f(e[n],t[n]))return!1}}return String(e)===String(t)}function p(e,t){return e.findIndex((e=>f(e,t)))}var h,d=Object.assign,g=Object.prototype.hasOwnProperty,m=(e,t)=>g.call(e,t),y=Array.isArray,b=e=>"[object Map]"===E(e),v=e=>e instanceof Date,w=e=>"string"==typeof e,x=e=>"symbol"==typeof e,k=e=>null!==e&&"object"==typeof e,A=Object.prototype.toString,E=e=>A.call(e),S=e=>E(e).slice(8,-1),N=e=>w(e)&&"NaN"!==e&&"-"!==e[0]&&""+parseInt(e,10)===e,R=e=>{const t=Object.create(null);return n=>t[n]||(t[n]=e(n))},C=/-(\w)/g,P=R((e=>e.replace(C,((e,t)=>t?t.toUpperCase():"")))),O=/\B([A-Z])/g,I=R((e=>e.replace(O,"-$1").toLowerCase())),_=e=>{const t=parseFloat(e);return isNaN(t)?e:t};function B(e,t){(t=t||h)&&t.active&&t.effects.push(e)}var T,L=e=>{const t=new Set(e);return t.w=0,t.n=0,t},M=e=>(e.w&W)>0,$=e=>(e.n&W)>0,j=new WeakMap,D=0,W=1,z=30,F=[],U=Symbol(""),H=Symbol("");function K(e){const{deps:t}=e;if(t.length){for(let n=0;n<t.length;n++)t[n].delete(e);t.length=0}}function q(e,t){e.effect&&(e=e.effect.fn);const n=new class{constructor(e,t=null,n){this.fn=e,this.scheduler=t,this.active=!0,this.deps=[],B(this,n)}run(){if(!this.active)return this.fn();if(!F.includes(this))try{return F.push(T=this),Y.push(Q),Q=!0,W=1<<++D,D<=z?(({deps:e})=>{if(e.length)for(let t=0;t<e.length;t++)e[t].w|=W})(this):K(this),this.fn()}finally{D<=z&&(e=>{const{deps:t}=e;if(t.length){let n=0;for(let o=0;o<t.length;o++){const r=t[o];M(r)&&!$(r)?r.delete(e):t[n++]=r,r.w&=~W,r.n&=~W}t.length=n}})(this),W=1<<--D,Z(),F.pop();const e=F.length;T=e>0?F[e-1]:void 0}}stop(){this.active&&(K(this),this.onStop&&this.onStop(),this.active=!1)}}(e);t&&(d(n,t),t.scope&&B(n,t.scope)),(!t||!t.lazy)&&n.run();const o=n.run.bind(n);return o.effect=n,o}function G(e){e.effect.stop()}var Q=!0,Y=[];function Z(){const e=Y.pop();Q=void 0===e||e}function V(e,t,n){if(!Q||void 0===T)return;let o=j.get(e);o||j.set(e,o=new Map);let r=o.get(n);r||o.set(n,r=L()),function(e,t){let n=!1;D<=z?$(e)||(e.n|=W,n=!M(e)):n=!e.has(T),n&&(e.add(T),T.deps.push(e))}(r)}function J(e,t,n,o,r,s){const a=j.get(e);if(!a)return;let c=[];if("clear"===t)c=[...a.values()];else if("length"===n&&y(e))a.forEach(((e,t)=>{("length"===t||t>=o)&&c.push(e)}));else switch(void 0!==n&&c.push(a.get(n)),t){case"add":y(e)?N(n)&&c.push(a.get("length")):(c.push(a.get(U)),b(e)&&c.push(a.get(H)));break;case"delete":y(e)||(c.push(a.get(U)),b(e)&&c.push(a.get(H)));break;case"set":b(e)&&c.push(a.get(U))}if(1===c.length)c[0]&&X(c[0]);else{const e=[];for(const t of c)t&&e.push(...t);X(L(e))}}function X(e,t){for(const t of y(e)?e:[...e])(t!==T||t.allowRecurse)&&(t.scheduler?t.scheduler():t.run())}var ee=function(e,t){const n=Object.create(null),o=e.split(",");for(let e=0;e<o.length;e++)n[o[e]]=!0;return t?e=>!!n[e.toLowerCase()]:e=>!!n[e]}("__proto__,__v_isRef,__isVue"),te=new Set(Object.getOwnPropertyNames(Symbol).map((e=>Symbol[e])).filter(x)),ne=se(),oe=se(!0),re=function(){const e={};return["includes","indexOf","lastIndexOf"].forEach((t=>{e[t]=function(...e){const n=de(this);for(let e=0,t=this.length;e<t;e++)V(n,0,e+"");const o=n[t](...e);return-1===o||!1===o?n[t](...e.map(de)):o}})),["push","pop","shift","unshift","splice"].forEach((t=>{e[t]=function(...e){Y.push(Q),Q=!1;const n=de(this)[t].apply(this,e);return Z(),n}})),e}();function se(e=!1,t=!1){return function(n,o,r){if("__v_isReactive"===o)return!e;if("__v_isReadonly"===o)return e;if("__v_raw"===o&&r===(e?t?fe:ue:t?le:ie).get(n))return n;const s=y(n);if(!e&&s&&m(re,o))return Reflect.get(re,o,r);const a=Reflect.get(n,o,r);return(x(o)?te.has(o):ee(o))||(e||V(n,0,o),t)?a:ge(a)?s&&N(o)?a:a.value:k(a)?e?function(e){return he(e,!0,ce,null,ue)}(a):pe(a):a}}var ae={get:ne,set:function(e=!1){return function(t,n,o,r){let s=t[n];if(!e&&!function(e){return!(!e||!e.__v_isReadonly)}(o)&&(o=de(o),s=de(s),!y(t)&&ge(s)&&!ge(o)))return s.value=o,!0;const a=y(t)&&N(n)?Number(n)<t.length:m(t,n),c=Reflect.set(t,n,o,r);return t===de(r)&&(a?((e,t)=>!Object.is(e,t))(o,s)&&J(t,"set",n,o):J(t,"add",n,o)),c}}(),deleteProperty:function(e,t){const n=m(e,t);e[t];const o=Reflect.deleteProperty(e,t);return o&&n&&J(e,"delete",t,void 0),o},has:function(e,t){const n=Reflect.has(e,t);return(!x(t)||!te.has(t))&&V(e,0,t),n},ownKeys:function(e){return V(e,0,y(e)?"length":U),Reflect.ownKeys(e)}},ce={get:oe,set:(e,t)=>!0,deleteProperty:(e,t)=>!0},ie=new WeakMap,le=new WeakMap,ue=new WeakMap,fe=new WeakMap;function pe(e){return e&&e.__v_isReadonly?e:he(e,!1,ae,null,ie)}function he(e,t,n,o,r){if(!k(e)||e.__v_raw&&(!t||!e.__v_isReactive))return e;const s=r.get(e);if(s)return s;const a=function(e){return e.__v_skip||!Object.isExtensible(e)?0:function(e){switch(e){case"Object":case"Array":return 1;case"Map":case"Set":case"WeakMap":case"WeakSet":return 2;default:return 0}}(S(e))}(e);if(0===a)return e;const c=new Proxy(e,2===a?o:n);return r.set(e,c),c}function de(e){const t=e&&e.__v_raw;return t?de(t):e}function ge(e){return Boolean(e&&!0===e.__v_isRef)}Promise.resolve();var me=!1,ye=[],be=Promise.resolve(),ve=e=>be.then(e),we=e=>{ye.includes(e)||ye.push(e),me||(me=!0,ve(xe))},xe=()=>{for(const e of ye)e();ye.length=0,me=!1},ke=/^(spellcheck|draggable|form|list|type)$/,Ae=({el:e,get:t,effect:n,arg:o,modifiers:r})=>{let s;"class"===o&&(e._class=e.className),n((()=>{let n=t();if(o)(null==r?void 0:r.camel)&&(o=P(o)),Ee(e,o,n,s);else{for(const t in n)Ee(e,t,n[t],s&&s[t]);for(const t in s)(!n||!(t in n))&&Ee(e,t,null)}s=n}))},Ee=(e,t,n,o)=>{if("class"===t)e.setAttribute("class",u(e._class?[e._class,n]:n)||"");else if("style"===t){n=a(n);const{style:t}=e;if(n)if(w(n))n!==o&&(t.cssText=n);else{for(const e in n)Ne(t,e,n[e]);if(o&&!w(o))for(const e in o)null==n[e]&&Ne(t,e,"")}else e.removeAttribute("style")}else e instanceof SVGElement||!(t in e)||ke.test(t)?"true-value"===t?e._trueValue=n:"false-value"===t?e._falseValue=n:null!=n?e.setAttribute(t,n):e.removeAttribute(t):(e[t]=n,"value"===t&&(e._value=n))},Se=/\s*!important$/,Ne=(e,t,n)=>{y(n)?n.forEach((n=>Ne(e,t,n))):t.startsWith("--")?e.setProperty(t,n):Se.test(n)?e.setProperty(I(t),n.replace(Se,""),"important"):e[t]=n},Re=(e,t)=>{const n=e.getAttribute(t);return null!=n&&e.removeAttribute(t),n},Ce=(e,t,n,o)=>{e.addEventListener(t,n,o)},Pe=/^[A-Za-z_$][\w$]*(?:\.[A-Za-z_$][\w$]*|\['[^']*?']|\["[^"]*?"]|\[\d+]|\[[A-Za-z_$][\w$]*])*$/,Oe=["ctrl","shift","alt","meta"],Ie={stop:e=>e.stopPropagation(),prevent:e=>e.preventDefault(),self:e=>e.target!==e.currentTarget,ctrl:e=>!e.ctrlKey,shift:e=>!e.shiftKey,alt:e=>!e.altKey,meta:e=>!e.metaKey,left:e=>"button"in e&&0!==e.button,middle:e=>"button"in e&&1!==e.button,right:e=>"button"in e&&2!==e.button,exact:(e,t)=>Oe.some((n=>e["".concat(n,"Key")]&&!t[n]))},_e=({el:e,get:t,exp:n,arg:o,modifiers:r})=>{if(!o)return;let s=Pe.test(n)?t("(e => ".concat(n,"(e))")):t("($event => { ".concat(n," })"));if("vue:mounted"!==o){if("vue:unmounted"===o)return()=>s();if(r){"click"===o&&(r.right&&(o="contextmenu"),r.middle&&(o="mouseup"));const e=s;s=t=>{if(!("key"in t)||I(t.key)in r){for(const e in r){const n=Ie[e];if(n&&n(t,r))return}return e(t)}}}Ce(e,o,s,r)}else ve(s)},Be=({el:e,get:t,effect:n})=>{n((()=>{e.textContent=Te(t())}))},Te=e=>null==e?"":k(e)?JSON.stringify(e,null,2):String(e),Le=e=>"_value"in e?e._value:e.value,Me=(e,t)=>{const n=t?"_trueValue":"_falseValue";return n in e?e[n]:t},$e=e=>{e.target.composing=!0},je=e=>{const t=e.target;t.composing&&(t.composing=!1,De(t,"input"))},De=(e,t)=>{const n=document.createEvent("HTMLEvents");n.initEvent(t,!0,!0),e.dispatchEvent(n)},We=Object.create(null),ze=(e,t,n)=>Fe(e,"return(".concat(t,")"),n),Fe=(e,t,n)=>{const o=We[t]||(We[t]=Ue(t));try{return o(e,n)}catch(e){console.error(e)}},Ue=e=>{try{return new Function("$data","$el","with($data){".concat(e,"}"))}catch(t){return console.error("".concat(t.message," in expression: ").concat(e)),()=>{}}},He={bind:Ae,on:_e,show:({el:e,get:t,effect:n})=>{const o=e.style.display;n((()=>{e.style.display=t()?o:"none"}))},text:Be,html:({el:e,get:t,effect:n})=>{n((()=>{e.innerHTML=t()}))},model:({el:e,exp:t,get:n,effect:o,modifiers:r})=>{const s=e.type,a=n("(val) => { ".concat(t," = val }")),{trim:c,number:i="number"===s}=r||{};if("SELECT"===e.tagName){const t=e;Ce(e,"change",(()=>{const e=Array.prototype.filter.call(t.options,(e=>e.selected)).map((e=>i?_(Le(e)):Le(e)));a(t.multiple?e:e[0])})),o((()=>{const e=n(),o=t.multiple;for(let n=0,r=t.options.length;n<r;n++){const r=t.options[n],s=Le(r);if(o)y(e)?r.selected=p(e,s)>-1:r.selected=e.has(s);else if(f(Le(r),e))return void(t.selectedIndex!==n&&(t.selectedIndex=n))}!o&&-1!==t.selectedIndex&&(t.selectedIndex=-1)}))}else if("checkbox"===s){let t;Ce(e,"change",(()=>{const t=n(),o=e.checked;if(y(t)){const n=Le(e),r=p(t,n),s=-1!==r;if(o&&!s)a(t.concat(n));else if(!o&&s){const e=[...t];e.splice(r,1),a(e)}}else a(Me(e,o))})),o((()=>{const o=n();y(o)?e.checked=p(o,Le(e))>-1:o!==t&&(e.checked=f(o,Me(e,!0))),t=o}))}else if("radio"===s){let t;Ce(e,"change",(()=>{a(Le(e))})),o((()=>{const o=n();o!==t&&(e.checked=f(o,Le(e)))}))}else{const t=e=>c?e.trim():i?_(e):e;Ce(e,"compositionstart",$e),Ce(e,"compositionend",je),Ce(e,(null==r?void 0:r.lazy)?"change":"input",(()=>{e.composing||a(t(e.value))})),c&&Ce(e,"change",(()=>{e.value=e.value.trim()})),o((()=>{if(e.composing)return;const o=e.value,r=n();document.activeElement===e&&t(o)===r||o!==r&&(e.value=r)}))}},effect:({el:e,ctx:t,exp:n,effect:o})=>{ve((()=>o((()=>Fe(t.scope,n,e)))))}},Ke=/([\s\S]*?)\s+(?:in|of)\s+([\s\S]*)/,qe=/,([^,\}\]]*)(?:,([^,\}\]]*))?$/,Ge=/^\(|\)$/g,Qe=/^[{[]\s*((?:[\w_$]+\s*,?\s*)+)[\]}]$/,Ye=(e,t,n)=>{const o=t.match(Ke);if(!o)return;const r=e.nextSibling,s=e.parentElement,a=new Text("");s.insertBefore(a,e),s.removeChild(e);const c=o[2].trim();let i,l,u,f,p=o[1].trim().replace(Ge,"").trim(),h=!1,d="key",g=e.getAttribute(d)||e.getAttribute(d=":key")||e.getAttribute(d="v-bind:key");g&&(e.removeAttribute(d),"key"===d&&(g=JSON.stringify(g))),(f=p.match(qe))&&(p=p.replace(qe,"").trim(),l=f[1].trim(),f[2]&&(u=f[2].trim())),(f=p.match(Qe))&&(i=f[1].split(",").map((e=>e.trim())),h="["===p[0]);let m,b,v,w=!1;const x=(e,t,o,r)=>{const s={};i?i.forEach(((e,n)=>s[e]=t[h?n:e])):s[p]=t,r?(l&&(s[l]=r),u&&(s[u]=o)):l&&(s[l]=o);const a=at(n,s),c=g?ze(a.scope,g):o;return e.set(c,o),a.key=c,a},A=(t,n)=>{const o=new it(e,t);return o.key=t.key,o.insert(s,n),o};return n.effect((()=>{const e=ze(n.scope,c),t=v;if([b,v]=(e=>{const t=new Map,n=[];if(y(e))for(let o=0;o<e.length;o++)n.push(x(t,e[o],o));else if("number"==typeof e)for(let o=0;o<e;o++)n.push(x(t,o+1,o));else if(k(e)){let o=0;for(const r in e)n.push(x(t,e[r],o++,r))}return[n,t]})(e),w){for(let e=0;e<m.length;e++)v.has(m[e].key)||m[e].remove();const e=[];let n,o,r=b.length;for(;r--;){const c=b[r],i=t.get(c.key);let l;null==i?l=A(c,n?n.el:a):(l=m[i],Object.assign(l.ctx.scope,c.scope),i!==r&&(m[i+1]!==n||o===n)&&(o=l,l.insert(s,n?n.el:a))),e.unshift(n=l)}m=e}else m=b.map((e=>A(e,a))),w=!0})),r},Ze=({el:e,ctx:{scope:{$refs:t}},get:n,effect:o})=>{let r;return o((()=>{const o=n();t[o]=e,r&&o!==r&&delete t[r],r=o})),()=>{r&&delete t[r]}},Ve=/^(?:v-|:|@)/,Je=/\.([\w-]+)/g,Xe=!1,et=(e,t)=>{const n=e.nodeType;if(1===n){const n=e;if(n.hasAttribute("v-pre"))return;let o;if(Re(n,"v-cloak"),o=Re(n,"v-if"))return((e,t,n)=>{const o=e.parentElement,r=new Comment("v-if");o.insertBefore(r,e);const s=[{exp:t,el:e}];let a,c;for(;(a=e.nextElementSibling)&&(c=null,""===Re(a,"v-else")||(c=Re(a,"v-else-if")));)o.removeChild(a),s.push({exp:c,el:a});const i=e.nextSibling;o.removeChild(e);let l,u=-1;const f=()=>{l&&(o.insertBefore(r,l.el),l.remove(),l=void 0)};return n.effect((()=>{for(let e=0;e<s.length;e++){const{exp:t,el:a}=s[e];if(!t||ze(n.scope,t))return void(e!==u&&(f(),l=new it(a,n),l.insert(o,r),o.removeChild(r),u=e))}u=-1,f()})),i})(n,o,t);if(o=Re(n,"v-for"))return Ye(n,o,t);if((o=Re(n,"v-scope"))||""===o){const e=o?ze(t.scope,o):{};t=at(t,e),e.$template&&rt(n,e.$template)}const r=null!=Re(n,"v-once");r&&(Xe=!0),(o=Re(n,"ref"))&&ot(n,Ze,'"'.concat(o,'"'),t),tt(n,t);const s=[];for(const{name:e,value:o}of[...n.attributes])Ve.test(e)&&"v-cloak"!==e&&("v-model"===e?s.unshift([e,o]):"@"===e[0]||/^v-on\b/.test(e)?s.push([e,o]):nt(n,e,o,t));for(const[e,o]of s)nt(n,e,o,t);r&&(Xe=!1)}else if(3===n){const n=e.data;if(n.includes(t.delimiters[0])){let o,r=[],s=0;for(;o=t.delimitersRE.exec(n);){const e=n.slice(s,o.index);e&&r.push(JSON.stringify(e)),r.push("$s(".concat(o[1],")")),s=o.index+o[0].length}s<n.length&&r.push(JSON.stringify(n.slice(s))),ot(e,Be,r.join("+"),t)}}else 11===n&&tt(e,t)},tt=(e,t)=>{let n=e.firstChild;for(;n;)n=et(n,t)||n.nextSibling},nt=(e,t,n,o)=>{let r,s,a;if(":"===(t=t.replace(Je,((e,t)=>((a||(a={}))[t]=!0,""))))[0])r=Ae,s=t.slice(1);else if("@"===t[0])r=_e,s=t.slice(1);else{const e=t.indexOf(":"),n=e>0?t.slice(2,e):t.slice(2);r=He[n]||o.dirs[n],s=e>0?t.slice(e+1):void 0}r&&(r===Ae&&"ref"===s&&(r=Ze),ot(e,r,n,o,s,a),e.removeAttribute(t))},ot=(e,t,n,o,r,s)=>{const a=t({el:e,get:(t=n)=>ze(o.scope,t,e),effect:o.effect,ctx:o,exp:n,arg:r,modifiers:s});a&&o.cleanups.push(a)},rt=(e,t)=>{if("#"!==t[0])e.innerHTML=t;else{const n=document.querySelector(t);e.appendChild(n.content.cloneNode(!0))}},st=e=>{const t={delimiters:["{{","}}"],delimitersRE:/\{\{([^]+?)\}\}/g,...e,scope:e?e.scope:pe({}),dirs:e?e.dirs:{},effects:[],blocks:[],cleanups:[],effect:e=>{if(Xe)return we(e),e;const n=q(e,{scheduler:()=>we(n)});return t.effects.push(n),n}};return t},at=(e,t={})=>{const n=e.scope,o=Object.create(n);Object.defineProperties(o,Object.getOwnPropertyDescriptors(t)),o.$refs=Object.create(n.$refs);const r=pe(new Proxy(o,{set:(e,t,o,s)=>s!==r||e.hasOwnProperty(t)?Reflect.set(e,t,o,s):Reflect.set(n,t,o)}));return ct(r),{...e,scope:r}},ct=e=>{for(const t of Object.keys(e))"function"==typeof e[t]&&(e[t]=e[t].bind(e))},it=class{constructor(e,t,n=!1){s(this,"template"),s(this,"ctx"),s(this,"key"),s(this,"parentCtx"),s(this,"isFragment"),s(this,"start"),s(this,"end"),this.isFragment=e instanceof HTMLTemplateElement,n?this.template=e:this.isFragment?this.template=e.content.cloneNode(!0):this.template=e.cloneNode(!0),n?this.ctx=t:(this.parentCtx=t,t.blocks.push(this),this.ctx=st(t)),et(this.template,this.ctx)}get el(){return this.start||this.template}insert(e,t=null){if(this.isFragment)if(this.start){let n,o=this.start;for(;o&&(n=o.nextSibling,e.insertBefore(o,t),o!==this.end);)o=n}else this.start=new Text(""),this.end=new Text(""),e.insertBefore(this.end,t),e.insertBefore(this.start,this.end),e.insertBefore(this.template,this.end);else e.insertBefore(this.template,t)}remove(){if(this.parentCtx&&((e,t)=>{const n=e.indexOf(t);n>-1&&e.splice(n,1)})(this.parentCtx.blocks,this),this.start){const e=this.start.parentNode;let t,n=this.start;for(;n&&(t=n.nextSibling,e.removeChild(n),n!==this.end);)n=t}else this.template.parentNode.removeChild(this.template);this.teardown()}teardown(){this.ctx.blocks.forEach((e=>{e.teardown()})),this.ctx.effects.forEach(G),this.ctx.cleanups.forEach((e=>e()))}},lt=e=>e.replace(/[-.*+?^${}()|[\]\/\\]/g,"\\$&"),ut=e=>{const t=st();if(e&&(t.scope=pe(e),ct(t.scope),e.$delimiters)){const[n,o]=t.delimiters=e.$delimiters;t.delimitersRE=new RegExp(lt(n)+"([^]+?)"+lt(o),"g")}let n;return t.scope.$s=Te,t.scope.$nextTick=ve,t.scope.$refs=Object.create(null),{directive(e,n){return n?(t.dirs[e]=n,this):t.dirs[e]},mount(e){if("string"==typeof e&&!(e=document.querySelector(e)))return;let o;return o=(e=e||document.documentElement).hasAttribute("v-scope")?[e]:[...e.querySelectorAll("[v-scope]")].filter((e=>!e.matches("[v-scope] [v-scope]"))),o.length||(o=[e]),n=o.map((e=>new it(e,t,!0))),this},unmount(){n.forEach((e=>e.teardown()))}}},ft=document.currentScript;ft&&ft.hasAttribute("init")&&ut().mount();var pt=/^\d+(,\d+)*$/;var ht=20;function dt(e,t){const n=function(e){const t=e.split(",").map((e=>{const t=Number(e);return isNaN(t)?0:Math.abs(Math.floor(t))})),n=t.reduce(((e,t)=>e+t),0);return{array:t,size:n}}(e.border),o=e.coordinates?{x:ht,y:ht}:{x:0,y:0};!0===t&&(o.y=0),!1===t&&(o.x=0);return{w:e.w*e.size+2*n.size+o.x,h:e.h*e.size+2*n.size+o.y,border:n,offset:{x:n.size+o.x,y:n.size},margin:o}}var gt=document.getElementById("CN"),mt=document.getElementById("SN"),yt=document.getElementById("TP"),bt=document.getElementById("CanvasGhost"),vt=document.getElementById("TemplateGhost"),wt=document.getElementById("FEN"),xt=document.getElementById("DB"),kt=document.getElementById("PV"),At=navigator.clipboard,Et="canShare"in navigator,St=Math.min(2,Math.floor(devicePixelRatio));var Nt=matchMedia("(hover: none), (pointer: coarse)").matches,Rt={isTop:top==self,thread:"undefined"!=typeof SharedArrayBuffer,canShare:Et,canSharePng:function(){if(!Et)return!1;const e=atob("iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII"),t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);const n=new Blob([t]),o=new File([n],"1.png",{type:"image/png"});return navigator.canShare({files:[o]})}(),canCopy:At&&"writeText"in At,canPaste:At&&"readText"in At,canCopyImg:At&&"write"in At,isTouch:Nt,isTaiwan:navigator.languages.includes("zh-TW")};function Ct(e,t,n=!1){if(!(t instanceof Object))return e;const o=Object.keys(t);for(const r of o){if(n&&!(r in e))continue;const o=t[r];o instanceof Object?e[r]instanceof Object&&e[r]!=o?e[r]=Ct(e[r],o,n):e[r]=Pt(o):e[r]=o}return e}function Pt(e){return Ct(Array.isArray(e)?[]:{},e)}var Ot,It="function"==typeof structuredClone?structuredClone:Pt,_t="8/8/8/8/8/8/8/8",Bt="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Tt="[🇦-🇿]{2}|\\p{ExtPict}\\uFE0F?\\p{EMod}?(\\u200D\\p{ExtPict}\\uFE0F?\\p{EMod}?)*",Lt="\\((!?)([kqbnrp])(\\d?)\\)",Mt="'(".concat(Tt,"|[^'])|''.."),$t="[-~]?(\\*\\d)?(".concat("[kqbnrpcxstadg]","|").concat(Mt,")"),jt=RegExp("^(?:".concat(Tt,")$"),"u"),Dt=RegExp("^(?:".concat(Lt,"|").concat($t,")$"),"iu"),Wt=RegExp("\\/|\\d+|".concat(Lt,"|").concat($t,"|."),"iug");function zt(e){const t=e.match(Wt)||[],n=[0];let o=0;for(const e of t)"/"==e?n[++o]=0:e.match(/^\d+$/)?n[o]+=Number(e):n[o]++;const r=n.length;if(1==r)return;const s=n[0];for(const e of n)if(e!=s)return;return{w:s,h:r}}function Ft(e,t=8,n=8){const o=e.match(Wt)||[],r=[];let s=!1;for(const e of o){if("/"==e){if(!s){const e=r.length+t-r.length%t;for(;r.length<e;)r.push("")}}else if(e.match(/^\d+$/)){const t=Number(e);for(let e=0;e<t;e++)r.push("")}else r.push(e);if(s="/"!=e&&r.length%t==0,r.length==t*n)break}for(;r.length<t*n;)r.push("");return r}function Ut(e,t=8,n=8){let o=0,r="";function s(){o&&(r+=o),o=0}for(let a=0;a<n;a++){for(let n=0;n<t;n++){const c=a*t+n;""==e[c]?o++:(s(),r+=e[c])}s(),a<n-1&&(r+="/")}return r}function Ht(e,t,n){if(!e.match(Dt))if(e.match(jt))e="'"+e;else{const t=[...e].length;e=1==t&&"'"!=e?"'"+e:2==t?"''"+e:""}return(e=(e=e.replace(RegExp("^".concat(Lt,"$"),"i"),((e,t,n,o)=>{let r=n;return o&&(r="*"+o+r),t&&(r="-"+r),r}))).replace(/^~/,"-").replace(/^-(?=.*')/,"")).startsWith("-")&&(e=e.toLowerCase()),e=qt(e,t,n)}function Kt(e){const t=(e=qt(e,!1,!0)).match(/^(-?)(?:\*(\d))?([kqbnrp])$/i);return t?t[1]||t[2]?"("+(t[1]?"!":"")+t[3]+(t[2]||"")+")":t[3]:""}function qt(e,t,n){return e.match(/^-?(\*\d)?[sng]$/i)?(t?(n&&(e=e.replace("s","g").replace("S","G")),e=e.replace("n","s").replace("N","S")):(n&&(e=e.replace("s","n").replace("S","N")),e=e.replace("g","s").replace("G","S")),e):e}function Gt(e,t,n=8){return void 0===t&&(e=(e-(t=e%8))/8),String.fromCharCode(97+t)+(n-e)}function Qt(e,t=8){return{x:e.charCodeAt(0)-97,y:t-Number(e[1])}}function Yt(e,t=8,n=8){const{x:o,y:r}=Qt(e,n);return r*t+o}function Zt(e){return Array.from({length:e},(e=>""))}function Vt(e,t,n,o=8,r=8){const s=Zt(o*r);s.anime="";for(let a=0;a<r;a++)for(let c=0;c<o;c++){const i=c+t,l=a+n,u=0<=i&&i<o&&0<=l&&l<r;e[a*o+c]&&(s[l*o+i]=u?e[a*o+c]:"",s.anime+=Gt(a,c,r)+Gt(l,i,r))}return s}function Jt(e,t,n=8,o=8){const r=Zt(n*o);r.anime="";for(let s=0;s<o;s++)for(let a=0;a<n;a++){let c=a,i=s;if("-"==t&&(c=n-1-c),"|"!=t&&"/"!=t||(i=o-1-i),"/"==t||"\\"==t){const e=i-c;c+=e,i-=e}"/"==t&&(i=o-1-i),e[i*n+c]&&(r[s*n+a]=e[i*n+c],r.anime+=Gt(i,c,o)+Gt(s,a,o))}return r}function Xt(e,t,n=8,o=8){const r=Zt(n*o);n==o&&(r.anime="");for(let s=0;s<n;s++)for(let a=0;a<o;a++){const c=1==t?s:2==t?o-1-a:n-1-s,i=1==t?o-1-a:2==t?n-1-s:a;e[i*n+c]&&(r[s*o+a]=e[i*n+c],n==o&&(r.anime+=Gt(i,c,o)+Gt(s,a,o)))}return r}function en(e,t){return e.map((e=>{if(""==e||e.startsWith("-"))return e;if(!t&&e.startsWith("'"))return e;const n=e.toLowerCase();return e=e==n?e.toUpperCase():n}))}function tn(e,t="",n=""){return new RegExp(t+nn(e)+n,"i")}function nn(e){let t=4;return e.match(/^\d/)&&(t=Number(e[0]),e=e.substring(1)),e.length<=t?"\\b"+e+"\\b":"\\b"+e.substring(0,t)+on(e.substring(t))}function on(e){return""==e?"":String.raw(Ot||(Ot=o(["(?:","","|\b)"],["(?:","","|\\b)"])),e[0],on(e.substring(1)))}var rn,sn,an,cn,ln="[a-h][1-8]",un="(?:[0-9A-Z][0-9A-Z]|[A-Z])",fn=String.raw(rn||(rn=o(["[[^]]+]"],["\\[[^\\]]+\\]"]))),pn=String.raw(sn||(sn=o(["(+)?[a-z]) (S[ S]+S)"],["(\\+)?[a-z]\\) (\\S[ \\S]+\\S)"]))),hn="(?:[nwb])?r?".concat(un,"?(?<from>").concat(ln,")[-*](?<to>").concat(ln,")(?:[-*](?<then>").concat(ln,"))?"),dn="=(?<pc>[nwb])?(?<p>".concat(un,")"),gn=["condition","2option","3stipulation","2sstipulation","3forsyth","2pieces","2twin"].map(nn).join("|"),mn=new RegExp(gn,"ig"),yn=String.raw(an||(an=o(["(?:(?<move>0-0(?:-0)?|",")(?:",")*(?:",")?(?:=(?<cc>[nwb]))?(?<ep> ep.)?)(?:",")*"],["(?:(?<move>0-0(?:-0)?|",")(?:",")*(?:",")?(?:=(?<cc>[nwb]))?(?<ep> ep\\.)?)(?:",")*"])),hn,fn,dn,fn),bn=yn.replace(/\?<[^>]+>/g,""),vn=String.raw(cn||(cn=o(["(?<count>d+.(?:..)?)?(?<main>","(?:/",")*)(?: [+#=])?"],["(?<count>\\d+\\.(?:\\.\\.)?)?(?<main>","(?:\\/",")*)(?: [+#=])?"])),bn,bn);function wn(e,t,n,o){n=Sn(n),"w"==o&&(n=n.toUpperCase()),"b"==o&&(n=n.toLowerCase()),"n"==o&&(n="-"+n.toLowerCase()),e[Yt(t)]=n}function xn(e,t,n,o){return o&&o.push(t+n),t=Yt(t),e[n=Yt(n)]=e[t],e[t]="",e[n]}var kn={"*2Q":"G","*2N":"N","*1N":"Z","*3N":"CA","*3B":"GI","*3Q":"LI","*1Q":"EQ","*2P":"BP","*1B":"AN","*1K":"PO","*2K":"ST","*3K":"DU","*2R":"WE","*3R":"PA",C:"I"},An={"*1B":"25,37,AL,AN,BM,C,CT,DB,GN,GY,NH","*1K":"PO","*1N":"36,AO,BK,BN,DR,GR,KP,LS,MA,MS,OH,RK,S1,S2,S3,S4,SQ,SS,SW,UU,Z,ZE,ZH,ZR","*1P":"BS,CP,MP","*1Q":"EQ,HA,KH,L,LE,NE","*1R":"DA,DK,EK,GT,MH,RM,RO,RR,SH,WA","*2B":"15,AR,BH,BT,BU,BW,ND,PR","*2K":"ST","*2N":"N","*2P":"BP","*2Q":"G","*2R":"DG,EM,RA,RF,RH,RW,WE","*3B":"BE,BL,FE,GI,LO,OK,RB,VA","*3K":"DU","*3N":"24,35,AH,CA,DS,GH,MO,OA,SA","*3P":"O,SP","*3Q":"16,AM,EH,KA,LI,M,OR,SE,SI","*3R":"BR,CH,CR,EA,FA,PA,RE,RL,TR",A:"AG,B1,B2,B3,BI,BO,CG,CY,DO,ET,F,FR,G2,G3,GE,GF,GL,KL,KO,LB,LH,LN,LR,MG,ML,MM,NA,NL,NO,PP,QE,QF,QN,QQ,RN,RP,RT,SK,SO,TH,WR",C:"I",N:"S"},En={custom:()=>({}),default:{}};for(const e in An)for(const t of An[e].split(","))En.default[t]=e;function Sn(e){const t=e.toUpperCase(),n=function(e,t){for(const n in e)if(e[n]==t)return n}(En.custom(),t)||En.default[t];return n?e==t?n:n.toLowerCase():e}var Nn=new URL(location.href).searchParams,Rn=JSON.parse(localStorage.getItem("settings"))||{},Cn={BBS:{Id:!0,coordinates:!0,notes:!0,uncoloredNotes:!1,redBlue:!1},DB:{use:"PDB",exact:!1},PLAY:{symbol:null,ep:!0,negative:!1,zero:!1},Stockfish:{study:!1,downloaded:!1,depth:50,lines:3},feature:{janko:!1},popeye:{pieceMap:kn},board:{pattern:void 0,bg:void 0,exHigh:!0,border:"1",blackWhite:!1,knightOffset:.6,SN:!1,size:44,w:8,h:8,fullFEN:!1,coordinates:!1,set:"1echecs",collapse:!0},message:{touchTip:!0,textShortcut:!0}};Ct(Cn,Rn,!0),Rn.popeye&&(Cn.popeye.pieceMap=Rn.popeye.pieceMap),Nn.has("janko")&&(Cn.feature.janko=!0);var Pn=pe(Cn);En.custom=()=>Pn.popeye.pieceMap;var On=matchMedia("(prefers-color-scheme: dark)");On.onchange=()=>In.isDark=On.matches;var In=pe({loading:!0,isDark:On.matches,pieceCount:"(0+0)",hor:!1,collapse:!1,dragging:!1,selection:null,stockfish:{status:Pn.Stockfish.downloaded?3:0,running:0}}),_n=Rt.isTop?sessionStorage.getItem("state"):null,Bn={depth:0,score:null,mate:null,lines:[],header:[]},Tn={split:!1,tab:0,play:{initFEN:null,playing:!1,pendingPromotion:!1,moveNumber:-1,game:"",history:[],turn:"w",castle:{K:!0,Q:!0,k:!0,q:!0},retro:{uncapture:null,unpromote:!1},enPassant:"",halfMove:0,fullMove:1,mode:"normal"},popeye:{initFEN:null,index:null,steps:null,playing:!1,error:!1,running:!1,editMap:!1,mapping:"",input:"",output:"",intInput:null,intOutput:null},stockfish:Bn},Ln=pe(_n?JSON.parse(_n):Tn);function Mn(e,t,n){const{size:o,w:r}=Pn.board,{border:s,margin:a}=dt(Pn.board,t),c=s.size,i=e?t?8:3:r,l=(e||gt).clientWidth/(o*i+2*c+a.x);return{s:o*l,offset:{x:(c+a.x)*l,y:c*l,r:c*l,b:(c+a.y)*l},width:((n||r)*o+2*s.size+a.x)*l}}function $n(){return Ln.play.playing||Ln.popeye.playing}var jn=0;function Dn(e,t,n,o){return{$template:"#checkbox",id:"chk"+jn++,label:t,checked:e,disabled:()=>null==o?void 0:o(),change:e=>{n&&n(e.target.checked)}}}function Wn(e,t,n,o){const r=e.split(".");let s=e.startsWith("state.")?Ln:Pn;for(s==Ln&&r.shift(),e=r.pop();r.length;)s=s[r.shift()];return Dn((()=>s[e]),t,(t=>{s[e]=t,n&&n()}),o)}var zn=document.createElement("canvas"),Fn=zn.getContext("2d"),Un=new Map;function Hn(e,t){const n=e.set+e.size*t;return Un.get(n)}async function Kn(e,t,n){const o=t.set+t.size*n;if(Un.has(o))return Un.get(o);const r=await async function(e,t,n){const{set:o,size:r}=t;e+="/x"+n;const[s,a]=await Promise.all([qn("".concat(e,"/").concat(o).concat(r,".png")),qn("".concat(e,"/symbol").concat(r,".png"))]);return zn.width=r*n*3,zn.height=r*n*12,Fn.drawImage(s,0,0),Fn.drawImage(a,0,r*n*6),zn.toDataURL()}(e,t,n),s=await qn(r);return Un.set(o,s),s}function qn(e){return new Promise(((t,n)=>{const o=new Image;o.onload=()=>t(o),o.onerror=n,o.src=e}))}var Gn=["k","q","b","n","r","p","c","x","s","t","a","d"],Qn=document.createElement("canvas"),Yn=Qn.getContext("2d"),Zn=document.createElement("canvas"),Vn=Zn.getContext("2d"),Jn={26:"YdVh1QDVYdVh",32:"AAAKAAAAo/+jAAr/AP8KAKP/owAAAAoAAA==",38:"AAw+DAAM3P/cDD7/AP8+DNz/3AwADD4MAA==",44:"AC9yLwAv+f/5L3L/AP9yL/n/+S8AL3IvAA==",52:"A3i2eAN4////eLb/AP+2eP///3gDeLZ4Aw==",64:"AAAEHgQAAAA/5v/mPwAE5v///+YEHv//AP//HgTm////5gQAP+b/5j8AAAAEHgQAAA==",76:"AARZhFkEAAS7////uwRZ//////9ZhP//AP//hFn//////1kEu////7sEAARZhFkEAA==",88:"AEfE68RHAEf8/////EfE///////E6///AP//68T//////8RH/P////xHAEfE68RHAA=="};function Xn(e,t,n,o,r,s){const{w:a,h:c,border:i,offset:l,margin:u}=dt(n,s),f=Hn(n,o);e.canvas.width=a*o,e.canvas.height=c*o,e.save(),e.scale(o,o);const p="classic"==n.bg,h=r||p;e.translate(l.x,l.y);for(let r=0;r<n.h;r++)for(let s=0;s<n.w;s++)h||to(e,r,s,n),eo(e,f,r,s,t[r*n.w+s],n,o);if(e.restore(),p&&!r){!function(e,t,n){const o=e.canvas;Zn.width=Qn.width=o.width,Zn.height=Qn.height=o.height,Yn.drawImage(o,0,0),e.save(),e.fillStyle="white",e.fillRect(0,0,o.width,o.height),e.globalCompositeOperation="destination-in",e.drawImage(Qn,0,0),e.restore(),e.save();const r=function(e){if("string"==typeof Jn[e]){const t=atob(Jn[e]),n=[];for(let e=0;e<t.length;e++)n.push(t.charCodeAt(e));Jn[e]=n}return Jn[e]}(t*n),s=Math.sqrt(r.length),a=(s-1)/2;for(let t=0;t<s;t++)for(let n=0;n<s;n++){const c=r[n*s+t];0!=c&&(e.globalAlpha=c/255,Vn.drawImage(o,t-a,n-a))}e.restore()}(e,n.size,o),e.save(),e.scale(o,o),e.translate(l.x,l.y);for(let t=0;t<n.h;t++)for(let o=0;o<n.w;o++)to(e,t,o,n);e.restore(),e.drawImage(Zn,0,0),e.drawImage(Zn,0,0),e.drawImage(Zn,0,0),e.drawImage(Qn,0,0)}e.scale(o,o),void 0===s&&n.coordinates&&(e.save(),e.translate(l.x,l.y),function(e,t,n){const{size:o,w:r,h:s}=t;e.font="15px sans-serif",e.strokeStyle="black",e.lineWidth=2,e.fillStyle="white",e.lineJoin="round";for(let t=0;t<s;t++){const r=(t+1).toString(),a=e.measureText(r),c=o*(s-t)-(o-10)/2,i=(ht-a.width)/2-ht-n;e.strokeText(r,i,c),e.fillText(r,i,c)}for(let t=0;t<r&&t<26;t++){const r=String.fromCharCode(97+t),a=e.measureText(r),c=o*s+ht+n-5,i=o*t+(o-a.width)/2;e.strokeText(r,i,c),e.fillText(r,i,c)}}(e,n,i.size),e.restore()),r||function(e,t,n,o,r){e.save(),e.translate(r.x,0),n-=r.x,o-=r.y;let s=0;for(let r=0;r<t.array.length;r++){const a=t.array[r];if(e.strokeStyle=r%2?"white":"black",0==a)continue;e.lineWidth=a;const c=t.size-s-a/2;e.strokeRect(c,c,n-2*c,o-2*c),s+=a}e.restore()}(e,i,a,c,u)}function eo(e,t,n,o,r,s,a){void 0===r&&(r="");const{size:c}=s,i=r&&r.startsWith("-");i&&(r=r.substring(1));const l=r.match(/^\*(\d)/);let u=l&&l[1]||void 0;void 0!==u&&(r=r.substring(2)),u=Number(u)%4,s.SN&&(r=qt(r,!1,!0));const f=r.toLowerCase(),p=Gn.indexOf(f),h=r.startsWith("'");if(p<0&&!h)return;e.save();const d=s.blackWhite,g=i?d?0:2:r==f?0:1,m=i&&d?"n"==f?s.knightOffset:.5:1,[y,b]=[u+1&2?1:0,2&u?1:0];if(e.translate((o+y)*c,(n+b)*c),0!==u&&e.rotate(Math.PI/2*u),h){!function(e,t,n){e.save();const o=jt.test(t),r=n-4;e.font="".concat(r,"px sans-serif");const s=n-2;let a=e.measureText(t);if(o&&a.width>s){const n=s/a.width;e.font="".concat(r*n,"px sans-serif"),a=e.measureText(t)}const c=function(e){return e.actualBoundingBoxAscent-e.actualBoundingBoxDescent}(o?e.measureText("M"):a),i=(n-Math.min(a.width,s))/2,l=Math.max((n-c)/2,0);e.fillStyle="black",e.fillText(t,i,n-l,s),e.restore()}(e,r.substring(r.startsWith("''")?2:1),c)}else e.drawImage(t,g*c*a,p*c*a,c*m*a,c*a,0,0,c*m,c),i&&d&&e.drawImage(t,(1+m)*c*a,p*c*a,c*(1-m)*a,c*a,c*m,0,c*(1-m),c);e.restore()}function to(e,t,n,o){const r=function(e,t,n){if("mono"==e)return 1;let o=(t+n)%2;return"inverted"!=e&&(o=1-o),o}(o.pattern,t,n),s=o.size;if(e.save(),e.translate(n*s,t*s),"classic"==o.bg){if(e.strokeStyle="black",e.lineWidth=s/60,e.fillStyle="#fff",e.fillRect(0,0,s,s),!r){e.beginPath();const t=s/7.5;for(let n=0;n<s;n+=t)e.moveTo(s-n,0),e.lineTo(0,s-n),n>0&&(e.moveTo(n,s),e.lineTo(s,n));e.stroke()}}else e.fillStyle=function(e,t){return"classic"==t?"none":"gray"==t?e?"#fff":"#bbb":"green"==t?e?"#EEEED2":"#769656":e?"#FFCE9E":"#D18B47"}(r,o.bg),e.fillRect(0,0,s,s);e.restore()}var no,oo={};function ro(e,t,n,o){return so(),(no=new ao(e,t,n,o)).promise}function so(e){no&&no.stop(e?oo.callback:void 0)}var ao=class{constructor(e,t,n,o){var r;this.after=o?e:t,this.reverse=o,this.promise=new Promise((e=>this.resolve=e)),this.cursor=-1,this.stages=[];const s=n.split(","),a=Ft(e),{h:c,w:i}=oo.options;for(const e of s){const t=[],n=e.match(/[`a-z]\d(=(\*\d)?[A-Z])?/g);for(let e=0;e<n.length;e+=2){let o=n[e],s=n[e+1];const l=Yt(o,i,c),u={p:a[l],promo:null==(r=s.match(/=(.+)$/))?void 0:r[1],from:Qt(o,c),to:Qt(s,c)};a[l]="",t.push(u)}this.stages.push({board:a.concat(),moves:t});for(const e of t)a[e.to.y*i+e.to.x]=e.promo||e.p}this.background=void 0,this.anime=this.step.bind(this),this.request=requestAnimationFrame(this.anime)}stop(e){cancelAnimationFrame(this.request),no=void 0,e&&e(this.after),this.resolve()}step(e){const{ctx:t,options:n,callback:o}=oo;this.startTime||(this.startTime=e);const r=(e-this.startTime)/150,s=Math.floor(r);if(s>=this.stages.length)return this.stop(o);const a=this.reverse?this.stages.length-1-s:s;s>this.cursor?(this.cursor=s,Xn(t,this.stages[a].board,n,St),this.background=t.getImageData(0,0,t.canvas.width,t.canvas.height)):t.putImageData(this.background,0,0);const c=dt(n);t.save(),t.translate(c.offset.x,c.offset.y);const i=Hn(n,St);let l=r-Math.floor(r);this.reverse&&(l=1-l);for(const e of this.stages[a].moves){const o=e.from.x*(1-l)+e.to.x*l;eo(t,i,e.from.y*(1-l)+e.to.y*l,o,e.p,n,St)}t.restore(),this.request=requestAnimationFrame(this.anime)}},co=new Array(64),io=document.getElementById("Squares"),lo={};function uo(e){var t;null==(t=lo.draw)||t.call(lo,e)}function fo(){if(this.style.zIndex="10",In.collapse){const e=xo();e[co.indexOf(this)]="",uo(e)}this.select()}function po(){this.style.zIndex="unset",mo(this)?Ao():In.collapse&&uo(xo())}function ho(){mo(this),In.collapse&&this.blur(),Ao()}function go(){if(!In.collapse){const e=xo();e[co.indexOf(this)]=Ht(this.value,Pn.board.SN),uo(e)}}function mo(e,t){let n=Ht(e.value,Pn.board.SN,t);const o=n!==e.value;return e.value=n,o}function yo(e,t){const n=e.value!==t;e.value=t,mo(e),n&&Ao()}function bo(e,t){const n=vo(e);wt.value=n[0]+(Pn.board.fullFEN?No():""),Ro(t)}function vo(e){const t=e.split(" ");if(t[1]&&t[1].match(/^[wb]$/)&&(Ln.play.turn=t[1]),t[2]&&t[2].match(/^(-|[kq]+)$/i))for(const e in Ln.play.castle)Ln.play.castle[e]=t[2].includes(e);return t[3]&&t[3].match(/^[a-h][36]$/)&&(Ln.play.enPassant=t[3]),t[4]&&t[4].match(/^\d+$/)&&(Ln.play.halfMove=Number(t[4])),t[5]&&t[5].match(/^\d+$/)&&(Ln.play.fullMove=Number(t[5])),t}function wo(){const e=new URL(location.href).searchParams.get("fen")||_t,t=wt.value.split(" ")[0],n=t==_t?"":"?fen="+encodeURIComponent(t);t!==e&&history.pushState(null,"",n||".")}function xo(){return co.map((e=>e.value))}function ko(){return xo().map((e=>qt(e,!1,!0)))}function Ao(){uo(Eo())}function Eo(){const{w:e,h:t,fullFEN:n}=Pn.board,o=xo();return wt.value=Ut(o,e,t)+(n?No():""),o}function So(){const e=function(){const{w:e,h:t}=Pn.board;if(8!=e||8!=t)return null;const n=ko();for(const e of n)if(""!=e&&!e.match(/^[kqbsnrp]$/i))return null;return Ut(n,8,8)}();return e?e+No(!0):null}function No(e){const t=Ln.play;t.enPassant.match(/^[a-h][36]$/)||(t.enPassant=""),e&&t.pass&&t.enPassant&&"3"==t.enPassant[1]!=("b"==t.turn)&&(t.turn="b"==t.turn?"w":"b");const n="retro"==t.mode;e&&((n||!Number.isSafeInteger(t.halfMove)||t.halfMove<0)&&(t.halfMove=0),(n||!Number.isSafeInteger(t.fullMove)||t.fullMove<1)&&(t.fullMove=1));const o=n?"-":function(e){const t=xo();let n="";const o=Ln.play.castle;e?("K"==t[60]&&(o.K&&"R"==t[63]&&(n+="K"),o.Q&&"R"==t[56]&&(n+="Q")),"k"==t[4]&&(o.k&&"r"==t[7]&&(n+="k"),o.q&&"r"==t[0]&&(n+="q"))):(o.K&&(n+="K"),o.Q&&(n+="Q"),o.k&&(n+="k"),o.q&&(n+="q"));return""==n?"-":n}(e),r=n?"-":t.enPassant||"-";return" ".concat(t.turn," ").concat(o," ").concat(r," ").concat(t.halfMove," ").concat(t.fullMove)}function Ro(e){Co(wt.value);const t=zt(wt.value),{w:n,h:o}=t||Pn.board,r=Ft(wt.value,n,o);Mo({w:n,h:o});let s=!1;for(let e=0;e<n*o;e++)co[e].value=r[e],s=mo(co[e])||s;s||e||!t?Ao():uo(xo())}function Co(e){const t=Ln.play,n=e.split(" ");if(1!=n.length){if("w"!=n[1]&&"b"!=n[1]||(t.turn=n[1]),n[2]){const e=["K","Q","k","q"];for(const o of e)t.castle[o]=n[2].includes(o)}t.enPassant=n[3]&&"-"!=n[3]?n[3]:"","retro"!=t.mode&&(t.halfMove=Number(n[4]||0),t.fullMove=Number(n[5]||1))}}function Po(e){for(const t of co)t.readOnly=e}function Oo(e){if(e.anime){const t=Ut(e,Pn.board.w,Pn.board.h);ro(wt.value,t,e.anime)}else e.forEach(((e,t)=>co[t].value=e)),Ao()}function Io(){Object.assign(Ln.play,{turn:"w",enPassant:"",halfMove:0,fullMove:1});const e=["K","Q","k","q"];for(const t of e)Ln.play.castle[t]=!0}oo.options=Pn.board,oo.callback=bo,addEventListener("popstate",(async function(){if(Ln.play.playing)return;const e=new URL(location.href).searchParams.get("fen");e&&bo(e,!0)})),window.FEN={update:()=>{vo(wt.value),Ro(!0)},empty(){for(const e of co)e.value="";Ao()},reset(){Mo({w:8,h:8}),Pn.board.fullFEN&&Io(),bo(Bt)},copy(){gtag("event","fen_copy"),navigator.clipboard.writeText(wt.value)},async paste(){gtag("event","fen_paste"),bo(await ar(),!0)},rotate(e){so(!0);const{w:t,h:n}=Pn.board;t!==n&&Mo({w:n,h:t}),Oo(Xt(xo(),e,t,n))},color(e){for(const t of co){let n=t.value;n.startsWith("'")||""==n||(n.startsWith("-")&&(n=n.substr(1)),n=n.toLowerCase(),0==e&&(n="-"+n),1==e&&(n=n.toUpperCase()),t.value=n)}Ao()},invert(e){Oo(en(xo(),e))},shift(e,t){so(!0);const{w:n,h:o}=Pn.board;Oo(Vt(xo(),e,t,n,o))},mirror(e){so(!0);const{w:t,h:n}=Pn.board;Oo(Jt(xo(),e,t,n))}};var _o=document.getElementById("Zone"),Bo=document.getElementById("DragZone"),To=document.getElementById("EditZone");function Lo(){return document.body.clientWidth/(Ln.split?2:1)}async function Mo(e,t){const n=Pn.board,o={};for(const t in n)o[t]=void 0!==e[t]&&e[t]!==n[t],o[t]?n[t]=e[t]:e[t]=n[t];const{border:r,margin:s,w:a,h:c}=dt(e),i=Do(),l=Lo()<(e.w+3)*e.size+s.x+4*r.size+4.2*i;o.mode=l!==In.hor,In.hor=l;const u=o.w||o.h;(u||t)&&function(){const{w:e,h:t}=Pn.board,n=e*t;io.style.gridTemplateColumns="repeat(".concat(e,", 1fr)"),io.style.gridTemplateRows="repeat(".concat(t,", 1fr)");for(let e=0;e<n||e<co.length;e++){if(!co[e]){const t=document.createElement("input");co[e]=t,t.type="text",t.oninput=go,t.onchange=ho,t.onfocus=fo,t.onblur=po,t.classList.add("square"),io.appendChild(t)}co[e].style.display=e<n?"block":"none"}}();const f=t||o.set||o.size,p=f||o.border,h=p||u,d=p||o.mode;if(d){let t=(3*e.size+2*r.size)*St,n=(8*e.size+2*r.size)*St;In.hor?([t,n]=[n+s.x*St,t],gt.parentNode.classList.add("mb-3"),yt.classList.remove("ms-4")):(n+=s.y*St,gt.parentNode.classList.remove("mb-3"),yt.classList.add("ms-4")),yt.width===t&&yt.height===n||(vt.width=yt.width=t,vt.height=yt.height=n)}if(h){const e=a*St,t=c*St;gt.width===e&&gt.height===t||(mt.width=bt.width=gt.width=e,mt.height=bt.height=gt.height=t),rr(mt.getContext("2d"))}jo(),f&&await Uo(),h&&or(),d&&er(),ve(jo)}function $o(e){const{w:t,h:n}=Pn.board,o=xo();Mo(e),function(e,t,n){const{w:o,h:r}=Pn.board;for(let s=0;s<r;s++)for(let r=0;r<o;r++){co[s*o+r].value=s<n&&r<t?e[s*t+r]:""}Ao()}(o,t,n)}function jo(){_o.style.maxWidth="calc(".concat(Lo(),"px + 1rem)"),gt.style.width=gt.width/St+"px",yt.style.width=yt.width/St+"px";const{w:e}=Pn.board,t=Mn(void 0,void 0,8);if(In.hor)if(e>8)yt.style.width=t.width+"px";else if(e<8){const{width:t}=Mn(yt,!0,e);gt.style.width=t+"px"}io.style.borderWidth="".concat(t.offset.y,"px ").concat(t.offset.r,"px ").concat(t.offset.b,"px ").concat(t.offset.x,"px");const n=Do();Pn.board.collapse?(_o.style.width="120%",_o.style.width=Bo.clientWidth+4*n+"px"):_o.style.width="unset",bt.style.width=gt.clientWidth+"px",bt.style.height=gt.clientHeight+"px",vt.style.width=yt.clientWidth+"px",vt.style.height=yt.clientHeight+"px",function(e){io.style.width=CN.clientWidth+"px",io.style.height=CN.clientHeight+"px";for(const t of co)t.style.fontSize=e-10+"px",t.style.lineHeight=e-10+"px"}(t.s),_o.clientWidth<Bo.clientWidth+gt.clientWidth+6*n?(To.style.marginTop=-Bo.clientHeight+"px",To.style.width=Bo.clientWidth+"px",To.style.textAlign=In.hor?"center":"start",_o.classList.add("collapse"),In.collapse=!0):(To.style.marginTop="0",To.style.width="unset",To.style.textAlign="unset",_o.classList.remove("collapse"),In.collapse=!1)}function Do(){return parseFloat(getComputedStyle(document.documentElement).fontSize)}if(Rt.isTop)window.resizeIframe=function(){const e=document.getElementsByTagName("iframe")[0];e&&(e.style.minHeight=e.contentDocument.body.scrollHeight+"px")};else{if("undefined"!=typeof ResizeObserver){new ResizeObserver((e=>parent.resizeIframe())).observe(document.body)}else{new MutationObserver((e=>parent.resizeIframe())).observe(document.body,{childList:!0})}parent.resizeIframe()}window.Layout={setOption:Mo,setDimension:$o,setBorder(e){const t=function(e){return"string"!=typeof e?null:(e=e.replace(/\D/g,",").replace(/,+/g,",").replace(/^,/,"").replace(/,$/,"")).match(pt)?e:null}(e.value);t?(e.value=t,Mo({border:t})):e.value=Pn.board.border},setHeight(e){if("number"==typeof e)$o({h:Pn.board.h+e});else{const t=Math.floor(Number(e.value));isNaN(t)||t<=0?e.value=Pn.board.h:$o({h:t})}},setWidth(e){if("number"==typeof e)$o({w:Pn.board.w+e});else{const t=Math.floor(Number(e.value));isNaN(t)||t<=0?e.value=Pn.board.w:$o({w:t})}}};var Wo="k,K,-k,q,Q,-q,b,B,-b,n,N,-n,r,R,-r,p,P,-p,c,C,-c,x,X,-x".split(","),zo="k,q,b,n,r,p,c,x,K,Q,B,N,R,P,C,X,-k,-q,-b,-n,-r,-p,-c,-x".split(",");function Fo(){return Pn.board.exHigh?2:1}async function Uo(){In.loading=!0;const e=[Kn("assets",Pn.board,St)],t=Fo();St!=t&&e.push(Kn("assets",Pn.board,t)),await Promise.all(e),In.loading=!1}var Ho,Ko,qo,Go=gt.getContext("2d"),Qo=bt.getContext("2d"),Yo=yt.getContext("2d"),Zo=vt.getContext("2d"),Vo=document.createElement("canvas"),Jo=Vo.getContext("2d"),Xo={except:void 0,data:void 0};function er(e){e?Xo.except=e:e=Xo.except;const t=Object.assign({},Pn.board,In.hor?{w:8,h:3}:{w:3,h:8}),n=function(){let e=In.hor?zo:Wo;Ln.play.playing&&"retro"==Ln.play.mode&&(e=e.concat(),In.hor?(e[6]="p",e[14]="P"):(e[18]="p",e[19]="P"));return e}();Xn(Yo,n,t,St,!1,In.hor);const{size:o}=Pn.board;if($n()){const t="retro"==Ln.play.mode;Yo.save();const{offset:n}=dt(Pn.board,In.hor);Yo.translate(n.x,n.y),t&&(Yo.save(),Yo.font="".concat(o/2,"px sans-serif"),Yo.strokeStyle="black",Yo.lineWidth=o/12,Yo.fillStyle="white",Yo.lineJoin="round",tr(1,7),tr(2,7),Yo.restore()),Yo.save(),Yo.globalAlpha=In.isDark?.5:.4,Yo.fillStyle="black";for(let t=0;t<3;t++)for(let n=0;n<8;n++){if(null==e?void 0:e.includes(3*n+t))continue;const[r,s]=In.hor?[n,t]:[t,n];Yo.fillRect(r*o,s*o,o,o)}if(Yo.restore(),t){Yo.save();const t=Ln.play.retro,n=3==e[0]?0:1;Yo.lineWidth=o/12,Yo.strokeStyle="#0d6efd",t.uncapture&&nr(n,Gn.indexOf(t.uncapture)),t.unpromote&&nr(1-n,5),Yo.restore()}Yo.restore()}else if(Xn(Zo,n,t,St,!0,In.hor),In.selection){Yo.save();const{offset:e}=dt(Pn.board,In.hor);Yo.lineWidth=o/12,Yo.strokeStyle="#0d6efd",Yo.translate(e.x,e.y);const t=Wo.indexOf(In.selection),n=t%3,r=(t-n)/3;console.log(n,r),nr(n,r),Yo.restore()}}function tr(e,t){const{size:n}=Pn.board,o=n/15;In.hor&&([e,t]=[t,e]);const r=Yo.measureText("ep"),s=r.width,a=r.actualBoundingBoxDescent;Yo.strokeText("ep",e*n-s-o,t*n-a-o),Yo.fillText("ep",e*n-s-o,t*n-a-o)}function nr(e,t){const{size:n}=Pn.board,o=n/8;In.hor&&([e,t]=[t,e]);const r=.5,s=(...s)=>{Yo.moveTo(e*n+o*(s[0][0]+r),t*n+o*(s[0][1]+r));for(let a=1;a<s.length;a++)Yo.lineTo(e*n+o*(s[a][0]+r),t*n+o*(s[a][1]+r))};Yo.beginPath(),s([0,2],[0,0],[2,0]),s([5,0],[7,0],[7,2]),s([7,5],[7,7],[5,7]),s([0,5],[0,7],[2,7]),Yo.stroke()}async function or(e){e?Xo.data=e:e=Xo.data||xo();const t=Pn.board;if(Xn(Go,e,t,St),Xn(Jo,e,t,Fo()),function(e){let t=0,n=0,o=0,r=0;for(const s of e)""!=s&&(s.startsWith("'")?r++:s.startsWith("-")?o++:s==s.toUpperCase()?t++:n++);In.pieceCount="(".concat(t,"+").concat(n).concat(o>0?"+"+o:"").concat(r>0?"+"+r:"",")")}(e),In.dragging||(Xn(Qo,e,t,St,!0),wo()),location.protocol.startsWith("http")){const e=document.getElementById("Save");e.href&&URL.revokeObjectURL(e.href),kt.src=e.href=URL.createObjectURL(await sr())}}function rr(e){const{w:t,h:n}=Pn.board;Xn(e,Zt(t*n),Pn.board,St)}function sr(){return new Promise((e=>Vo.toBlob(e)))}async function ar(){if(Rt.canPaste)return await navigator.clipboard.readText();throw alert('Pasting text is not enabled in your browser.\nIf you\'re using Firefox on desktops or Firefox Nightly on Android, this can be enabled by the following.\n1. Visit "about:config" in your address bar.\n2. Search for "dom.events.asyncClipboard.readText".\n3. Toggle its value to true.\n4. Reload this tool.'),!0}if(oo.ctx=Go,addEventListener("storage",(e=>{if(e.storageArea==localStorage&&"settings"==e.key){const e=JSON.parse(localStorage.getItem("settings"));Ct(Pn,e,!0),Mo({},!0)}})),Ln.play.playing){const e=Ln.play;e.playing=!1,Promise.all([Uo(),wr()]).then((()=>{e.playing=!0,Mr.goto(e.history[e.moveNumber])}))}var cr="normal",ir="pass",lr="retro",ur=[4,7,10,13],fr=[3,6,9,12],pr=fr.concat(15,16,18),hr=ur.concat(15,16,19);function dr(e){const t=Ln.play;let n=t.moveNumber;n+=e,n<-1&&(n=-1),n>t.history.length-1&&(n=t.history.length-1),n!=t.moveNumber&&gr(n)}function gr(e){const t=Ln.play,n=t.moveNumber,o=e>=0||0==n;if(Mr.goto(t.history[e],o),o){const o=e==n-1,r=t.history[o?n:e];let s=r.from+r.to;"k"!=r.flags&&"q"!=r.flags||(s+=","+yr(r)),ro(r.before,r.after,s,o!=(Ln.play.mode==lr))}}function mr(e,t,n){if(e=Gt(e),t=Gt(t),Ln.play.mode==lr){const n=Ko.retract({from:e,to:t,...Ln.play.retro});return n&&(kr(),Ar()),n}{const o=Ko.move({from:e,to:t,promotion:n});return!!o&&("k"!=o.flags&&"q"!=o.flags||function(e){const t=Ft(e.before),n="w"==e.color;return t[Yt(e.from)]="",t[Yt(e.to)]=n?"K":"k",{before:Ut(t),after:e.after,move:yr(e)}}(o))}}function yr(e){const t="w"==e.color,n="k"==e.flags,o=t?1:8;return(n?"h":"a")+o+(n?"f":"d")+o}function br(){bo(Ko.fen())}function vr(e){return Ko.get(Gt(e)).color}async function wr(){return Ho||((Ho=await import("./modules/chess.js")).Chess.options=Pn.PLAY,Ko=new Ho.Chess(Ln.play)),Ho}function xr(){Object.assign(Ln.play,{playing:!0,pendingPromotion:!1}),Po(!0),Ln.play.mode==lr?(kr(),Ar()):er([])}function kr(){Ln.play.retro={uncapture:null,unpromote:!1,ep:!1}}function Ar(){er("b"==Ko.turn()?pr:hr)}function Er(e,t){if(2==e)return;const n=Ln.play.retro;var o;0==e==("b"==Ko.turn())?(0<t&&t<7&&(o=Gn[t],n.uncapture=n.uncapture==o?null:o),5!=t&&6!=t||(n.unpromote=!1)):5==t&&(n.unpromote=!n.unpromote,"p"!=n.uncapture&&"c"!=n.uncapture||(n.uncapture=null)),Ar()}async function Sr(e){await wr(),Ko.loadGame(e)&&(br(),xr())}var Nr,Rr,Cr,Pr,Or,Ir,_r,Br,Tr,Lr,Mr={async start(){gtag("event","fen_play_"+Ln.play.mode);const e=So();if(e)try{await wr(),Ko.init(e),Ln.play.over=Ko.overState(),xr()}catch(e){alert("This board is not playable: "+e.message.replace(/^.+:/,"").trim().replace(/[^.]$/,"$&."))}else alert("Only orthodox chess is supported.")},exit(){Ln.play.playing=!1,Ln.play.game="",Co(Ko.fen()),Po(!1),er([])},goto(e,t){const n=Ko.goto(e);t||(so(),bo(n)),Ln.play.mode==lr&&(kr(),Ar())},move(e){e!=Ln.play.moveNumber&&gr(e)},moveBy(e){dr(e)},reset(){Io()},copyGame:()=>Ko.copyGame(),copyPGN:()=>Ko.copyPGN(),number:e=>Ho.number(e,Ln.play.mode),format:e=>Ho.format(e,Ln.play.mode),async pasteMoves(){const e=await ar();Ko.addMoves(Ho.parseMoves(e)),br()},async pasteGame(){const e=await ar();await Sr(e)}},$r=0;function jr(e){Yr(e),"pending"==In.dragging&&function(e){const t=e.offsetX-Nr,n=e.offsetY-Rr;return Math.sqrt(t*t+n*n)}(e)>5&&(Ir=NaN,Br?(Lr=Rt.isTouch?[]:null,Gr(e,!0)):In.dragging=!1),!0===In.dragging&&(Lr&&Lr.push({x:e.clientX,y:e.clientY}),Qr(e))}function Dr(e,t){const{s:n,offset:o}=Mn(),r=t.getBoundingClientRect(),s=Math.floor((e.clientY-r.top-o.y)/n);return{x:Math.floor((e.clientX-r.left-o.x)/n),y:s}}function Wr(){In.selection=null,er([])}function zr(e){if(Ln.popeye.playing)return;if("pending"==In.dragging&&!Ln.play.playing){const t=performance.now();t-$r<300&&Or.focus(),$r=t,e.preventDefault(),In.dragging=!1}if(!In.dragging)return;if(In.dragging=!1,_r.style.display="none",Yr(e),e.target==yt&&!$n()){if(performance.now()-Ir<150){let{x:t,y:n}=Dr(e,yt);if(console.log(t,n),In.hor&&([t,n]=[n,t]),t>-1&&t<3&&n>-1&&n<8){const e=3*n+t;In.selection=Wo[e],er([])}return}}if(!Br)return;const{w:t,h:n}=Pn.board,{x:o,y:r}=Dr(e,gt),s=r*t+o,a=r>-1&&r<n&&o>-1&&o<t;if(Ln.play.playing){let e;if(a){if(function(e,t){const n=Ln.play.mode;return n!=lr&&(n==ir&&vr(e)!=Ko.turn()&&Ko.switchSide(),!!Ko.checkPromotion(Gt(e),Gt(t))&&(qo=t,Ln.play.pendingPromotion=!0,er("b"==Ko.turn()?fr:ur),!0))}(Tr,s))return yo(co[s],Br);Tr!=s&&(e=mr(Tr,s))}"object"==typeof e?ro(e.before,e.after,e.move):br()}else if(a){if(yo(co[s],Br),Lr&&Lr.length>10){const e=function(e){let t=0,n=0;for(const o of e)t+=o.x,n+=o.y;return t/=e.length,n/=e.length,{x:t,y:n}}(Lr),t=function(e,t){let n=0;for(let o=0,r=t.length-1;o<t.length;r=o++){const s=t[o],a=t[r];a.y<=e.y?s.y>e.y&&Fr(a,s,e)>0&&n++:s.y<=e.y&&Fr(a,s,e)<0&&n--}return n}(e,Lr);Kr(Or,t>0?1:3)}}else wo()}function Fr(e,t,n){return(t.x-e.x)*(n.y-e.y)-(n.x-e.x)*(t.y-e.y)}var Ur=performance.now();function Hr(e){if($n())return;const{w:t,h:n}=Pn.board,{offset:o,s:r}=Mn(),s=Math.floor((e.offsetX-o.x)/r),a=Math.floor((e.offsetY-o.y)/r);if(a>-1&&a<n&&s>-1&&s<t){const n=co[a*t+s];if(""==n.value)return;e.preventDefault();const o=performance.now();if(o-Ur<50)return;Ur=o,Kr(n,e.deltaY>0?1:3)}}function Kr(e,t){e.value=e.value.replace(/(^-?)(?:\*(\d))?([^-].*$)/,((e,n,o,r)=>{const s=(Number(o||0)+t)%4;return n+(s?"*"+s:"")+r})),Ao()}function qr(e){if(Ir=performance.now(),Ln.popeye.playing)return;if(In.loading||0!=e.button&&!e.targetTouches||e.targetTouches&&e.targetTouches.length>1)return;Yr(e),document.activeElement&&document.activeElement.blur();const t=this!=yt,{offset:n,s:o}=t?Mn():Mn(yt,In.hor),{w:r}=Pn.board;Nr=e.offsetX,Rr=e.offsetY;const[s,a]=[n.x,n.y];Cr=Math.floor((Nr-s)/o);const c=(Pr=Math.floor((Rr-a)/o))*(t?r:3)+Cr;if(_r=t?bt:vt,t&&In.selection)return co[c].value=In.selection,void Ao();if(Ln.play.playing){if(!t&&Ln.play.pendingPromotion){In.hor&&([Cr,Pr]=[Pr,Cr]);Pr>0&&Pr<5&&Cr==("p"==Br?0:1)&&(i=Tr,l=Gn[Pr],mr(i,qo,l)?(qo>>>3==0&&(l=l.toUpperCase()),yo(co[qo],l)):br(),Ln.play.pendingPromotion=!1,er([]))}if(t||"retro"!=Ln.play.mode||(e.preventDefault(),In.hor&&([Cr,Pr]=[Pr,Cr]),Er(Cr,Pr)),!t||!function(e){const t=Ln.play.mode;if(Ln.play.pendingPromotion)return!1;if(t!=lr&&Ko.isGameOver())return!1;const n=vr(e)==Ko.turn();return t==ir||n==(t==cr)}(c))return}var i,l;t&&(Tr=c,Or=co[c],In.dragging="pending",Br=void 0),t&&""==Or.value||(e.preventDefault(),_r.style.clip="rect(".concat(Pr*o+a+1,"px,").concat((Cr+1)*o+s-1,"px,").concat((Pr+1)*o+a-1,"px,").concat(Cr*o+s+1,"px)"),t?Br=Or.value:(Br=In.hor?Wo[3*Cr+Pr]:Wo[c],Gr(e)))}function Gr(e,t){Wr(),_r.style.display="block",t&&(Or.value="",Ao()),In.dragging=!0,Qr(e)}function Qr(e){const{offset:t,s:n}=Mn(),{w:o,h:r,coordinates:s}=Pn.board,a=gt.getBoundingClientRect(),c=_r==vt&&s&&!In.hor?a.left+ht:a.left,i=Math.floor((e.clientY-a.top-t.y)/n),l=Math.floor((e.clientX-a.left-t.x)/n);l===Cr&&i===Pr||(Lr=null);const{scrollLeft:u,scrollTop:f}=document.documentElement;i>-1&&i<r&&l>-1&&l<o?(_r.style.left=c+(l-Cr)*n+u+"px",_r.style.top=a.top+(i-Pr)*n+f+"px"):(_r.style.left=e.clientX+u+1-Nr+"px",_r.style.top=e.clientY+f-Rr+"px")}function Yr(e){if(e.targetTouches){const t=e.target.getBoundingClientRect(),n=e.targetTouches[0]||e.changedTouches[0];e.clientX=n.clientX,e.clientY=n.clientY,e.offsetX=e.clientX-t.x,e.offsetY=e.clientY-t.y}}var Zr={copyFEN(){gtag("event","fen_yacpdb_copyFEN");const{w:e,h:t}=Pn.board;return Ut(co.map((e=>Kt(e.value))),e,t)},async fetch(e){try{gtag("event","fen_yacpdb_get"),e.disabled=!0,e.value="Fetching...";const t="https://yacpdb.org/gateway/ql?q="+encodeURIComponent("Id('".concat(xt.value,"')")),n=await fetch("https://corsproxy.io/?"+encodeURIComponent(t)),o=await n.json();if(o.success){let e=function(e){const o=e.charCodeAt(1)-97,r=Number(e[2]);s[(n-r)*t+o]=e[0]};const{w:t,h:n}=Pn.board,r=o.result.entries[0].algebraic,s=Zt(t*n);for(const t of r.black)e(t.toLowerCase());for(const t of r.white)e(t);bo(Ut(s),t)}}catch{alert("An error has occurred. Please try again later.")}finally{e.disabled=!1,e.value="Get FEN"}},search(){gtag("event","fen_yacpdb_search"),window.open("https://yacpdb.org/#q/"+encodeURIComponent(Vr())+"/1")},copyQuery:()=>(gtag("event","fen_yacpdb_copy"),Vr()),copyEdit:()=>(gtag("event","fen_yacpdb_copyEdit"),function(){const e={w:[],b:[],n:[]},{w:t,h:n}=Pn.board;for(let o=0;o<n;o++)for(let n=0;n<t;n++){const r=co[o*t+n].value,s=r.match(/^(-?)([kqbsnrp])$/i);if(!s)continue;const a=qt(s[2],!1,!0).toUpperCase();e[s[1]?"n":r==r.toLowerCase()?"b":"w"].push(a+Gt(o,n))}let o=[];e.w.length&&o.push("    white: [".concat(e.w.join(", "),"]"));e.b.length&&o.push("    black: [".concat(e.b.join(", "),"]"));e.n.length&&o.push("    neutral: [".concat(e.n.join(", "),"]"));return o.join("\n")}())};function Vr(){let e=[];const{w:t,h:n}=Pn.board;for(let o=0;o<n;o++)for(let n=0;n<t;n++){let r=Kt(co[o*t+n].value).replace("(","").replace(")","");r&&(r.match(/\d/)||(r=r.startsWith("!")?"n"+r.toUpperCase():(r==r.toLowerCase()?"b":"w")+r.toUpperCase(),e.push(r+Gt(o,n))))}let o='MatrixExtended("'.concat(e.join(" "),'", false, false, "None")');return Pn.DB.exact&&(o+=" AND PCount(*) = "+e.length),o}var Jr={async fetch(e){try{gtag("event","fen_pdb_get"),e.disabled=!0,e.value="Fetching...";const t=Xr+encodeURIComponent("PROBID='".concat(xt.value,"'")),n=await fetch("https://corsproxy.io/?"+encodeURIComponent(t));bo((await n.text()).match(/<b>FEN:<\/b> (.+)/)[1],!0)}catch{alert("An error has occurred. Please try again later.")}finally{e.disabled=!1,e.value="Get FEN"}},search(){gtag("event","fen_pdb_search"),window.open(Xr+encodeURIComponent(ns()))},copyQuery:()=>(gtag("event","fen_pdb_copy"),ns()),copyEdit:()=>(gtag("event","fen_pdb_copyEdit"),function(){const e={},{w:t,h:n}=Pn.board;for(let o=0;o<n;o++)for(let n=0;n<t;n++){const r=co[o*t+n].value,s=r.match(/^(-?)(?:\*(\d))?([kqbsnrpxc])$/i);if(!s)continue;let a;if("x"==s[3])a="sY";else{const e=es[Gn.indexOf(s[3].toLowerCase().replace("s","n"))];a=(s[1]?"n":r==r.toLowerCase()?"s":"w")+e+ts[Number(s[2]||0)]}e[a]=(e[a]||"")+Gt(o,n)}const o=[];for(const t in e)o.push(t+e[t]);return o.join(" ")}())},Xr="https://pdb.dieschwalbe.de/search.jsp?expression=",es=["K","D","L","S","T","B","I"],ts=["","R","U","L"];function ns(){let e=[];const{w:t,h:n}=Pn.board;for(let o=0;o<n;o++)for(let n=0;n<t;n++){const r=co[o*t+n].value;if(!r.match(/^[kqbsnrp]$/i))continue;const s=es[Gn.indexOf(r.toLowerCase().replace("s","n"))],a=r==r.toLowerCase()?"s":"w";e.push(a+s+Gt(o,n))}let o="POSITION='".concat(e.join(" "),"'");return Pn.DB.exact&&(o+=" AND APIECES=".concat(e.length)),o}function os(e){return new URL(e,location.href).toString()}function rs(){const{SN:e,w:t,h:n}=Pn.board;return e?Ut(ko(),t,n):wt.value}function ss(){const e=Pn.board,t=rs();let n=os("gen/?fen="+t);return 44!=e.size&&(n+="&size="+e.size),"1echecs"!=e.set&&(n+="&set="+e.set),e.pattern&&(n+="&pattern="+e.pattern),e.bg&&(n+="&bg="+e.bg),"1"!=e.border&&(n+="&border="+e.border),e.blackWhite&&(n+="&blackWhite&knightOffset="+e.knightOffset),zt(t)||(n+="&w=".concat(e.w,"&h=").concat(e.h)),n}var as,cs,is={copyJanko:()=>(gtag("event","fen_copy_janko"),"https://www.janko.at/Retros/d.php?ff="+rs()),copyBase64:()=>(gtag("event","fen_link_copy64"),Vo.toDataURL()),copyBase64Img:()=>(gtag("event","fen_link_copy64img"),'<img fen="'.concat(Vo.toDataURL(),'">')),async copyUrl(){gtag("event","fen_gen_link");const e=new URLSearchParams;e.append("key","6d207e02198a847aa98d0a2a901485a5"),e.append("action","upload"),e.append("source",Vo.toDataURL().replace(/^.+base64,/,"")),e.append("format","txt");try{const t=await fetch("https://corsproxy.io/?https://freeimage.host/api/1/upload",{method:"post",body:e});return await t.text()}catch(e){throw alert("Internet connection failed. Please try again later."),e}},copyEmbed(){gtag("event","fen_copy_embed");const e=Pn.board;let t=ss();const{w:n,h:o}=dt(e);return'<iframe src="'.concat(t,'" style="border:none;width:').concat(n,"px;height:").concat(o,'px"></iframe>')},copyEmbedUrl:()=>(gtag("event","fen_copy_embedUrl"),ss()),copyImg:()=>(gtag("event","fen_copy_sdkImg"),'<img fen="'.concat(rs(),'">')),copySDK(){gtag("event","fen_copy_sdk");const e=Pn.board;let t="";return 44!=e.size&&(t+=' data-size="'.concat(e.size,'"')),"1echecs"!=e.set&&(t+=' data-set="'.concat(e.set,'"')),e.bg&&(t+=' data-bg="'.concat(e.bg,'"')),"1"!=e.border&&(t+=' data-border="'.concat(e.border,'"')),e.blackWhite&&(t+=' data-black-white="true" data-knight-offset="'.concat(e.knightOffset,'"')),'<script src="'.concat(os("sdk.js"),'"').concat(t,"><\/script>")}},ls={async copy(){if(8!=Pn.board.w||8!=Pn.board.h)throw alert("只支援標準棋盤"),!0;gtag("event","fen_bbs_copy");return(await import("./modules/ptt.js")).generate(ko(),rs(),xt.value,Pn.BBS,Pn.board,Rt.isTouch)}},us=new RegExp(String.raw(as||(as=o(["^+(?<c>[nwb])(?<is>",")(?<at>",")(=(?<p>","))?$"],["^\\+(?<c>[nwb])(?<is>",")(?<at>",")(=(?<p>","))?$"])),un,ln,un)),fs=new RegExp(String.raw(cs||(cs=o(["^-([nwb]",")?(?<at>",")$"])),un,ln)),ps=new RegExp("^(?<c>[nwb])".concat(un,"(?<from>").concat(ln,")-&gt;(?<to>").concat(ln,")(=(?<p>").concat(un,"))?$")),hs=new RegExp("^".concat(un,"(?<from>").concat(ln,")&lt;-&gt;").concat(un,"(?<to>").concat(ln,")$")),ds=new RegExp("^(?<at>".concat(ln,")=(?<c>[nwb])?(?:r?(?<p>").concat(un,"))?$")),gs=new RegExp("^I".concat(ln,"(,").concat(ln,")*$"));function ms(e,t,n){var o,r,s,a,c;let i=null==(o=t.match(us))?void 0:o.groups;if(i)return wn(e,i.at,i.p||i.is,i.c);if(i=null==(r=t.match(fs))?void 0:r.groups,i)return wn(e,i.at,"");if(i=null==(s=t.match(ps))?void 0:s.groups,i)return xn(e,i.from,i.to),void(i.p&&wn(e,i.to,i.p,i.c));if(i=null==(a=t.match(hs))?void 0:a.groups,i)return function(e,t,n){t=Yt(t),n=Yt(n);const o=e[n];e[n]=e[t],e[t]=o}(e,i.from,i.to);if(i=null==(c=t.match(ds))?void 0:c.groups,i)return wn(e,i.at,i.p||function(e,t){const n=e[Yt(t)];return n.match(new RegExp(un,"i"))[0].toUpperCase()}(e,i.at),i.c||function(e,t){const n=e[Yt(t)];return un.startsWith("-")?"n":n==n.toLowerCase()?"b":"w"}(e,i.at));if(i=t.match(gs),i){n.push(...t.match(new RegExp(ln,"g")));for(const t of n)wn(e,t,"I","n")}else;}var ys=new RegExp(yn),bs=new RegExp(vn);function vs(e,t,n,o,r){let s,a;if(n.move.startsWith("0-0")){const o="w"==t?"1":"8",c="0-0"==n.move?["g","h","f"]:["c","a","d"];xn(e,"e"+o,c[0]+o,r),a=xn(e,c[1]+o,s=c[2]+o,r)}else a=xn(e,n.from,s=n.to,r),n.ep&&wn(e,n.to.replace("3","4").replace("6","5"),""),n.then&&xn(e,n.to,s=n.then,r);"I"==n.p?(o.push(s),wn(e,s,"I","n")):n.p&&wn(e,s,a=n.p,n.pc?n.pc:t),n.cc&&wn(e,s,a,n.cc)}var ws=new RegExp("^[nwb]".concat(un,"(").concat(ln,")--&gt;(").concat(ln,")$")),xs=new RegExp("^[nwb]".concat(un,"(").concat(ln,")&lt;--&gt;[nwb]").concat(un,"(").concat(ln,")$")),ks=new RegExp("^([+-]?)([nwb])(".concat(un,")(").concat(ln,")$")),As=new RegExp("^(".concat(un,")==&gt;(").concat(un,")$")),Es=new RegExp("^mirror(".concat(ln,")&lt;--&gt;(").concat(ln,")$")),Ss=new RegExp("^shift(".concat(ln,")==&gt;(").concat(ln,")$")),Ns=/^rotate(90|180|270)$/;function Rs(e,t){let n=t.match(ws);if(n)return xn(e,n[1],n[2]);if(n=t.match(xs),n)return exchange(e,n[1],n[2]);if(n=t.match(ks),n)"+"==n[1]||""==n[1]?wn(e,n[4],n[3],n[2]):wn(e,n[4],"");else{if(n=t.match(Es),n){let t;const o=Qt(n[1]),r=Qt(n[2]);return t=o.x==r.x?"|":o.y==r.y?"-":(o.x-r.x)*(o.y-r.y)>0?"\\":"/",void Cs(e,Jt(e,t))}if(n=t.match(Ss),!n){if(n=t.match(As),n){const t=Sn(n[1]),o=t.toLowerCase(),r=Sn(n[2]),s=r.toLowerCase();for(let n=0;n<e.length;n++)e[n]==t&&(e[n]=r),e[n]==o&&(e[n]=s),e[n]=="-"+o&&(e[n]="-"+s)}return n=t.match(Ns),n?Cs(e,Xt(e,"90"==n[1]?-1:"180"==n[1]?2:1)):"PolishType"==t?Cs(e,en(e)):void 0}{const t=Qt(n[1]),o=Qt(n[2]);Cs(e,Vt(e,o.x-t.x,o.y-t.y))}}}function Cs(e,t){e.length=0,e.push(...t)}var Ps,Os,Is=new RegExp(pn),_s=new RegExp(String.raw(Ps||(Ps=o(["\n\n+|(?:",")|(?:",")"],["\\n\\n+|(?:",")|(?:",")"])),pn,vn),"g");function Bs(e,t,n){return function(e,t,n,o){var r;if(!t)return n;console.log(n);const s=function(e){var t;const n=e.replace(/\n/g," ").replace(mn,"\n$&").split("\n"),o=n.filter((e=>e.match(tn("2option","^")))).join(" "),r=n.filter((e=>e.match(nn("condition")))).join(" ");return{imitators:null==(t=r.match(js))?void 0:t.join(" ").match(new RegExp(ln,"g")),duplex:Ds.test(o),halfDuplex:Ws.test(o)}}(e);let a=0;const c=function(e){return e.split(tn("2twin","\\b","\\b")).map((e=>{var t;return null==(t=e.match(Ls))?void 0:t[1].replace(/\s/g,"")}))}(e),i={pg:/dia/i.test(c[0]),fen:$s(Hs(t),s.imitators),imitators:s.imitators,ordering:Ms(c[0],s.halfDuplex)};let l=i;const u={stack:[],board:Ft(l.pg?Bt:l.fen),ordering:l.ordering,imitators:null==(r=l.imitators)?void 0:r.concat()};let f=!1;n=n.replace(/<br>/g,"\n");const p=s.duplex?function(e){const t=/^\n\n+ +1\./,n=e.replace(/\n\nsolution finished./,"\n  1.").match(/\n\n+[^\n]+/g).filter(((e,n,o)=>n>0&&e.match(t)&&o[n-1].match(t))).map((e=>e.match(/^\n+/)[0].length));return"\n".repeat(Math.max(...n))}(n):"";let h=!1;return n=n.replace(_s,(e=>{if(f)return e;try{if(e.match(/^\n+$/)){u.stack.length=0;const t=l.pg?Bt:l.fen;return u.board=Ft(t),e==p&&h&&(u.ordering=zs(u.ordering)),e}const t=e.match(Is);if(t){h=!1,l=It(t[1]?l:i);const n=c[++a];n&&(l.ordering=Ms(n,s.halfDuplex),l.pg=/dia/i.test(n)),u.ordering=l.ordering,u.stack.length=0;const{fen:o,board:r}=function(e,t){const n=Ft(e),o=t.replace(/(mirror|shift|rotate) /g,"$1").replace(/ ==&gt; /g,"==&gt;").split(" ");for(const e of o)Rs(n,e);return{fen:Ut(n),board:n}}(l.fen,t[2]);return l.fen=o,u.board=l.pg?Ft(Bt):r,e}return h=!0,function(e,t,n,o){var r;const{stack:s,ordering:a}=n,c=e.match(bs),i=c.groups.count,l=t.pg?Bt:t.fen;let u=null;if(i){const e=s.findIndex((e=>e.move==i||parseInt(e.move)>parseInt(i)));e>=0&&(u=e>0?s[e-1].fen:l,n.board=Ft(u),n.imitators&&(n.imitators=(e>0?s[e-1].imitators:t.imitators).concat()),s.length=e)}const f=a[!i||i.endsWith("...")?1:0],{imitators:p,board:h}=n,d=null==p?void 0:p.concat();if(p){for(const e of p)wn(h,e,"");p.length=0}const g=[],m=c.groups.main.split("/");for(let e of m){const t=e.match(ys);vs(h,f,t.groups,p,g);const n=null==(r=e.match(/\[[^\[\]]+(?=\])/g))?void 0:r.map((e=>e.substring(1)));n&&n.forEach((e=>ms(h,e,p)))}const y=Ut(h);if(i&&s.push({move:i,color:f,fen:y,imitators:null==p?void 0:p.concat()}),d)for(let e=0;e<g.length;e++){const[t,n]=g[e].match(/[a-z]\d/g).map((e=>Qt(e))),o=n.x-t.x,r=n.y-t.y;for(const t of d){const n=Qt(t);g[e]+=t+Gt(n.y+r,n.x+o)}}return(1==s.length&&i?o("*",l)+" ":"")+o(e,y,g,u)}(e,l,u,o)}catch(t){return console.log(t,e),f=!0,e}})),n.replace(/   ?<span init/g,"<span").replace(/\n/g,"<br>")}(e,t,n,Fs)}var Ts,Ls=new RegExp(String.raw(Os||(Os=o(["","s+(S*(?:d|[^ds]s+d+(?:.[05])?))"],["","\\s+(\\S*(?:\\d|[^\\d\\s]\\s+\\d+(?:\\.[05])?))"])),nn("3stipulation")),"i");function Ms(e,t){if(!e)return"wb";const n=e.match(/^(\d+-&gt;)?(?:exact-)?(?:(?:ser|pser|phser|semi|reci)-)?(hs|hr|h|s|r)?/i);let o;return o=!n||n[1]?"wb":"h"==n[2]?"bw":"wb",t?zs(o):o}function $s(e,t){if(!t)return e;const n=Ft(e);for(const e of t)n[Yt(e)]="-"+Sn("i");return Ut(n)}var js=new RegExp(String.raw(Ts||(Ts=o(["\bimitw*s+(?:",")+"],["\\bimit\\w*\\s+(?:",")+"])),ln),"ig"),Ds=tn("3duplex"),Ws=tn("3halfDuplex");function zs(e){return"wb"==e?"bw":"wb"}function Fs(e,t,n,o){const r="*"==e?"init ":"";t=t.replace(/-/g,"&#45;").replace(/"/g,"&#34;");let s="";return n&&n.length&&(s+=' data-anime="'.concat(n.join(","),'"')),o&&(s+=' data-before="'.concat(o,'"')),"<span ".concat(r,'class="step btn px-1 py-0" data-fen="').concat(t,'"').concat(s,">").concat(e,"</span>")}var Us=/[-+=]?(\.[0-9A-Z][0-9A-Z]|[A-Z])|\d+|\//gi;function Hs(e){return e.match(Us).map((e=>{if("/"==e||e.match(/^\d+$/))return e;const t=e.match(/^[-+=]/)?e[0]:null;return t&&(e=e.substring(1)),e.startsWith(".")&&(e=e.substring(1)),e=Sn(e),"+"==t&&(e=e.toUpperCase()),"-"==t&&(e=e.toLowerCase()),"="==t&&(e="-"+e.toLowerCase()),e})).join("")}var Ks,qs,Gs,Qs=["1Black","1Neutral","1White"].map(nn).join("|"),Ys=["1Chameleon","2FrischAuf","2Functionary","2HalfNeutral","2HurdleColourChanging","1Jigger","1Kamikaze","1Magic","2Paralysing","2Protean","1Royal","1Uncapturable","1Volage"].map(nn).join("|"),Zs="(?<p>".concat(un,")(?<sq>(?:").concat(ln,")+)"),Vs=String.raw(Ks||(Ks=o(["s+(?<c>",")(?:s+(?:","))?(?<l>(?:s+",")+)"],["\\s+(?<c>",")(?:\\s+(?:","))?(?<l>(?:\\s+",")+)"])),Qs,Ys,Zs),Js=String.raw(qs||(qs=o(["","(?:",")+(?=s+(?:",")|$)"],["","(?:",")+(?=\\s+(?:",")|$)"])),nn("2pieces"),Vs,gn);function Xs(e,t){if(2==t.length&&(t="."+t),"n"==e)return"="+t;const n="w"==e;return t.match(/[A-Z]/)?n?t:t.toLowerCase():(n?"+":"-")+t}Ln.popeye.running=!1,Ln.popeye.editMap=!1,Ln.popeye.playing&&Uo().then((()=>ve((()=>Sa(!0)))));var ea,ta,na,oa,ra="modules/py.js",sa=!1,aa=document.getElementById("Output");function ca(){5==(ta+=".").length&&(ta="."),Ln.popeye.output=Ln.popeye.intOutput+"<br>"+ta,ia()}function ia(){sa&&(sa=!1,ve((()=>aa.scrollTop=aa.scrollHeight-aa.clientHeight)))}function la(e){Gs.terminate(),Gs=void 0;const t=500-(performance.now()-ea);ia(),clearInterval(na),e?fa():(Ln.popeye.output=Ln.popeye.intOutput,setTimeout((()=>Ln.popeye.running=!1),Math.max(0,t)),ua())}function ua(){Gs||((Gs=new Worker(ra)).onerror=t=>{let n;t.preventDefault(),clearInterval(na),Ln.popeye.running=!1,t.filename?(Gs.terminate(),n="An error occur in the Popeye module. Please submit an issue about this.\n"+e.message):n="Unable to load the Popeye module; please check your network connection.",Ln.popeye.output=pa(n),Gs=void 0},Gs.onmessage=e=>{const t=e.data;++oa>3e3?(Ln.popeye.intOutput+="<br>".concat(pa("Too much output. Please modify the input to prevent excessive output."),"<br>"),la()):-1===t?(gtag("event","fen_popeye_fallback"),ra="modules/py.asm.js",la(!0),Ln.popeye.intOutput="Fallback to JS mode.<br>"):null===t?la():(sa=sa||Boolean(aa)&&aa.scrollTop+aa.clientHeight+30>aa.scrollHeight,"string"==typeof t.text&&(Ln.popeye.intOutput+=ha(t.text)+"<br>"),"string"==typeof t.err&&(Ln.popeye.error=!0,Ln.popeye.intOutput+=pa(ha(t.err))))})}function fa(){ua(),ta=".";const e=Ln.popeye;oa=0,e.intOutput="",e.error=!1,e.running=!0,na=setInterval(ca,500),ea=performance.now(),Gs.postMessage("Opti NoBoard\n"+e.intInput)}function pa(e){return'<span class="text-danger">'.concat(e,"</span>")}function ha(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}var da,ga,ma,ya=new RegExp(String.raw(da||(da=o(["(?:",")s.+$"],["(?:",")\\s.+$"])),["remark","2author","2origin","3title"].map(nn).join("|")),"igm"),ba=new RegExp(String.raw(ga||(ga=o(["","s+S+"],["","\\s+\\S+"])),nn("5protocol")),"i"),va=tn("3beginProblem"),wa=tn("3endProblem"),xa=/\bnext\s[\s\S]+$/i,ka=nn("3forsyth"),Aa=nn("2pieces");function Ea(e){var t;e=e.replace(ya,"").replace(ba,"").replace(va,"").replace(xa,"").replace(wa,"");const n=Ln.popeye;if(new RegExp("".concat(ka,"|").concat(Aa),"i").test(e))return n.initFEN=function(e){const t=e.match(new RegExp(Js,"ig"));if(!t)return null;const n=Zt(64);for(const e of t){const t=e.match(new RegExp(Vs,"ig"));for(const e of t){const t=e.match(new RegExp(Vs,"i")).groups,o=t.c[0].toLowerCase(),r=t.l.match(new RegExp(Zs,"ig"));for(const e of r){const t=e.match(new RegExp(Zs,"i")).groups,r=t.p.toUpperCase(),s=t.sq.match(new RegExp(ln,"g"));for(const e of s)n[Yt(e)]=Xs(o,r)}}}return Ut(n)}(e)||(null==(t=e.match(new RegExp(String.raw(ma||(ma=o(["","s+(S+)"],["","\\s+(\\S+)"])),ka),"i")))?void 0:t[1]),n.initFEN&&bo(Hs(n.initFEN)),e;{const{fen:t,imitators:o}=function(){const{w:e,h:t}=Pn.board;if(8!=e||8!=t)return null;const n=[],o=xo().map(((e,t)=>{if(""==e)return e;let o=Pn.board.SN?e.replace("s","n").replace("S","N").replace("g","s").replace("G","S"):e;if(o=function(e){let t=e.startsWith("-")?"=":"";t&&(e=e.substring(1));const n=e.toUpperCase();if(n.match(/^[KQBNRP]$/))e=e.replace("n","s").replace("N","S");else{const o=n==e,r=En.custom();if(!(n in r))return null;const s=r[n];2==(e=o?s:s.toLowerCase()).length&&(e="."+e),s.match(/^\d+$/)&&!t&&(t=o?"+":"-")}return t+e}(o),!o)throw alert("Unspecified fairy piece: "+e);return o.match(/^=?i$/i)?(n.push(Gt(t)),""):o}));return{fen:Ut(o,8,8),imitators:n}}();return n.initFEN=t,o.length&&(e+="\ncond imitator "+o.join("")),"fors ".concat(n.initFEN,"\n").concat(e)}}async function Sa(e){const t=Ln.popeye;t.steps=[...aa.querySelectorAll("span")],0!=t.steps.length&&(Na(0,!0),t.playing=!0,e&&await Uo(),er([]),ve(jo))}async function Na(e,t){var n;const o=Ln.popeye,r=o.steps[e],s=o.steps[o.index];if(s&&s.dataset.anime&&(e==o.index-1&&!s.dataset.before||r.dataset.fen==s.dataset.before))await ro(r.dataset.fen,s.dataset.fen,s.dataset.anime,!0);else{const t=r.dataset.before||(null==(n=o.steps[e-1])?void 0:n.dataset.fen);r.dataset.anime&&t?await ro(t,r.dataset.fen,r.dataset.anime):(so(),bo(r.dataset.fen))}t||s.classList.remove("active"),o.index=e,r.classList.add("active"),ve((()=>function(e){const t=10,n=e.offsetTop-t;aa.scrollTop>n&&(aa.scrollTop=n);const o=e.offsetTop+e.clientHeight-aa.clientHeight+t;aa.scrollTop<o&&(aa.scrollTop=o);const r=e.offsetLeft-t;aa.scrollLeft>r&&(aa.scrollLeft=r);const s=e.offsetLeft+e.clientWidth-aa.clientWidth+t;aa.scrollLeft<s&&(aa.scrollLeft=s)}(r)))}var Ra={run(){gtag("event","fen_popeye_run");try{const e=Ln.popeye;e.intInput=Ea(e.input),fa()}catch{}},cancel(){Gs&&la()},play(){const e=Ln.popeye;aa.scrollTop=aa.scrollLeft=0,gtag("event","fen_popeye_play"),e.output=Bs(e.intInput,e.initFEN,e.intOutput),ve(Sa)},step(e){const t=Ln.popeye.steps.indexOf(e.target);t>=0&&t!=Ln.popeye.index&&(e.preventDefault(),Na(t))},exit(){const e=Ln.popeye;bo(e.steps[0].dataset.fen),e.output=e.intOutput,e.playing=!1,er([]),ve(jo)},moveBy(e){const t=Ln.popeye;let n=t.index;n+=e,n<0&&(n=0),n>t.steps.length-1&&(n=t.steps.length-1),Ra.move(n)},move(e){e!=Ln.popeye.index&&Na(e)},editMap(){gtag("event","fen_popeye_edit_map"),Ln.popeye.mapping=Ca(Pn.popeye.pieceMap),Ln.popeye.editMap=!0},resetMap(){Ln.popeye.mapping=Ca(kn)},saveMap(){const e=Ln.popeye.mapping.toUpperCase().split("\n"),t={};for(const n of e){let[e,o]=n.replace(/\s/g,"").split("=");e.match(Ta)&&o&&o.match(La)&&(t[e]=o)}Pn.popeye.pieceMap=t,Ln.popeye.editMap=!1}};function Ca(e){const t=[];for(const n in e)t.push("".concat(n,"=").concat(e[n]));return t.join("\n")}var Pa,Oa,Ia,_a,Ba,Ta=/^(\*[1-3][KQBNRP]|(\*[1-3])?[CXSTAD]|''..|'.)$/,La=new RegExp("^".concat(un,"$")),Ma=["image/png","image/jpeg","image/bmp","image/webp"];function $a(e){Ma.includes(e.type)?alert("Image processing under development."):alert("Unsupported format.")}if(async function(){const e=Nn.get("image");if(e){const t=new URL(location.href);t.searchParams.delete("image"),history.replaceState(null,"",t.toString());const n=await fetch("shareImage?image="+e);$a(await n.blob())}}(),Ln.stockfish.lines.length){const e=Ln.stockfish.lines,t=Ln.stockfish.header;Ln.stockfish.lines=[],Ln.stockfish.header=[],wr().then((n=>{Oa=n,Ln.stockfish.lines=e,Ln.stockfish.header=t}))}function ja(e){Pa.postMessage(e)}window.cmd=ja;var Da="(".concat(ln,")(").concat(ln,")([qrbn]?)"),Wa="modules/stockfish/",za=Rt.thread?"":"-single",Fa=1,Ua=["".concat(Wa,"stockfish-nnue-16.js#stockfish-nnue-16.wasm,worker"),"".concat(Wa,"stockfish-nnue-16.wasm"),"".concat(Wa,"stockfish-nnue-16-single.js#stockfish-nnue-16-single.wasm,worker"),"".concat(Wa,"stockfish-nnue-16-single.wasm"),"".concat(Wa,"nn-5af11540bbfe.nnue")];function Ha(){Pa||(Ba=new Promise((e=>{(Pa=new Worker("".concat(Wa,"stockfish-nnue-16").concat(za,".js#stockfish-nnue-16").concat(za,".wasm"))).onmessage=t=>{const n=t.data;console.log(n),"readyok"==n&&e(),n.startsWith("info ")&&function(e){var t;if(2!=In.stockfish.running)return;const n=e.match(/multipv (\d+)/);if(!n)return;const o=Number(n[1])-1,r=e.match(/mate (-?)(\d+)/),s=e.match(/score cp (-?\d+)/),a=Number(s&&s[1]||0)/100;if(0==o){const t=e.match(/depth (\d+)/);if(t&&(Ln.stockfish.depth=t[1]),r){const e="w"==_a.split(" ")[1]==Boolean(r[1])?"Black":"White";Ln.stockfish.mate=[e,r[2]]}s&&(Ln.stockfish.score=a)}const c=e.match(new RegExp("pv (".concat(Da,"(?: ").concat(Da,")*)")));if(c){if((null==(t=Ln.stockfish.lines[o])?void 0:t.raw)==c[1])return;const e=c[1].split(" ").map((e=>e.match(new RegExp(Da))));Ln.stockfish.moves=[],Ia.init(_a);for(const e of Ln.stockfish.header){Ia.move(e).annotation=e.annotation}for(const t of e){if(Ia.move({from:t[1],to:t[2],promotion:t[3]}).san.endsWith("="))break}const n={rawScore:r?r[1]?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY:a,score:r?r[1]+"#"+r[2]:a.toFixed(2),raw:c[1],moves:Ia.state.history.concat(),pgn:Ia.copyPGN()};Ln.stockfish.lines[o]=n}Pn.Stockfish.study&&Ka()}(n.substring(5)),n.match(new RegExp("^bestmove ".concat(Da)))&&function(){const e=Pn.Stockfish.depth;if(!Pn.Stockfish.study||e<4||!Ka())In.stockfish.running=0;else{Ln.stockfish.header=Ln.stockfish.lines[0].moves.slice(0,Ln.stockfish.header.length+2);ja("position fen "+Ln.stockfish.header[Ln.stockfish.header.length-1].after),ja("go depth "+e)}}()},ja("uci"),ja("setoption name Use NNUE value true"),ja("setoption Hash 512"),Rt.thread&&ja("setoption name Threads value "+Math.max(2,navigator.hardwareConcurrency-4)),ja("isready")})))}function Ka(){const e=Ln.stockfish.lines.filter((e=>e&&e.moves.length));if(e.length<=1)return!1;const t=Ln.stockfish.header.length;e.forEach((e=>e.moves[t]&&(e.moves[t].annotation=void 0)));const n=e.filter((e=>e.rawScore>Fa));if(n.length>1)return!1;if(1==n.length)return n[0].moves[t].annotation="!",!0;const o=e.filter((e=>e.rawScore>-Fa));return 1==o.length&&(o[0].moves[t].annotation="!",!0)}var qa={async download(){gtag("event","fen_stockfish_download"),In.stockfish.status=1,"serviceWorker"in navigator&&await navigator.serviceWorker.ready;for(const e of Ua){if(200!=(await fetch(e)).status)return alert("Download failed. Please check your network connection."),void(In.stockfish.status=0)}Pn.Stockfish.downloaded=!0,In.stockfish.status=2},async analyze(){if(gtag("event","fen_stockfish_run"),In.stockfish.running=1,Ha(),_a=So()){Oa||(Oa=await wr()),Ia=new Oa.Chess;try{Ia.init(_a)}catch(e){return void alert("This board is not playable: "+e.message.replace(/^.+:/,"").trim().replace(/[^.]$/,"$&."))}await Ba,Ln.stockfish=It(Bn),In.stockfish.running=2,ja("setoption name MultiPV value "+Pn.Stockfish.lines),ja("ucinewgame"),ja("position fen "+_a),ja("go depth "+Pn.Stockfish.depth)}else alert("Only orthodox chess is supported.")},play(e){gtag("event","fen_stockfish_play"),Ln.play.mode="normal",Ln.tab=6,Sr(e.pgn)},stop(){In.stockfish.running=3,ja("stop")},format:e=>Oa.formatGame(e),then(){const e=function(){const e=Ln.stockfish.lines,t=Ln.stockfish.header.length,n=e.filter((e=>e.rawScore>Fa));return n.length>1?n.map((e=>e.moves[t])):e.filter((e=>e.rawScore>-Fa)).map((e=>e.moves[t]))}();let t=Oa.format(e.shift());return e.length&&(t+=" (or ".concat(e.map((e=>Oa.format(e))).join(", "),")")),t}};function Ga(){or(),er()}!async function(){window.addEventListener("resize",(()=>Mo({})));const e=Nn.get("fen");await Mo({},!0),lo.draw=or,e?(bo(e,!0),wo()):Ao(),setTimeout(jo,1e3)}(),kt.onmousedown=qr,kt.ontouchstart=qr,kt.ondragstart=e=>e.preventDefault(),kt.onwheel=Hr,yt.onmousedown=qr,yt.ontouchstart=qr,document.body.onmousedown=e=>{e.target!=yt&&e.target!=kt&&Wr()},document.body.onmousemove=jr,document.body.ontouchmove=jr,document.body.onmouseleave=zr,document.body.onmouseup=zr,document.body.ontouchend=zr,document.addEventListener("mousedown",(function(e){var t;const n=null==(t=document.activeElement)?void 0:t.nodeName.toLowerCase();"input"!=n&&"textarea"!=n&&e.detail>1&&e.preventDefault()}),!1),addEventListener("keydown",(e=>{var t;if(!Ln.play.playing&&!Ln.popeye.playing)return;const n=null==(t=document.activeElement)?void 0:t.nodeName.toLowerCase();if("input"==n||"textarea"==n)return;const o=e.key;"a"!=o&&"ArrowLeft"!=o||(e.preventDefault(),Ln.play.playing?dr(-1):Ra.moveBy(-1)),"d"!=o&&"ArrowRight"!=o||(e.preventDefault(),Ln.play.playing?dr(1):Ra.moveBy(1))})),window.share=async function(e){if(gtag("event","fen_img_share"),Rt.canSharePng){const e=await sr(),t=[new File([e],"board.png",{type:"image/png"})];navigator.share({files:t})}else{e.disabled=!0;const t=e.querySelector("i"),n=t.className;t.className="fa-spin fa-solid fa-spinner";try{const e=await is.copyUrl();navigator.share({url:e,text:rs()})}finally{e.disabled=!1,t.className=n}}},ut({env:Rt,copyImage:async function(){if(Rt.canCopyImg){const e=await sr();return navigator.clipboard.write([new ClipboardItem({"image/png":e})])}throw alert('Image copying is not enabled in your browser.\nIf you\'re using Firefox, this can be enabled by the following.\n1. Visit "about:config" in your address bar.\n2. Search for "dom.events.asyncClipboard.clipboardItem".\n3. Toggle its value to true.\n4. Reload this tool.'),!0},CheckboxBase:Dn,Checkbox:Wn,CheckboxR:function(e,t){return Wn(e,t,null,(()=>"retro"==Ln.play.mode))},CopyButton:function(e,t,n,o){return{$template:"#copyBtn",cls:n,label:e,dis:void 0!==o&&o,state:0,async copy(){this.state=1;try{let e=t;for(;"function"==typeof e;)e=await e();"string"==typeof e&&function(e){if(Rt.canCopy)navigator.clipboard.writeText(e);else{const t=document.createElement("input");document.body.appendChild(t),t.value=e,t.select(),document.execCommand("copy"),document.body.removeChild(t)}}(e),this.state=2,setTimeout((()=>this.state=0),1e3)}catch(e){this.state=0}}}},redraw:Ga,updateBG:function(){rr(mt.getContext("2d")),Ga()},updateSN:function(){let e=!1;for(const t of co)e=mo(t,!0)||e;e&&Ao()},openFile:function(e){const t=e.files[0];e.value="",$a(t)},Popeye:Ra,updateEdwards:Eo,toFEN:Ao,toggleCoordinates(){Mo({},!0)},get DB(){return"PDB"==Pn.DB.use?Jr:Zr},get noEditing(){return $n()},get hideTemplate(){return In.hor&&Ln.popeye.playing},YACPDB:Zr,BBS:ls,API:is,PLAY:Mr,Stockfish:qa,store:Pn,state:Ln,status:In,drawExport:async function(){await Uo(),or()},resize(){Ln.split,Promise.resolve().then((()=>Mo({})))},saveSettings:function(){localStorage.setItem("settings",JSON.stringify(Pn))},saveSession:function(){Rt.isTop&&sessionStorage.setItem("state",JSON.stringify(Ln))}}).mount()})();