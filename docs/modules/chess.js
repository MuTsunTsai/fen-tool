var _e=Object.defineProperty;var pe=(a,e,t)=>e in a?_e(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var k=(a,e,t)=>(pe(a,typeof e!="symbol"?e+"":e,t),t);var C="w",x="b",v="p",W="n",j="b",D="r",I="q",E="k",O="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";var ge={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"};var u={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},d={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},G={b:[16,32,17,15],w:[-16,-32,-17,-15]},V={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},me=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],be=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],Se={p:1,n:2,b:4,r:8,q:16,k:32},Ee="pnbrqkPNBRQK",ee=[W,j,D,I],ve=7,ye=6,Ce=1,ke=0,B={[E]:u.KSIDE_CASTLE,[I]:u.QSIDE_CASTLE},A={w:[{square:d.a1,flag:u.QSIDE_CASTLE},{square:d.h1,flag:u.KSIDE_CASTLE}],b:[{square:d.a8,flag:u.QSIDE_CASTLE},{square:d.h8,flag:u.KSIDE_CASTLE}]},Pe={b:Ce,w:ye},Ne=["1-0","0-1","1/2-1/2","*"];function F(a){return a>>4}function T(a){return a&15}function re(a){return"0123456789".indexOf(a)!==-1}function P(a){let e=T(a),t=F(a);return"abcdefgh".substring(e,e+1)+"87654321".substring(t,t+1)}function K(a){return a===C?x:C}function xe(a){let e=a.split(/\s+/);if(e.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};let t=parseInt(e[5],10);if(isNaN(t)||t<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};let s=parseInt(e[4],10);if(isNaN(s)||s<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(e[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(e[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(e[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};let r=e[0].split("/");if(r.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let n=0;n<r.length;n++){let o=0,c=!1;for(let h=0;h<r[n].length;h++)if(re(r[n][h])){if(c)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};o+=parseInt(r[n][h],10),c=!0}else{if(!/^[prnbqkPRNBQK]$/.test(r[n][h]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};o+=1,c=!1}if(o!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(e[3][1]=="3"&&e[1]=="w"||e[3][1]=="6"&&e[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};let i=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(let{color:n,regex:o}of i){if(!o.test(e[0]))return{ok:!1,error:"Invalid FEN: missing ".concat(n," king")};if((e[0].match(o)||[]).length>1)return{ok:!1,error:"Invalid FEN: too many ".concat(n," kings")}}return Array.from(r[0]+r[7]).some(n=>n.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function we(a,e){let t=a.from,s=a.to,r=a.piece,i=0,n=0,o=0;for(let c=0,h=e.length;c<h;c++){let p=e[c].from,g=e[c].to,l=e[c].piece;r===l&&t!==p&&s===g&&(i++,F(t)===F(p)&&n++,T(t)===T(p)&&o++)}return i>0?n>0&&o>0?P(t):o>0?P(t).charAt(1):P(t).charAt(0):""}function q(a,e,t,s,r,i=void 0,n=u.NORMAL){let o=F(s);if(r===v&&(o===ve||o===ke))for(let c=0;c<ee.length;c++){let h=ee[c];a.push({color:e,from:t,to:s,piece:r,captured:i,promotion:h,flags:n|u.PROMOTION})}else a.push({color:e,from:t,to:s,piece:r,captured:i,flags:n})}function te(a){let e=a.charAt(0);return e>="a"&&e<="h"?a.match(/[a-h]\d.*[a-h]\d/)?void 0:v:(e=e.toLowerCase(),e==="o"?E:e)}function H(a){return a.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function se(a){return a.split(" ").slice(0,4).join(" ")}var L=class{constructor(e=O){k(this,"_board",new Array(128));k(this,"_turn",C);k(this,"_header",{});k(this,"_kings",{w:-1,b:-1});k(this,"_epSquare",-1);k(this,"_halfMoves",0);k(this,"_moveNumber",0);k(this,"_history",[]);k(this,"_comments",{});k(this,"_castling",{w:0,b:0});k(this,"_positionCounts",{});this.load(e)}clear({preserveHeaders:e=!1}={}){this._board=new Array(128),this._kings={w:-1,b:-1},this._turn=C,this._castling={w:0,b:0},this._epSquare=-1,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=e?this._header:{},delete this._header.SetUp,delete this._header.FEN,this._positionCounts=new Proxy({},{get:(t,s)=>s==="length"?Object.keys(t).length:(t==null?void 0:t[se(s)])||0,set:(t,s,r)=>{let i=se(s);return r===0?delete t[i]:t[i]=r,!0}})}removeHeader(e){e in this._header&&delete this._header[e]}load(e,{skipValidation:t=!1,preserveHeaders:s=!1}={}){let r=e.split(/\s+/);if(r.length>=2&&r.length<6){let o=["-","-","0","1"];e=r.concat(o.slice(-(6-r.length))).join(" ")}if(r=e.split(/\s+/),!t){let{ok:o,error:c}=xe(e);if(!o)throw new Error(c)}let i=r[0],n=0;this.clear({preserveHeaders:s});for(let o=0;o<i.length;o++){let c=i.charAt(o);if(c==="/")n+=8;else if(re(c))n+=parseInt(c,10);else{let h=c<"a"?C:x;this._put({type:c.toLowerCase(),color:h},P(n)),n++}}this._turn=r[1],r[2].indexOf("K")>-1&&(this._castling.w|=u.KSIDE_CASTLE),r[2].indexOf("Q")>-1&&(this._castling.w|=u.QSIDE_CASTLE),r[2].indexOf("k")>-1&&(this._castling.b|=u.KSIDE_CASTLE),r[2].indexOf("q")>-1&&(this._castling.b|=u.QSIDE_CASTLE),this._epSquare=r[3]==="-"?-1:d[r[3]],this._halfMoves=parseInt(r[4],10),this._moveNumber=parseInt(r[5],10),this._updateSetup(e),this._positionCounts[e]++}fen(){var i,n;let e=0,t="";for(let o=d.a8;o<=d.h1;o++){if(this._board[o]){e>0&&(t+=e,e=0);let{color:c,type:h}=this._board[o];t+=c===C?h.toUpperCase():h.toLowerCase()}else e++;o+1&136&&(e>0&&(t+=e),o!==d.h1&&(t+="/"),e=0,o+=8)}let s="";this._castling[C]&u.KSIDE_CASTLE&&(s+="K"),this._castling[C]&u.QSIDE_CASTLE&&(s+="Q"),this._castling[x]&u.KSIDE_CASTLE&&(s+="k"),this._castling[x]&u.QSIDE_CASTLE&&(s+="q"),s=s||"-";let r="-";if(this._epSquare!==-1){let o=this._epSquare+(this._turn===C?16:-16),c=[o+1,o-1];for(let h of c){if(h&136)continue;let p=this._turn;if(((i=this._board[h])==null?void 0:i.color)===p&&((n=this._board[h])==null?void 0:n.type)===v){this._makeMove({color:p,from:h,to:this._epSquare,piece:v,captured:v,flags:u.EP_CAPTURE});let g=!this._isKingAttacked(p);if(this._undoMove(),g){r=P(this._epSquare);break}}}}return[t,this._turn,s,r,this._halfMoves,this._moveNumber].join(" ")}_updateSetup(e){this._history.length>0||(e!==O?(this._header.SetUp="1",this._header.FEN=e):(delete this._header.SetUp,delete this._header.FEN))}reset(){this.load(O)}get(e){return this._board[d[e]]||!1}put({type:e,color:t},s){return this._put({type:e,color:t},s)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_put({type:e,color:t},s){if(Ee.indexOf(e.toLowerCase())===-1||!(s in d))return!1;let r=d[s];if(e==E&&!(this._kings[t]==-1||this._kings[t]==r))return!1;let i=this._board[r];return i&&i.type===E&&(this._kings[i.color]=-1),this._board[r]={type:e,color:t},e===E&&(this._kings[t]=r),!0}remove(e){let t=this.get(e);return delete this._board[d[e]],t&&t.type===E&&(this._kings[t.color]=-1),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),t}_updateCastlingRights(){var s,r,i,n,o,c,h,p,g,l,b,f;let e=((s=this._board[d.e1])==null?void 0:s.type)===E&&((r=this._board[d.e1])==null?void 0:r.color)===C,t=((i=this._board[d.e8])==null?void 0:i.type)===E&&((n=this._board[d.e8])==null?void 0:n.color)===x;(!e||((o=this._board[d.a1])==null?void 0:o.type)!==D||((c=this._board[d.a1])==null?void 0:c.color)!==C)&&(this._castling.w&=~u.QSIDE_CASTLE),(!e||((h=this._board[d.h1])==null?void 0:h.type)!==D||((p=this._board[d.h1])==null?void 0:p.color)!==C)&&(this._castling.w&=~u.KSIDE_CASTLE),(!t||((g=this._board[d.a8])==null?void 0:g.type)!==D||((l=this._board[d.a8])==null?void 0:l.color)!==x)&&(this._castling.b&=~u.QSIDE_CASTLE),(!t||((b=this._board[d.h8])==null?void 0:b.type)!==D||((f=this._board[d.h8])==null?void 0:f.color)!==x)&&(this._castling.b&=~u.KSIDE_CASTLE)}_updateEnPassantSquare(){var i,n;if(this._epSquare===-1)return;let e=this._epSquare+(this._turn===C?-16:16),t=this._epSquare+(this._turn===C?16:-16),s=[t+1,t-1];if(this._board[e]!==null||this._board[this._epSquare]!==null||((i=this._board[t])==null?void 0:i.color)!==K(this._turn)||((n=this._board[t])==null?void 0:n.type)!==v){this._epSquare=-1;return}let r=o=>{var c,h;return!(o&136)&&((c=this._board[o])==null?void 0:c.color)===this._turn&&((h=this._board[o])==null?void 0:h.type)===v};s.some(r)||(this._epSquare=-1)}_attacked(e,t){for(let s=d.a8;s<=d.h1;s++){if(s&136){s+=7;continue}if(this._board[s]===void 0||this._board[s].color!==e)continue;let r=this._board[s],i=s-t;if(i===0)continue;let n=i+119;if(me[n]&Se[r.type]){if(r.type===v){if(i>0){if(r.color===C)return!0}else if(r.color===x)return!0;continue}if(r.type==="n"||r.type==="k")return!0;let o=be[n],c=s+o,h=!1;for(;c!==t;){if(this._board[c]!=null){h=!0;break}c+=o}if(!h)return!0}}return!1}_isKingAttacked(e){let t=this._kings[e];return t===-1?!1:this._attacked(K(e),t)}isAttacked(e,t){return this._attacked(t,d[e])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){let e={b:0,n:0,r:0,q:0,k:0,p:0},t=[],s=0,r=0;for(let i=d.a8;i<=d.h1;i++){if(r=(r+1)%2,i&136){i+=7;continue}let n=this._board[i];n&&(e[n.type]=n.type in e?e[n.type]+1:1,n.type===j&&t.push(r),s++)}if(s===2)return!0;if(s===3&&(e[j]===1||e[W]===1))return!0;if(s===e[j]+2){let i=0,n=t.length;for(let o=0;o<n;o++)i+=t[o];if(i===0||i===n)return!0}return!1}_getRepetitionCount(){return this._positionCounts[this.fen()]}isThreefoldRepetition(){return this._getRepetitionCount()>=3}isDraw(){return this._halfMoves>=100||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isStalemate()||this.isDraw()}moves({verbose:e=!1,square:t=void 0,piece:s=void 0}={}){let r=this._moves({square:t,piece:s});return e?r.map(i=>this._makePretty(i)):r.map(i=>this._moveToSan(i,r))}_moves({legal:e=!0,piece:t=void 0,square:s=void 0}={}){var b;let r=s?s.toLowerCase():void 0,i=t==null?void 0:t.toLowerCase(),n=[],o=this._turn,c=K(o),h=d.a8,p=d.h1,g=!1;if(r)if(r in d)h=p=d[r],g=!0;else return[];for(let f=h;f<=p;f++){if(f&136){f+=7;continue}if(!this._board[f]||this._board[f].color===c)continue;let{type:m}=this._board[f],S;if(m===v){if(i&&i!==m)continue;S=f+G[o][0],this._board[S]||(q(n,o,f,S,v),S=f+G[o][1],Pe[o]===F(f)&&!this._board[S]&&q(n,o,f,S,v,void 0,u.BIG_PAWN));for(let y=2;y<4;y++)S=f+G[o][y],!(S&136)&&(((b=this._board[S])==null?void 0:b.color)===c?q(n,o,f,S,v,this._board[S].type,u.CAPTURE):S===this._epSquare&&q(n,o,f,S,v,v,u.EP_CAPTURE))}else{if(i&&i!==m)continue;for(let y=0,M=V[m].length;y<M;y++){let _=V[m][y];for(S=f;S+=_,!(S&136);){if(!this._board[S])q(n,o,f,S,m);else{if(this._board[S].color===o)break;q(n,o,f,S,m,this._board[S].type,u.CAPTURE);break}if(m===W||m===E)break}}}}if((i===void 0||i===E)&&(!g||p===this._kings[o])){if(this._castling[o]&u.KSIDE_CASTLE){let f=this._kings[o],m=f+2;!this._board[f+1]&&!this._board[m]&&!this._attacked(c,this._kings[o])&&!this._attacked(c,f+1)&&!this._attacked(c,m)&&q(n,o,this._kings[o],m,E,void 0,u.KSIDE_CASTLE)}if(this._castling[o]&u.QSIDE_CASTLE){let f=this._kings[o],m=f-2;!this._board[f-1]&&!this._board[f-2]&&!this._board[f-3]&&!this._attacked(c,this._kings[o])&&!this._attacked(c,f-1)&&!this._attacked(c,m)&&q(n,o,this._kings[o],m,E,void 0,u.QSIDE_CASTLE)}}if(!e||this._kings[o]===-1)return n;let l=[];for(let f=0,m=n.length;f<m;f++)this._makeMove(n[f]),this._isKingAttacked(o)||l.push(n[f]),this._undoMove();return l}move(e,{strict:t=!1}={}){let s=null;if(typeof e=="string")s=this._moveFromSan(e,t);else if(typeof e=="object"){let i=this._moves();for(let n=0,o=i.length;n<o;n++)if(e.from===P(i[n].from)&&e.to===P(i[n].to)&&(!("promotion"in i[n])||e.promotion===i[n].promotion)){s=i[n];break}}if(!s)throw typeof e=="string"?new Error("Invalid move: ".concat(e)):new Error("Invalid move: ".concat(JSON.stringify(e)));let r=this._makePretty(s);return this._makeMove(s),this._positionCounts[r.after]++,r}_push(e){this._history.push({move:e,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_makeMove(e){let t=this._turn,s=K(t);if(this._push(e),this._board[e.to]=this._board[e.from],delete this._board[e.from],e.flags&u.EP_CAPTURE&&(this._turn===x?delete this._board[e.to-16]:delete this._board[e.to+16]),e.promotion&&(this._board[e.to]={type:e.promotion,color:t}),this._board[e.to].type===E){if(this._kings[t]=e.to,e.flags&u.KSIDE_CASTLE){let r=e.to-1,i=e.to+1;this._board[r]=this._board[i],delete this._board[i]}else if(e.flags&u.QSIDE_CASTLE){let r=e.to+1,i=e.to-2;this._board[r]=this._board[i],delete this._board[i]}this._castling[t]=0}if(this._castling[t]){for(let r=0,i=A[t].length;r<i;r++)if(e.from===A[t][r].square&&this._castling[t]&A[t][r].flag){this._castling[t]^=A[t][r].flag;break}}if(this._castling[s]){for(let r=0,i=A[s].length;r<i;r++)if(e.to===A[s][r].square&&this._castling[s]&A[s][r].flag){this._castling[s]^=A[s][r].flag;break}}e.flags&u.BIG_PAWN?t===x?this._epSquare=e.to-16:this._epSquare=e.to+16:this._epSquare=-1,e.piece===v?this._halfMoves=0:e.flags&(u.CAPTURE|u.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,t===x&&this._moveNumber++,this._turn=s}undo(){let e=this._undoMove();if(e){let t=this._makePretty(e);return this._positionCounts[t.after]--,t}return null}_undoMove(){let e=this._history.pop();if(e===void 0)return null;let t=e.move;this._kings=e.kings,this._turn=e.turn,this._castling=e.castling,this._epSquare=e.epSquare,this._halfMoves=e.halfMoves,this._moveNumber=e.moveNumber;let s=this._turn,r=K(s);if(this._board[t.from]=this._board[t.to],this._board[t.from].type=t.piece,delete this._board[t.to],t.captured)if(t.flags&u.EP_CAPTURE){let i;s===x?i=t.to-16:i=t.to+16,this._board[i]={type:v,color:r}}else this._board[t.to]={type:t.captured,color:r};if(t.flags&(u.KSIDE_CASTLE|u.QSIDE_CASTLE)){let i,n;t.flags&u.KSIDE_CASTLE?(i=t.to+1,n=t.to-1):(i=t.to-2,n=t.to+1),this._board[i]=this._board[n],delete this._board[n]}return t}pgn({newline:e="\n",maxWidth:t=0}={}){let s=[],r=!1;for(let l in this._header)s.push("["+l+' "'+this._header[l]+'"]'+e),r=!0;r&&this._history.length&&s.push(e);let i=l=>{let b=this._comments[this.fen()];if(typeof b<"u"){let f=l.length>0?" ":"";l="".concat(l).concat(f,"{").concat(b,"}")}return l},n=[];for(;this._history.length>0;)n.push(this._undoMove());let o=[],c="";for(n.length===0&&o.push(i(""));n.length>0;){c=i(c);let l=n.pop();if(!l)break;if(!this._history.length&&l.color==="b"){let b="".concat(this._moveNumber,". ...");c=c?"".concat(c," ").concat(b):b}else l.color==="w"&&(c.length&&o.push(c),c=this._moveNumber+".");c=c+" "+this._moveToSan(l,this._moves({legal:!0})),this._makeMove(l)}if(c.length&&o.push(i(c)),typeof this._header.Result<"u"&&o.push(this._header.Result),t===0)return s.join("")+o.join(" ");let h=function(){return s.length>0&&s[s.length-1]===" "?(s.pop(),!0):!1},p=function(l,b){for(let f of b.split(" "))if(f){if(l+f.length>t){for(;h();)l--;s.push(e),l=0}s.push(f),l+=f.length,s.push(" "),l++}return h()&&l--,l},g=0;for(let l=0;l<o.length;l++){if(g+o[l].length>t&&o[l].includes("{")){g=p(g,o[l]);continue}g+o[l].length>t&&l!==0?(s[s.length-1]===" "&&s.pop(),s.push(e),g=0):l!==0&&(s.push(" "),g++),s.push(o[l]),g+=o[l].length}return s.join("")}header(...e){for(let t=0;t<e.length;t+=2)typeof e[t]=="string"&&typeof e[t+1]=="string"&&(this._header[e[t]]=e[t+1]);return this._header}loadPgn(e,{strict:t=!1,newlineChar:s="\r?\n"}={}){function r(_){return _.replace(/\\/g,"\\")}function i(_){let N={},w=_.split(new RegExp(r(s))),Y="",J="";for(let Q=0;Q<w.length;Q++){let Z=/^\s*\[\s*([A-Za-z]+)\s*"(.*)"\s*\]\s*$/;Y=w[Q].replace(Z,"$1"),J=w[Q].replace(Z,"$2"),Y.trim().length>0&&(N[Y]=J)}return N}e=e.trim();let o=new RegExp("^(\\[((?:"+r(s)+")|.)*\\])((?:\\s*"+r(s)+"){2}|(?:\\s*"+r(s)+")*$)").exec(e),c=o&&o.length>=2?o[1]:"";this.reset();let h=i(c),p="";for(let _ in h)_.toLowerCase()==="fen"&&(p=h[_]),this.header(_,h[_]);if(!t)p&&this.load(p,{preserveHeaders:!0});else if(h.SetUp==="1"){if(!("FEN"in h))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(h.FEN,{preserveHeaders:!0})}function g(_){return Array.from(_).map(function(N){return N.charCodeAt(0)<128?N.charCodeAt(0).toString(16):encodeURIComponent(N).replace(/%/g,"").toLowerCase()}).join("")}function l(_){return _.length==0?"":decodeURIComponent("%"+(_.match(/.{1,2}/g)||[]).join("%"))}let b=function(_){return _=_.replace(new RegExp(r(s),"g")," "),"{".concat(g(_.slice(1,_.length-1)),"}")},f=function(_){if(_.startsWith("{")&&_.endsWith("}"))return l(_.slice(1,_.length-1))},m=e.replace(c,"").replace(new RegExp("({[^}]*})+?|;([^".concat(r(s),"]*)"),"g"),function(_,N,w){return N!==void 0?b(N):" "+b("{".concat(w.slice(1),"}"))}).replace(new RegExp(r(s),"g")," "),S=/(\([^()]+\))+?/g;for(;S.test(m);)m=m.replace(S,"");m=m.replace(/\d+\.(\.\.)?/g,""),m=m.replace(/\.\.\./g,""),m=m.replace(/\$\d+/g,"");let y=m.trim().split(new RegExp(/\s+/));y=y.filter(_=>_!=="");let M="";for(let _=0;_<y.length;_++){let N=f(y[_]);if(N!==void 0){this._comments[this.fen()]=N;continue}let w=this._moveFromSan(y[_],t);if(w==null)if(Ne.indexOf(y[_])>-1)M=y[_];else throw new Error("Invalid move in PGN: ".concat(y[_]));else M="",this._makeMove(w),this._positionCounts[this.fen()]++}M&&Object.keys(this._header).length&&!this._header.Result&&this.header("Result",M)}_moveToSan(e,t){let s="";if(e.flags&u.KSIDE_CASTLE)s="O-O";else if(e.flags&u.QSIDE_CASTLE)s="O-O-O";else{if(e.piece!==v){let r=we(e,t);s+=e.piece.toUpperCase()+r}e.flags&(u.CAPTURE|u.EP_CAPTURE)&&(e.piece===v&&(s+=P(e.from)[0]),s+="x"),s+=P(e.to),e.promotion&&(s+="="+e.promotion.toUpperCase())}return this._makeMove(e),this.isCheck()&&(this.isCheckmate()?s+="#":s+="+"),this._undoMove(),s}_moveFromSan(e,t=!1){let s=H(e),r=te(s),i=this._moves({legal:!0,piece:r});for(let l=0,b=i.length;l<b;l++)if(s===H(this._moveToSan(i[l],i)))return i[l];if(t)return null;let n,o,c,h,p,g=!1;if(o=s.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),o?(n=o[1],c=o[2],h=o[3],p=o[4],c.length==1&&(g=!0)):(o=s.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),o&&(n=o[1],c=o[2],h=o[3],p=o[4],c.length==1&&(g=!0))),r=te(s),i=this._moves({legal:!0,piece:n||r}),!h)return null;for(let l=0,b=i.length;l<b;l++)if(c){if((!n||n.toLowerCase()==i[l].piece)&&d[c]==i[l].from&&d[h]==i[l].to&&(!p||p.toLowerCase()==i[l].promotion))return i[l];if(g){let f=P(i[l].from);if((!n||n.toLowerCase()==i[l].piece)&&d[h]==i[l].to&&(c==f[0]||c==f[1])&&(!p||p.toLowerCase()==i[l].promotion))return i[l]}}else if(s===H(this._moveToSan(i[l],i)).replace("x",""))return i[l];return null}ascii(){let e="   +------------------------+\n";for(let t=d.a8;t<=d.h1;t++){if(T(t)===0&&(e+=" "+"87654321"[F(t)]+" |"),this._board[t]){let s=this._board[t].type,i=this._board[t].color===C?s.toUpperCase():s.toLowerCase();e+=" "+i+" "}else e+=" . ";t+1&136&&(e+="|\n",t+=8)}return e+="   +------------------------+\n",e+="     a  b  c  d  e  f  g  h",e}perft(e){let t=this._moves({legal:!1}),s=0,r=this._turn;for(let i=0,n=t.length;i<n;i++)this._makeMove(t[i]),this._isKingAttacked(r)||(e-1>0?s+=this.perft(e-1):s++),this._undoMove();return s}_makePretty(e){let{color:t,piece:s,from:r,to:i,flags:n,captured:o,promotion:c}=e,h="";for(let b in u)u[b]&n&&(h+=ge[b]);let p=P(r),g=P(i),l={color:t,piece:s,from:p,to:g,san:this._moveToSan(e,this._moves({legal:!0})),flags:h,lan:p+g,before:this.fen(),after:""};return this._makeMove(e),l.after=this.fen(),this._undoMove(),o&&(l.captured=o),c&&(l.promotion=c,l.lan+=c),l}turn(){return this._turn}board(){let e=[],t=[];for(let s=d.a8;s<=d.h1;s++)this._board[s]==null?t.push(null):t.push({square:P(s),type:this._board[s].type,color:this._board[s].color}),s+1&136&&(e.push(t),t=[],s+=8);return e}squareColor(e){if(e in d){let t=d[e];return(F(t)+T(t))%2===0?"light":"dark"}return null}history({verbose:e=!1}={}){let t=[],s=[];for(;this._history.length>0;)t.push(this._undoMove());for(;;){let r=t.pop();if(!r)break;e?s.push(this._makePretty(r)):s.push(this._moveToSan(r,this._moves())),this._makeMove(r)}return s}_pruneComments(){let e=[],t={},s=r=>{r in this._comments&&(t[r]=this._comments[r])};for(;this._history.length>0;)e.push(this._undoMove());for(s(this.fen());;){let r=e.pop();if(!r)break;this._makeMove(r),s(this.fen())}this._comments=t}getComment(){return this._comments[this.fen()]}setComment(e){this._comments[this.fen()]=e.replace("{","[").replace("}","]")}deleteComment(){let e=this._comments[this.fen()];return delete this._comments[this.fen()],e}getComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>({fen:e,comment:this._comments[e]}))}deleteComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>{let t=this._comments[e];return delete this._comments[e],{fen:e,comment:t}})}setCastlingRights(e,t){for(let r of[E,I])t[r]!==void 0&&(t[r]?this._castling[e]|=B[r]:this._castling[e]&=~B[r]);this._updateCastlingRights();let s=this.getCastlingRights(e);return(t[E]===void 0||t[E]===s[E])&&(t[I]===void 0||t[I]===s[I])}getCastlingRights(e){return{[E]:(this._castling[e]&B[E])!==0,[I]:(this._castling[e]&B[I])!==0}}moveNumber(){return this._moveNumber}};var Ae=["1-0","0-1","1/2-1/2","*"];function ie(a){a=qe(a).replace(/\{[^}]*\}/g,"").replace(/;.+$/gm,"").replace(/\b(-?\d+)\./g,"$1 .").replace(/\.+/g,n=>n.length>2?"... ":"").replace(/\s+/g," ").trim();let e=a.split(" ").filter(n=>!n.match(/^\$\d+$/)),t=e[e.length-1];t&&Ae.includes(t)&&e.pop(),e[0]=="..."&&e.shift();let s=[],r,i=0;for(let n=0;n<e.length;n++){let o=e[n];if(X(o))r!=o?(r=o,i=0):e[n+1]=="..."&&n++;else if(o=="...")s.length>0&&(X(e[n-1])||X(e[n+1]))&&(s.push(o),i++);else if(i<2)s.push(o),i++;else break}return s}function X(a){return/^-?\d+$/.test(a)}function qe(a){for(;;){let e=a.replace(/\([^()]*\)/g,"");if(e==a)return a;a=e}}function R(a,...e){let t=a.split(" ");for(let s of e)s(t);return t.join(" ")}var U=a=>{a[1]=a[1]=="b"?"w":"b",a[3]="-"},ne=a=>{a[1]=="w"&&(a[5]=Number(a[5])+1)},ae=a=>{a[4]=0,a[5]=1};var Ie=16;function le(a,e){var f;if(!a)return null;let{from:t,to:s,unpromote:r}=a;if(e.get(s))return null;let i=a.uncapture=="c",n=i?"p":a.uncapture,o=(f=e.get(t))==null?void 0:f.type;if(!Re(o,i,r)||!Oe(e.state.history[e.state.moveNumber],t,s))return null;let c=e.turn()=="b",h=e.getCastlingRights(c?"w":"b");if(!Fe(o,h,c,t))return null;let p=R(e.fen(),U),g=new L(p),l=g.remove(t),b=t[1];return r&&(l.type="p"),l.type=="p"&&(c&&b=="2"||!c&&b=="7")||!g.put(l,s)?null:{type:o,ep:i,uncapture:n,unpromote:r,isWhite:c,temp:g,piece:l,rank:b,from:t,to:s}}function Re(a,e,t){return!(!a||e&&a!="p"||t&&(a=="p"||a=="k"))}function Oe(a,e,t){if(a&&a.flags=="e"){let s=a.to.replace("3","4").replace("6","5"),r=a.to.replace("3","2").replace("6","7");if(e!=s||t!=r)return!1}return!0}function Fe(a,e,t,s){return!(a=="k"&&(e.k||e.q)||a=="r"&&s==(t?"a1":"a8")&&e.q||a=="r"&&s==(t?"h1":"h8")&&e.k)}function he(a,e){let{isWhite:t,uncapture:s,rank:r,ep:i,from:n,temp:o}=a,c=t?"b":"w";if(s=="p"&&(r=="1"||r=="8"))return console.log("Cannot uncapture a pawn at the 1st or the 8th rank."),!1;if(e.board().flat().filter(g=>g&&g.color==c).length>=Ie)return console.log("Too many uncapturing."),!1;let h={type:s,color:c},p=i?Le(n):n;if(i&&r!=(t?"6":"3")||i&&o.get(p)||!o.put(h,p))return!1;if(i){let g=R(o.fen(),l=>l[3]=n);o.load(g)}return!0}function Le(a){return a.replace("3","4").replace("6","5")}function fe(a){let{isWhite:e,piece:t,from:s,to:r,temp:i}=a;if(t.type=="k"&&(e&&r=="e1"||!e&&r=="e8")){let n=r[1];if(s=="g"+n){if(!ce(i,"f"+n,"h"+n))return!1;i.setCastlingRights(t.color,{k:!0})}if(s=="c"+n){if(!ce(i,"d"+n,"a"+n))return!1;i.setCastlingRights(t.color,{q:!0})}}return!0}function ce(a,e,t){if(a.get(t))return!1;let s=a.remove(e);return s?(a.put(s,t),!0):!1}function ue(a){let{type:e,unpromote:t,from:s,to:r,temp:i}=a,o=i.moves({verbose:!0}).find(h=>h.from==r&&h.to==s&&(!t||h.promotion==e));return o?z(o.before).isCheck()?(console.log("must retract checking"),null):o:null}function z(a){return new L(R(a,U))}var Me=(s=>(s[s.notYet=0]="notYet",s[s.checkmate=1]="checkmate",s[s.draw=2]="draw",s))(Me||{}),$=class extends L{constructor(t={}){super();k(this,"state");this.state=t,this.state.history=this.state.history||[]}checkPromotion(t,s){return this.moves({verbose:!0}).some(i=>i.from==t&&i.to==s&&i.flags.includes("p"))}switchSide(){this.load(R(this.fen(),U))}init(t){try{this.state.initFEN=t,this.state.history.length=0,this.state.moveNumber=-1,this.load(t);let s=this.board(),r=n=>n.some(o=>o&&o.type=="p");if(r(s[0])||r(s[7]))throw new Error("pawns cannot be on the 1st or the 8th rank");let i=z(t);if(i.isCheck()){if(this.isCheck())throw new Error("both kings are under checks");this.state.initFEN=i.fen(),this.load(this.state.initFEN)}}catch(s){if(s instanceof Error){let r=s.message.replace(/^.+:/,"").trim().replace(/[^.]$/,"$&.");throw new Error("The position is not playable: "+r)}}}retract(t){let s=le(t,this);if(!s||s.uncapture&&!he(s,this)||!fe(s))return!1;let r=ue(s);if(!r)return!1;this.state.moveNumber>=0&&(r.before=R(r.before,ne)),this.load(r.before);let i=this.state;return i.history.length=i.moveNumber+1,i.history.push(r),i.moveNumber++,!0}move(t){let s=this.state,r=this.fen(),i=s.history.concat();try{let n=super.move(t);this.isDraw()&&(n.san+="="),s.history.length=s.moveNumber+1;let o=s.history[s.history.length-1];return s.mode=="pass"&&o&&n.color==o.color&&n.color=="w"&&(n.before=n.before.replace(/\d+$/,c=>(Number(c)+1).toString()),n.after=n.after.replace(/\d+$/,c=>(Number(c)+1).toString())),this.load(n.after),s.over=this.overState(),s.history.push(n),s.moveNumber++,n}catch(n){throw s.history=i,this.load(r),n}}addMoves(t){if(!t||t.length==0)return;let s=this.state.mode=="retro"?this.addRetroMoves(t):this.addNormalMoves(t);if(s)throw new Error("Something went wrong in the move: "+s)}addRetroMoves(t){for(let s of t){if(s=="...")continue;let r=Be(s);if(!r||!this.retract(r))return s}}addNormalMoves(t){let s=!1,r=this.state.mode=="pass";for(let i of t)if(i=="...")r&&this.switchSide();else if(this.move(i))s=!0;else{if(!s&&r&&(this.switchSide(),this.move(i)))continue;return i}}overState(){return this.isCheckmate()?1:this.isDraw()?2:0}copyGame(t,s){let r=s?s.concat(this.state.history):this.state.history;return Ke(r,t)}copyPGN(t){let s="";if(this.state.mode=="retro"){let r=this.state.history,i=r.length-1,n=r.length>0?r[i].before:this.state.initFEN,o=R(n,ae);o!=O&&(s+='[SetUp "1"]\n[FEN "'.concat(o,'"]\n\n'));let c=1;for(let h=i;h>=0;h--)(r[h].color=="w"||h==i)&&(s+=c+++". ",h==i&&r[h].color=="b"&&(s+="... ")),s+=r[h].san+" "}else{let r=t&&t.length?t[0].before:this.state.initFEN;r!=O&&(s+='[SetUp "1"]\n[FEN "'.concat(r,'"]\n\n')),s+=this.copyGame({},t)}return s}loadGame(t){let s=t.match(/\[fen "([^"]+)"\]/i),r=s?s[1]:O;this.init(r),t=t.replace(/\[[^\]]+\]/g,"").trim();let i=ie(t);this.state.mode=i.includes("...")?"pass":"normal",this.addMoves(i),this.state.over=this.overState(),this.goto()}goto(t){let s=this.getFenOf(t);return this.load(s),this.state.moveNumber=t?this.state.history.indexOf(t):-1,s}getFenOf(t){return t?this.state.mode=="retro"?t.before:t.after:this.state.initFEN}};k($,"options");function Ke(a,e){if(a.length==0)return"";let t="";a[0].color=="b"&&(t+=a[0].before.split(" ")[5]+"... ");for(let[s,r]of a.entries())a[s-1]&&a[s-1].color==r.color&&(r.color=="w"?t+="... ":t+=de(r)+"... "),r.color=="w"&&(t+=de(r)+". "),t+=De(r,void 0,e)+" ";return t.trimEnd()}function de(a,e,t=$.options){if(!a)return"";let s=a.before.match(/\d+$/)[0];return(e=="retro"&&t.negative?"-":"")+s}function De(a,e,t=$.options){if(!a)return"";let s=e=="retro",r=s?Ue(a):a.san,i=Te(t.symbol);if(i)for(let[n,o]of Object.entries(i))r=r.replace(n,o);return(s||t.ep)&&a.flags.includes("e")&&(r=r.replace(/([+#=]?)$/,"ep$1")),t.zero&&(r=r.replace("O-O-O","0-0-0").replace("O-O","0-0")),a.annotation&&(r+=a.annotation),r}function Te(a){return a=="unicode"?$e:a=="german"?Qe:null}function Ue(a){if(a.flags=="k"||a.flags=="q")return a.san;let e=a.piece.toUpperCase(),t=a.captured?a.captured.toUpperCase():"",s=a.san.match(/[+#=]$/),r=s?s[0]:"";return(e=="P"?"":e)+a.from+(a.captured?"x"+t:"-")+a.to+(a.promotion?"="+a.promotion.toUpperCase():"")+r}var $e={K:"\u2654",Q:"\u2655",B:"\u2657",N:"\u2658",R:"\u2656",P:"\u2659"},Qe={K:"K",Q:"D",B:"L",N:"S",R:"T",P:"B"};function Be(a){let e=a.match(/^\w?([a-h][1-8])[-x](\w?)([a-h][1-8])(ep)?(?:=(\w))?/);if(!e)return null;let t;return e[4]?t="c":e[2]&&(t=e[2].toLowerCase()),{from:e[3],to:e[1],uncapture:t,unpromote:!!e[5]}}export{$ as Chess,De as format,Ke as formatGame,de as number,Me as overState,ie as parseMoves};
//# sourceMappingURL=chess.js.map
