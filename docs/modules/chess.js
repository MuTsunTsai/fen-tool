var pe=Object.defineProperty;var de=(o,e,t)=>e in o?pe(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var T=(o,e,t)=>(de(o,typeof e!="symbol"?e+"":e,t),t);var C="w",w="b",k="p",W="n",j="b",K="r",x="q",S="k",M="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";var _e={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"};var u={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},p={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},G={b:[16,32,17,15],w:[-16,-32,-17,-15]},V={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},me=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],ge=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],be={p:1,n:2,b:4,r:8,q:16,k:32},Ee="pnbrqkPNBRQK",ee=[W,j,K,x],Se=7,ke=6,ve=1,Ce=0,Q={[S]:u.KSIDE_CASTLE,[x]:u.QSIDE_CASTLE},A={w:[{square:p.a1,flag:u.QSIDE_CASTLE},{square:p.h1,flag:u.KSIDE_CASTLE}],b:[{square:p.a8,flag:u.QSIDE_CASTLE},{square:p.h8,flag:u.KSIDE_CASTLE}]},ye={b:ve,w:ke},Ne=["1-0","0-1","1/2-1/2","*"];function q(o){return o>>4}function D(o){return o&15}function ie(o){return"0123456789".indexOf(o)!==-1}function y(o){let e=D(o),t=q(o);return"abcdefgh".substring(e,e+1)+"87654321".substring(t,t+1)}function F(o){return o===C?w:C}function Te(o){let e=o.split(/\s+/);if(e.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};let t=parseInt(e[5],10);if(isNaN(t)||t<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};let s=parseInt(e[4],10);if(isNaN(s)||s<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(e[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(e[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(e[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};let i=e[0].split("/");if(i.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let a=0;a<i.length;a++){let n=0,l=!1;for(let c=0;c<i[a].length;c++)if(ie(i[a][c])){if(l)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};n+=parseInt(i[a][c],10),l=!0}else{if(!/^[prnbqkPRNBQK]$/.test(i[a][c]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};n+=1,l=!1}if(n!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(e[3][1]=="3"&&e[1]=="w"||e[3][1]=="6"&&e[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};let r=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(let{color:a,regex:n}of r){if(!n.test(e[0]))return{ok:!1,error:"Invalid FEN: missing ".concat(a," king")};if((e[0].match(n)||[]).length>1)return{ok:!1,error:"Invalid FEN: too many ".concat(a," kings")}}return Array.from(i[0]+i[7]).some(a=>a.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function we(o,e){let t=o.from,s=o.to,i=o.piece,r=0,a=0,n=0;for(let l=0,c=e.length;l<c;l++){let _=e[l].from,m=e[l].to,h=e[l].piece;i===h&&t!==_&&s===m&&(r++,q(t)===q(_)&&a++,D(t)===D(_)&&n++)}return r>0?a>0&&n>0?y(t):n>0?y(t).charAt(1):y(t).charAt(0):""}function I(o,e,t,s,i,r=void 0,a=u.NORMAL){let n=q(s);if(i===k&&(n===Se||n===Ce))for(let l=0;l<ee.length;l++){let c=ee[l];o.push({color:e,from:t,to:s,piece:i,captured:r,promotion:c,flags:a|u.PROMOTION})}else o.push({color:e,from:t,to:s,piece:i,captured:r,flags:a})}function te(o){let e=o.charAt(0);return e>="a"&&e<="h"?o.match(/[a-h]\d.*[a-h]\d/)?void 0:k:(e=e.toLowerCase(),e==="o"?S:e)}function H(o){return o.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function se(o){return o.split(" ").slice(0,4).join(" ")}var O=class{constructor(e=M){T(this,"_board",new Array(128));T(this,"_turn",C);T(this,"_header",{});T(this,"_kings",{w:-1,b:-1});T(this,"_epSquare",-1);T(this,"_halfMoves",0);T(this,"_moveNumber",0);T(this,"_history",[]);T(this,"_comments",{});T(this,"_castling",{w:0,b:0});T(this,"_positionCounts",{});this.load(e)}clear({preserveHeaders:e=!1}={}){this._board=new Array(128),this._kings={w:-1,b:-1},this._turn=C,this._castling={w:0,b:0},this._epSquare=-1,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=e?this._header:{},delete this._header.SetUp,delete this._header.FEN,this._positionCounts=new Proxy({},{get:(t,s)=>s==="length"?Object.keys(t).length:(t==null?void 0:t[se(s)])||0,set:(t,s,i)=>{let r=se(s);return i===0?delete t[r]:t[r]=i,!0}})}removeHeader(e){e in this._header&&delete this._header[e]}load(e,{skipValidation:t=!1,preserveHeaders:s=!1}={}){let i=e.split(/\s+/);if(i.length>=2&&i.length<6){let n=["-","-","0","1"];e=i.concat(n.slice(-(6-i.length))).join(" ")}if(i=e.split(/\s+/),!t){let{ok:n,error:l}=Te(e);if(!n)throw new Error(l)}let r=i[0],a=0;this.clear({preserveHeaders:s});for(let n=0;n<r.length;n++){let l=r.charAt(n);if(l==="/")a+=8;else if(ie(l))a+=parseInt(l,10);else{let c=l<"a"?C:w;this._put({type:l.toLowerCase(),color:c},y(a)),a++}}this._turn=i[1],i[2].indexOf("K")>-1&&(this._castling.w|=u.KSIDE_CASTLE),i[2].indexOf("Q")>-1&&(this._castling.w|=u.QSIDE_CASTLE),i[2].indexOf("k")>-1&&(this._castling.b|=u.KSIDE_CASTLE),i[2].indexOf("q")>-1&&(this._castling.b|=u.QSIDE_CASTLE),this._epSquare=i[3]==="-"?-1:p[i[3]],this._halfMoves=parseInt(i[4],10),this._moveNumber=parseInt(i[5],10),this._updateSetup(e),this._positionCounts[e]++}fen(){var r,a;let e=0,t="";for(let n=p.a8;n<=p.h1;n++){if(this._board[n]){e>0&&(t+=e,e=0);let{color:l,type:c}=this._board[n];t+=l===C?c.toUpperCase():c.toLowerCase()}else e++;n+1&136&&(e>0&&(t+=e),n!==p.h1&&(t+="/"),e=0,n+=8)}let s="";this._castling[C]&u.KSIDE_CASTLE&&(s+="K"),this._castling[C]&u.QSIDE_CASTLE&&(s+="Q"),this._castling[w]&u.KSIDE_CASTLE&&(s+="k"),this._castling[w]&u.QSIDE_CASTLE&&(s+="q"),s=s||"-";let i="-";if(this._epSquare!==-1){let n=this._epSquare+(this._turn===C?16:-16),l=[n+1,n-1];for(let c of l){if(c&136)continue;let _=this._turn;if(((r=this._board[c])==null?void 0:r.color)===_&&((a=this._board[c])==null?void 0:a.type)===k){this._makeMove({color:_,from:c,to:this._epSquare,piece:k,captured:k,flags:u.EP_CAPTURE});let m=!this._isKingAttacked(_);if(this._undoMove(),m){i=y(this._epSquare);break}}}}return[t,this._turn,s,i,this._halfMoves,this._moveNumber].join(" ")}_updateSetup(e){this._history.length>0||(e!==M?(this._header.SetUp="1",this._header.FEN=e):(delete this._header.SetUp,delete this._header.FEN))}reset(){this.load(M)}get(e){return this._board[p[e]]||!1}put({type:e,color:t},s){return this._put({type:e,color:t},s)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_put({type:e,color:t},s){if(Ee.indexOf(e.toLowerCase())===-1||!(s in p))return!1;let i=p[s];if(e==S&&!(this._kings[t]==-1||this._kings[t]==i))return!1;let r=this._board[i];return r&&r.type===S&&(this._kings[r.color]=-1),this._board[i]={type:e,color:t},e===S&&(this._kings[t]=i),!0}remove(e){let t=this.get(e);return delete this._board[p[e]],t&&t.type===S&&(this._kings[t.color]=-1),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),t}_updateCastlingRights(){var s,i,r,a,n,l,c,_,m,h,b,f;let e=((s=this._board[p.e1])==null?void 0:s.type)===S&&((i=this._board[p.e1])==null?void 0:i.color)===C,t=((r=this._board[p.e8])==null?void 0:r.type)===S&&((a=this._board[p.e8])==null?void 0:a.color)===w;(!e||((n=this._board[p.a1])==null?void 0:n.type)!==K||((l=this._board[p.a1])==null?void 0:l.color)!==C)&&(this._castling.w&=~u.QSIDE_CASTLE),(!e||((c=this._board[p.h1])==null?void 0:c.type)!==K||((_=this._board[p.h1])==null?void 0:_.color)!==C)&&(this._castling.w&=~u.KSIDE_CASTLE),(!t||((m=this._board[p.a8])==null?void 0:m.type)!==K||((h=this._board[p.a8])==null?void 0:h.color)!==w)&&(this._castling.b&=~u.QSIDE_CASTLE),(!t||((b=this._board[p.h8])==null?void 0:b.type)!==K||((f=this._board[p.h8])==null?void 0:f.color)!==w)&&(this._castling.b&=~u.KSIDE_CASTLE)}_updateEnPassantSquare(){var r,a;if(this._epSquare===-1)return;let e=this._epSquare+(this._turn===C?-16:16),t=this._epSquare+(this._turn===C?16:-16),s=[t+1,t-1];if(this._board[e]!==null||this._board[this._epSquare]!==null||((r=this._board[t])==null?void 0:r.color)!==F(this._turn)||((a=this._board[t])==null?void 0:a.type)!==k){this._epSquare=-1;return}let i=n=>{var l,c;return!(n&136)&&((l=this._board[n])==null?void 0:l.color)===this._turn&&((c=this._board[n])==null?void 0:c.type)===k};s.some(i)||(this._epSquare=-1)}_attacked(e,t){for(let s=p.a8;s<=p.h1;s++){if(s&136){s+=7;continue}if(this._board[s]===void 0||this._board[s].color!==e)continue;let i=this._board[s],r=s-t;if(r===0)continue;let a=r+119;if(me[a]&be[i.type]){if(i.type===k){if(r>0){if(i.color===C)return!0}else if(i.color===w)return!0;continue}if(i.type==="n"||i.type==="k")return!0;let n=ge[a],l=s+n,c=!1;for(;l!==t;){if(this._board[l]!=null){c=!0;break}l+=n}if(!c)return!0}}return!1}_isKingAttacked(e){let t=this._kings[e];return t===-1?!1:this._attacked(F(e),t)}isAttacked(e,t){return this._attacked(t,p[e])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){let e={b:0,n:0,r:0,q:0,k:0,p:0},t=[],s=0,i=0;for(let r=p.a8;r<=p.h1;r++){if(i=(i+1)%2,r&136){r+=7;continue}let a=this._board[r];a&&(e[a.type]=a.type in e?e[a.type]+1:1,a.type===j&&t.push(i),s++)}if(s===2)return!0;if(s===3&&(e[j]===1||e[W]===1))return!0;if(s===e[j]+2){let r=0,a=t.length;for(let n=0;n<a;n++)r+=t[n];if(r===0||r===a)return!0}return!1}_getRepetitionCount(){return this._positionCounts[this.fen()]}isThreefoldRepetition(){return this._getRepetitionCount()>=3}isDraw(){return this._halfMoves>=100||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isStalemate()||this.isDraw()}moves({verbose:e=!1,square:t=void 0,piece:s=void 0}={}){let i=this._moves({square:t,piece:s});return e?i.map(r=>this._makePretty(r)):i.map(r=>this._moveToSan(r,i))}_moves({legal:e=!0,piece:t=void 0,square:s=void 0}={}){var b;let i=s?s.toLowerCase():void 0,r=t==null?void 0:t.toLowerCase(),a=[],n=this._turn,l=F(n),c=p.a8,_=p.h1,m=!1;if(i)if(i in p)c=_=p[i],m=!0;else return[];for(let f=c;f<=_;f++){if(f&136){f+=7;continue}if(!this._board[f]||this._board[f].color===l)continue;let{type:g}=this._board[f],E;if(g===k){if(r&&r!==g)continue;E=f+G[n][0],this._board[E]||(I(a,n,f,E,k),E=f+G[n][1],ye[n]===q(f)&&!this._board[E]&&I(a,n,f,E,k,void 0,u.BIG_PAWN));for(let v=2;v<4;v++)E=f+G[n][v],!(E&136)&&(((b=this._board[E])==null?void 0:b.color)===l?I(a,n,f,E,k,this._board[E].type,u.CAPTURE):E===this._epSquare&&I(a,n,f,E,k,k,u.EP_CAPTURE))}else{if(r&&r!==g)continue;for(let v=0,L=V[g].length;v<L;v++){let d=V[g][v];for(E=f;E+=d,!(E&136);){if(!this._board[E])I(a,n,f,E,g);else{if(this._board[E].color===n)break;I(a,n,f,E,g,this._board[E].type,u.CAPTURE);break}if(g===W||g===S)break}}}}if((r===void 0||r===S)&&(!m||_===this._kings[n])){if(this._castling[n]&u.KSIDE_CASTLE){let f=this._kings[n],g=f+2;!this._board[f+1]&&!this._board[g]&&!this._attacked(l,this._kings[n])&&!this._attacked(l,f+1)&&!this._attacked(l,g)&&I(a,n,this._kings[n],g,S,void 0,u.KSIDE_CASTLE)}if(this._castling[n]&u.QSIDE_CASTLE){let f=this._kings[n],g=f-2;!this._board[f-1]&&!this._board[f-2]&&!this._board[f-3]&&!this._attacked(l,this._kings[n])&&!this._attacked(l,f-1)&&!this._attacked(l,g)&&I(a,n,this._kings[n],g,S,void 0,u.QSIDE_CASTLE)}}if(!e||this._kings[n]===-1)return a;let h=[];for(let f=0,g=a.length;f<g;f++)this._makeMove(a[f]),this._isKingAttacked(n)||h.push(a[f]),this._undoMove();return h}move(e,{strict:t=!1}={}){let s=null;if(typeof e=="string")s=this._moveFromSan(e,t);else if(typeof e=="object"){let r=this._moves();for(let a=0,n=r.length;a<n;a++)if(e.from===y(r[a].from)&&e.to===y(r[a].to)&&(!("promotion"in r[a])||e.promotion===r[a].promotion)){s=r[a];break}}if(!s)throw typeof e=="string"?new Error("Invalid move: ".concat(e)):new Error("Invalid move: ".concat(JSON.stringify(e)));let i=this._makePretty(s);return this._makeMove(s),this._positionCounts[i.after]++,i}_push(e){this._history.push({move:e,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_makeMove(e){let t=this._turn,s=F(t);if(this._push(e),this._board[e.to]=this._board[e.from],delete this._board[e.from],e.flags&u.EP_CAPTURE&&(this._turn===w?delete this._board[e.to-16]:delete this._board[e.to+16]),e.promotion&&(this._board[e.to]={type:e.promotion,color:t}),this._board[e.to].type===S){if(this._kings[t]=e.to,e.flags&u.KSIDE_CASTLE){let i=e.to-1,r=e.to+1;this._board[i]=this._board[r],delete this._board[r]}else if(e.flags&u.QSIDE_CASTLE){let i=e.to+1,r=e.to-2;this._board[i]=this._board[r],delete this._board[r]}this._castling[t]=0}if(this._castling[t]){for(let i=0,r=A[t].length;i<r;i++)if(e.from===A[t][i].square&&this._castling[t]&A[t][i].flag){this._castling[t]^=A[t][i].flag;break}}if(this._castling[s]){for(let i=0,r=A[s].length;i<r;i++)if(e.to===A[s][i].square&&this._castling[s]&A[s][i].flag){this._castling[s]^=A[s][i].flag;break}}e.flags&u.BIG_PAWN?t===w?this._epSquare=e.to-16:this._epSquare=e.to+16:this._epSquare=-1,e.piece===k?this._halfMoves=0:e.flags&(u.CAPTURE|u.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,t===w&&this._moveNumber++,this._turn=s}undo(){let e=this._undoMove();if(e){let t=this._makePretty(e);return this._positionCounts[t.after]--,t}return null}_undoMove(){let e=this._history.pop();if(e===void 0)return null;let t=e.move;this._kings=e.kings,this._turn=e.turn,this._castling=e.castling,this._epSquare=e.epSquare,this._halfMoves=e.halfMoves,this._moveNumber=e.moveNumber;let s=this._turn,i=F(s);if(this._board[t.from]=this._board[t.to],this._board[t.from].type=t.piece,delete this._board[t.to],t.captured)if(t.flags&u.EP_CAPTURE){let r;s===w?r=t.to-16:r=t.to+16,this._board[r]={type:k,color:i}}else this._board[t.to]={type:t.captured,color:i};if(t.flags&(u.KSIDE_CASTLE|u.QSIDE_CASTLE)){let r,a;t.flags&u.KSIDE_CASTLE?(r=t.to+1,a=t.to-1):(r=t.to-2,a=t.to+1),this._board[r]=this._board[a],delete this._board[a]}return t}pgn({newline:e="\n",maxWidth:t=0}={}){let s=[],i=!1;for(let h in this._header)s.push("["+h+' "'+this._header[h]+'"]'+e),i=!0;i&&this._history.length&&s.push(e);let r=h=>{let b=this._comments[this.fen()];if(typeof b<"u"){let f=h.length>0?" ":"";h="".concat(h).concat(f,"{").concat(b,"}")}return h},a=[];for(;this._history.length>0;)a.push(this._undoMove());let n=[],l="";for(a.length===0&&n.push(r(""));a.length>0;){l=r(l);let h=a.pop();if(!h)break;if(!this._history.length&&h.color==="b"){let b="".concat(this._moveNumber,". ...");l=l?"".concat(l," ").concat(b):b}else h.color==="w"&&(l.length&&n.push(l),l=this._moveNumber+".");l=l+" "+this._moveToSan(h,this._moves({legal:!0})),this._makeMove(h)}if(l.length&&n.push(r(l)),typeof this._header.Result<"u"&&n.push(this._header.Result),t===0)return s.join("")+n.join(" ");let c=function(){return s.length>0&&s[s.length-1]===" "?(s.pop(),!0):!1},_=function(h,b){for(let f of b.split(" "))if(f){if(h+f.length>t){for(;c();)h--;s.push(e),h=0}s.push(f),h+=f.length,s.push(" "),h++}return c()&&h--,h},m=0;for(let h=0;h<n.length;h++){if(m+n[h].length>t&&n[h].includes("{")){m=_(m,n[h]);continue}m+n[h].length>t&&h!==0?(s[s.length-1]===" "&&s.pop(),s.push(e),m=0):h!==0&&(s.push(" "),m++),s.push(n[h]),m+=n[h].length}return s.join("")}header(...e){for(let t=0;t<e.length;t+=2)typeof e[t]=="string"&&typeof e[t+1]=="string"&&(this._header[e[t]]=e[t+1]);return this._header}loadPgn(e,{strict:t=!1,newlineChar:s="\r?\n"}={}){function i(d){return d.replace(/\\/g,"\\")}function r(d){let N={},P=d.split(new RegExp(i(s))),Y="",X="";for(let $=0;$<P.length;$++){let Z=/^\s*\[\s*([A-Za-z]+)\s*"(.*)"\s*\]\s*$/;Y=P[$].replace(Z,"$1"),X=P[$].replace(Z,"$2"),Y.trim().length>0&&(N[Y]=X)}return N}e=e.trim();let n=new RegExp("^(\\[((?:"+i(s)+")|.)*\\])((?:\\s*"+i(s)+"){2}|(?:\\s*"+i(s)+")*$)").exec(e),l=n&&n.length>=2?n[1]:"";this.reset();let c=r(l),_="";for(let d in c)d.toLowerCase()==="fen"&&(_=c[d]),this.header(d,c[d]);if(!t)_&&this.load(_,{preserveHeaders:!0});else if(c.SetUp==="1"){if(!("FEN"in c))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(c.FEN,{preserveHeaders:!0})}function m(d){return Array.from(d).map(function(N){return N.charCodeAt(0)<128?N.charCodeAt(0).toString(16):encodeURIComponent(N).replace(/%/g,"").toLowerCase()}).join("")}function h(d){return d.length==0?"":decodeURIComponent("%"+(d.match(/.{1,2}/g)||[]).join("%"))}let b=function(d){return d=d.replace(new RegExp(i(s),"g")," "),"{".concat(m(d.slice(1,d.length-1)),"}")},f=function(d){if(d.startsWith("{")&&d.endsWith("}"))return h(d.slice(1,d.length-1))},g=e.replace(l,"").replace(new RegExp("({[^}]*})+?|;([^".concat(i(s),"]*)"),"g"),function(d,N,P){return N!==void 0?b(N):" "+b("{".concat(P.slice(1),"}"))}).replace(new RegExp(i(s),"g")," "),E=/(\([^()]+\))+?/g;for(;E.test(g);)g=g.replace(E,"");g=g.replace(/\d+\.(\.\.)?/g,""),g=g.replace(/\.\.\./g,""),g=g.replace(/\$\d+/g,"");let v=g.trim().split(new RegExp(/\s+/));v=v.filter(d=>d!=="");let L="";for(let d=0;d<v.length;d++){let N=f(v[d]);if(N!==void 0){this._comments[this.fen()]=N;continue}let P=this._moveFromSan(v[d],t);if(P==null)if(Ne.indexOf(v[d])>-1)L=v[d];else throw new Error("Invalid move in PGN: ".concat(v[d]));else L="",this._makeMove(P),this._positionCounts[this.fen()]++}L&&Object.keys(this._header).length&&!this._header.Result&&this.header("Result",L)}_moveToSan(e,t){let s="";if(e.flags&u.KSIDE_CASTLE)s="O-O";else if(e.flags&u.QSIDE_CASTLE)s="O-O-O";else{if(e.piece!==k){let i=we(e,t);s+=e.piece.toUpperCase()+i}e.flags&(u.CAPTURE|u.EP_CAPTURE)&&(e.piece===k&&(s+=y(e.from)[0]),s+="x"),s+=y(e.to),e.promotion&&(s+="="+e.promotion.toUpperCase())}return this._makeMove(e),this.isCheck()&&(this.isCheckmate()?s+="#":s+="+"),this._undoMove(),s}_moveFromSan(e,t=!1){let s=H(e),i=te(s),r=this._moves({legal:!0,piece:i});for(let h=0,b=r.length;h<b;h++)if(s===H(this._moveToSan(r[h],r)))return r[h];if(t)return null;let a,n,l,c,_,m=!1;if(n=s.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),n?(a=n[1],l=n[2],c=n[3],_=n[4],l.length==1&&(m=!0)):(n=s.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),n&&(a=n[1],l=n[2],c=n[3],_=n[4],l.length==1&&(m=!0))),i=te(s),r=this._moves({legal:!0,piece:a||i}),!c)return null;for(let h=0,b=r.length;h<b;h++)if(l){if((!a||a.toLowerCase()==r[h].piece)&&p[l]==r[h].from&&p[c]==r[h].to&&(!_||_.toLowerCase()==r[h].promotion))return r[h];if(m){let f=y(r[h].from);if((!a||a.toLowerCase()==r[h].piece)&&p[c]==r[h].to&&(l==f[0]||l==f[1])&&(!_||_.toLowerCase()==r[h].promotion))return r[h]}}else if(s===H(this._moveToSan(r[h],r)).replace("x",""))return r[h];return null}ascii(){let e="   +------------------------+\n";for(let t=p.a8;t<=p.h1;t++){if(D(t)===0&&(e+=" "+"87654321"[q(t)]+" |"),this._board[t]){let s=this._board[t].type,r=this._board[t].color===C?s.toUpperCase():s.toLowerCase();e+=" "+r+" "}else e+=" . ";t+1&136&&(e+="|\n",t+=8)}return e+="   +------------------------+\n",e+="     a  b  c  d  e  f  g  h",e}perft(e){let t=this._moves({legal:!1}),s=0,i=this._turn;for(let r=0,a=t.length;r<a;r++)this._makeMove(t[r]),this._isKingAttacked(i)||(e-1>0?s+=this.perft(e-1):s++),this._undoMove();return s}_makePretty(e){let{color:t,piece:s,from:i,to:r,flags:a,captured:n,promotion:l}=e,c="";for(let b in u)u[b]&a&&(c+=_e[b]);let _=y(i),m=y(r),h={color:t,piece:s,from:_,to:m,san:this._moveToSan(e,this._moves({legal:!0})),flags:c,lan:_+m,before:this.fen(),after:""};return this._makeMove(e),h.after=this.fen(),this._undoMove(),n&&(h.captured=n),l&&(h.promotion=l,h.lan+=l),h}turn(){return this._turn}board(){let e=[],t=[];for(let s=p.a8;s<=p.h1;s++)this._board[s]==null?t.push(null):t.push({square:y(s),type:this._board[s].type,color:this._board[s].color}),s+1&136&&(e.push(t),t=[],s+=8);return e}squareColor(e){if(e in p){let t=p[e];return(q(t)+D(t))%2===0?"light":"dark"}return null}history({verbose:e=!1}={}){let t=[],s=[];for(;this._history.length>0;)t.push(this._undoMove());for(;;){let i=t.pop();if(!i)break;e?s.push(this._makePretty(i)):s.push(this._moveToSan(i,this._moves())),this._makeMove(i)}return s}_pruneComments(){let e=[],t={},s=i=>{i in this._comments&&(t[i]=this._comments[i])};for(;this._history.length>0;)e.push(this._undoMove());for(s(this.fen());;){let i=e.pop();if(!i)break;this._makeMove(i),s(this.fen())}this._comments=t}getComment(){return this._comments[this.fen()]}setComment(e){this._comments[this.fen()]=e.replace("{","[").replace("}","]")}deleteComment(){let e=this._comments[this.fen()];return delete this._comments[this.fen()],e}getComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>({fen:e,comment:this._comments[e]}))}deleteComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>{let t=this._comments[e];return delete this._comments[e],{fen:e,comment:t}})}setCastlingRights(e,t){for(let i of[S,x])t[i]!==void 0&&(t[i]?this._castling[e]|=Q[i]:this._castling[e]&=~Q[i]);this._updateCastlingRights();let s=this.getCastlingRights(e);return(t[S]===void 0||t[S]===s[S])&&(t[x]===void 0||t[x]===s[x])}getCastlingRights(e){return{[S]:(this._castling[e]&Q[S])!==0,[x]:(this._castling[e]&Q[x])!==0}}moveNumber(){return this._moveNumber}};var Pe=["1-0","0-1","1/2-1/2","*"];function re(o){o=Ae(o).replace(/\{[^}]*\}/g,"").replace(/;.+$/gm,"").replace(/\b(-?\d+)\./g,"$1 .").replace(/\.+/g,a=>a.length>2?"... ":"").replace(/\s+/g," ").trim();let e=o.split(" ").filter(a=>!a.match(/^\$\d+$/)),t=e[e.length-1];t&&Pe.includes(t)&&e.pop(),e[0]=="..."&&e.shift();let s=[],i,r=0;for(let a=0;a<e.length;a++){let n=e[a];if(z(n))i!=n?(i=n,r=0):e[a+1]=="..."&&a++;else if(n=="...")s.length>0&&(z(e[a-1])||z(e[a+1]))&&(s.push(n),r++);else if(r<2)s.push(n),r++;else break}return s}function z(o){return/^-?\d+$/.test(o)}function Ae(o){for(;;){let e=o.replace(/\([^()]*\)/g,"");if(e==o)return o;o=e}}function R(o,...e){let t=o.split(" ");for(let s of e)s(t);return t.join(" ")}var U=o=>{o[1]=o[1]=="b"?"w":"b",o[3]="-"},ne=o=>{o[1]=="w"&&(o[5]=Number(o[5])+1)},oe=o=>{o[4]=0,o[5]=1};var Ie=16;function le(o,e){var f;if(!o)return null;let{from:t,to:s,unpromote:i}=o;if(e.get(s))return null;let r=o.uncapture=="c",a=r?"p":o.uncapture,n=(f=e.get(t))==null?void 0:f.type;if(!xe(n,r,i)||!Re(e.state.history[e.state.moveNumber],t,s))return null;let l=e.turn()=="b",c=e.getCastlingRights(l?"w":"b");if(!Me(n,c,l,t))return null;let _=R(e.fen(),U),m=new O(_),h=m.remove(t),b=t[1];return i&&(h.type="p"),h.type=="p"&&(l&&b=="2"||!l&&b=="7")||!m.put(h,s)?null:{ep:r,uncapture:a,unpromote:i,isWhite:l,temp:m,piece:h,rank:b,from:t,to:s}}function xe(o,e,t){return!(!o||e&&o!="p"||t&&(o=="p"||o=="k"))}function Re(o,e,t){if(o&&o.flags=="e"){let s=o.to.replace("3","4").replace("6","5"),i=o.to.replace("3","2").replace("6","7");if(e!=s||t!=i)return!1}return!0}function Me(o,e,t,s){return!(o=="k"&&(e.k||e.q)||o=="r"&&s==(t?"a1":"a8")&&e.q||o=="r"&&s==(t?"h1":"h8")&&e.k)}function he(o,e){let{isWhite:t,uncapture:s,rank:i,ep:r,from:a,temp:n}=o,l=t?"b":"w";if(s=="p"&&(i=="1"||i=="8"))return console.log("Cannot uncapture a pawn at the 1st or the 8th rank."),!1;if(e.board().flat().filter(m=>m&&m.color==l).length>=Ie)return console.log("Too many uncapturing."),!1;let c={type:s,color:l},_=r?qe(a):a;if(r&&i!=(t?"6":"3")||r&&n.get(_)||!n.put(c,_))return!1;if(r){let m=R(n.fen(),h=>h[3]=a);n.load(m)}return!0}function qe(o){return o.replace("3","4").replace("6","5")}function ce(o){let{isWhite:e,piece:t,from:s,to:i,temp:r}=o;if(t.type=="k"&&(e&&i=="e1"||!e&&i=="e8")){let a=i[1];if(s=="g"+a){if(!ae(r,"f"+a,"h"+a))return!1;r.setCastlingRights(t.color,{k:!0})}if(s=="c"+a){if(!ae(r,"d"+a,"a"+a))return!1;r.setCastlingRights(t.color,{q:!0})}}return!0}function ae(o,e,t){if(o.get(t))return!1;let s=o.remove(e);return s?(o.put(s,t),!0):!1}function fe(o){let{type:e,unpromote:t,from:s,to:i,temp:r}=o,n=r.moves({verbose:!0}).find(c=>c.from==i&&c.to==s&&(!t||c.promotion==e));return n?J(n.before).isCheck()?(console.log("must retract checking"),null):n:null}function J(o){return new O(R(o,U))}var B=class extends O{constructor(e){super(),this.state=e||{},this.state.history=this.state.history||[]}checkPromotion(e,t){return this.moves({verbose:!0}).some(i=>i.from==e&&i.to==t&&i.flags.includes("p"))}switchSide(){this.load(R(this.fen(),U))}init(e){try{this.state.initFEN=e,this.state.history.length=0,this.state.moveNumber=-1,this.load(e);let t=this.board(),s=r=>r.some(a=>a&&a.type=="p");if(s(t[0])||s(t[7]))throw new Error("pawns cannot be on the 1st or the 8th rank");let i=J(e);if(i.isCheck()){if(this.isCheck())throw new Error("both kings are under checks");this.state.initFEN=i.fen(),this.load(this.state.initFEN)}}catch(t){throw new Error("The position is not playable: "+t.message.replace(/^.+:/,"").trim().replace(/[^.]$/,"$&."))}}retract(e){let t=le(e,this);if(!t||t.uncapture&&!he(t,this)||!ce(t))return!1;let s=fe(t);if(!s)return!1;this.state.moveNumber>=0&&(s.before=R(s.before,ne)),this.load(s.before);let i=this.state;return i.history.length=i.moveNumber+1,i.history.push(s),i.moveNumber++,!0}move(e){let t=this.state,s=this.fen(),i=t.history.concat();try{let r=super.move(e);this.isDraw()&&(r.san+="="),t.history.length=t.moveNumber+1;let a=t.history[t.history.length-1];return t.mode=="pass"&&a&&r.color==a.color&&r.color=="w"&&(r.before=r.before.replace(/\d+$/,n=>Number(n)+1),r.after=r.after.replace(/\d+$/,n=>Number(n)+1)),this.load(r.after),t.over=this.overState(),t.history.push(r),t.moveNumber++,r}catch{return t.history=i,this.load(s),null}}addMoves(e){if(!e||e.length==0)return;let t=this.state.mode=="retro"?this.addRetroMoves(e):this.addNormalMoves(e);if(t)throw new Error("Something went wrong in the move: "+t)}addRetroMoves(e){for(let t of e){if(t=="...")continue;let s=$e(t);if(!this.retract(s))return t}}addNormalMoves(e){let t=!1,s=this.state.mode=="pass";for(let i of e)if(i=="...")s&&this.switchSide();else if(this.move(i))t=!0;else{if(!t&&s&&(this.switchSide(),this.move(i)))continue;return i}}overState(){return this.isCheckmate()?1:this.isDraw()?2:0}copyGame(e,t){let s=t?t.concat(this.state.history):this.state.history;return Oe(s,e)}copyPGN(e){let t="";if(this.state.mode=="retro"){let s=this.state.history,i=s.length-1,r=s.length>0?s[i].before:this.state.initFEN,a=R(r,oe);a!=M&&(t+='[SetUp "1"]\n[FEN "'.concat(a,'"]\n\n'));let n=1;for(let l=i;l>=0;l--)(s[l].color=="w"||l==i)&&(t+=n+++". ",l==i&&s[l].color=="b"&&(t+="... ")),t+=s[l].san+" "}else{let s=e&&e.length?e[0].before:this.state.initFEN;s!=M&&(t+='[SetUp "1"]\n[FEN "'.concat(s,'"]\n\n')),t+=this.copyGame({},e)}return t}loadGame(e){let t=e.match(/\[fen "([^"]+)"\]/i),s=t?t[1]:M;this.init(s),e=e.replace(/\[[^\]]+\]/g,"").trim();let i=re(e);this.state.mode=i.includes("...")?"pass":"normal",this.addMoves(i),this.state.over=this.overState(),this.goto()}goto(e){let t=this.getFenOf(e);return this.load(t),this.state.moveNumber=this.state.history.indexOf(e),t}getFenOf(e){return e?this.state.mode=="retro"?e.before:e.after:this.state.initFEN}};function Oe(o,e){if(o.length==0)return"";let t="";o[0].color=="b"&&(t+=o[0].before.split(" ")[5]+"... ");for(let[s,i]of o.entries())o[s-1]&&o[s-1].color==i.color&&(i.color=="w"?t+="... ":t+=ue(i)+"... "),i.color=="w"&&(t+=ue(i)+". "),t+=Le(i,null,e)+" ";return t.trimEnd()}function ue(o,e,t=B.options){if(!o)return"";let s=o.before.match(/\d+$/)[0];return(e=="retro"&&t.negative?"-":"")+s}function Le(o,e,t=B.options){if(!o)return"";let s=e=="retro",i=s?Ke(o):o.san,r=Fe(t.symbol);if(r)for(let[a,n]of Object.entries(r))i=i.replace(a,n);return(s||t.ep)&&o.flags.includes("e")&&(i=i.replace(/([+#=]?)$/,"ep$1")),t.zero&&(i=i.replace("O-O-O","0-0-0").replace("O-O","0-0")),o.annotation&&(i+=o.annotation),i}function Fe(o){return o=="unicode"?De:o=="german"?Ue:null}function Ke(o){if(o.flags=="k"||o.flags=="q")return o.san;let e=o.piece.toUpperCase(),t=o.captured?o.captured.toUpperCase():"",s=o.san.match(/[+#=]$/),i=s?s[0]:"";return(e=="P"?"":e)+o.from+(o.captured?"x"+t:"-")+o.to+(o.promotion?"="+o.promotion.toUpperCase():"")+i}var De={K:"\u2654",Q:"\u2655",B:"\u2657",N:"\u2658",R:"\u2656",P:"\u2659"},Ue={K:"K",Q:"D",B:"L",N:"S",R:"T",P:"B"};function $e(o){let e=o.match(/^\w?([a-h][1-8])[-x](\w?)([a-h][1-8])(ep)?(?:=(\w))?/);if(!e)return null;let t=null;return e[4]?t="c":e[2]&&(t=e[2].toLowerCase()),{from:e[3],to:e[1],uncapture:t,unpromote:!!e[5]}}export{B as Chess,Le as format,Oe as formatGame,ue as number,re as parseMoves};
//# sourceMappingURL=chess.js.map
