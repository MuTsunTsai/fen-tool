var _e=Object.defineProperty;var pe=(a,e,t)=>e in a?_e(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var k=(a,e,t)=>(pe(a,typeof e!="symbol"?e+"":e,t),t);var y="w",x="b",v="p",X="n",T="b",D="r",I="q",E="k",F="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";var ge={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"};var u={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},d={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},G={b:[16,32,17,15],w:[-16,-32,-17,-15]},ee={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},me=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],be=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],Se={p:1,n:2,b:4,r:8,q:16,k:32},Ee="pnbrqkPNBRQK",te=[X,T,D,I],ve=7,Ce=6,ye=1,ke=0,j={[E]:u.KSIDE_CASTLE,[I]:u.QSIDE_CASTLE},A={w:[{square:d.a1,flag:u.QSIDE_CASTLE},{square:d.h1,flag:u.KSIDE_CASTLE}],b:[{square:d.a8,flag:u.QSIDE_CASTLE},{square:d.h8,flag:u.KSIDE_CASTLE}]},Pe={b:ye,w:Ce},Ne=["1-0","0-1","1/2-1/2","*"];function O(a){return a>>4}function U(a){return a&15}function se(a){return"0123456789".indexOf(a)!==-1}function P(a){let e=U(a),t=O(a);return"abcdefgh".substring(e,e+1)+"87654321".substring(t,t+1)}function K(a){return a===y?x:y}function xe(a){let e=a.split(/\s+/);if(e.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};let t=parseInt(e[5],10);if(isNaN(t)||t<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};let r=parseInt(e[4],10);if(isNaN(r)||r<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(e[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(e[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(e[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};let s=e[0].split("/");if(s.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let n=0;n<s.length;n++){let o=0,c=!1;for(let h=0;h<s[n].length;h++)if(se(s[n][h])){if(c)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};o+=parseInt(s[n][h],10),c=!0}else{if(!/^[prnbqkPRNBQK]$/.test(s[n][h]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};o+=1,c=!1}if(o!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(e[3][1]=="3"&&e[1]=="w"||e[3][1]=="6"&&e[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};let i=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(let{color:n,regex:o}of i){if(!o.test(e[0]))return{ok:!1,error:"Invalid FEN: missing ".concat(n," king")};if((e[0].match(o)||[]).length>1)return{ok:!1,error:"Invalid FEN: too many ".concat(n," kings")}}return Array.from(s[0]+s[7]).some(n=>n.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function we(a,e){let t=a.from,r=a.to,s=a.piece,i=0,n=0,o=0;for(let c=0,h=e.length;c<h;c++){let p=e[c].from,g=e[c].to,l=e[c].piece;s===l&&t!==p&&r===g&&(i++,O(t)===O(p)&&n++,U(t)===U(p)&&o++)}return i>0?n>0&&o>0?P(t):o>0?P(t).charAt(1):P(t).charAt(0):""}function q(a,e,t,r,s,i=void 0,n=u.NORMAL){let o=O(r);if(s===v&&(o===ve||o===ke))for(let c=0;c<te.length;c++){let h=te[c];a.push({color:e,from:t,to:r,piece:s,captured:i,promotion:h,flags:n|u.PROMOTION})}else a.push({color:e,from:t,to:r,piece:s,captured:i,flags:n})}function re(a){let e=a.charAt(0);return e>="a"&&e<="h"?a.match(/[a-h]\d.*[a-h]\d/)?void 0:v:(e=e.toLowerCase(),e==="o"?E:e)}function H(a){return a.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function W(a){return a.split(" ").slice(0,4).join(" ")}var L=class{constructor(e=F){k(this,"_board",new Array(128));k(this,"_turn",y);k(this,"_header",{});k(this,"_kings",{w:-1,b:-1});k(this,"_epSquare",-1);k(this,"_halfMoves",0);k(this,"_moveNumber",0);k(this,"_history",[]);k(this,"_comments",{});k(this,"_castling",{w:0,b:0});k(this,"_positionCount",{});this.load(e)}clear({preserveHeaders:e=!1}={}){this._board=new Array(128),this._kings={w:-1,b:-1},this._turn=y,this._castling={w:0,b:0},this._epSquare=-1,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=e?this._header:{},this._positionCount={},delete this._header.SetUp,delete this._header.FEN}removeHeader(e){e in this._header&&delete this._header[e]}load(e,{skipValidation:t=!1,preserveHeaders:r=!1}={}){let s=e.split(/\s+/);if(s.length>=2&&s.length<6){let o=["-","-","0","1"];e=s.concat(o.slice(-(6-s.length))).join(" ")}if(s=e.split(/\s+/),!t){let{ok:o,error:c}=xe(e);if(!o)throw new Error(c)}let i=s[0],n=0;this.clear({preserveHeaders:r});for(let o=0;o<i.length;o++){let c=i.charAt(o);if(c==="/")n+=8;else if(se(c))n+=parseInt(c,10);else{let h=c<"a"?y:x;this._put({type:c.toLowerCase(),color:h},P(n)),n++}}this._turn=s[1],s[2].indexOf("K")>-1&&(this._castling.w|=u.KSIDE_CASTLE),s[2].indexOf("Q")>-1&&(this._castling.w|=u.QSIDE_CASTLE),s[2].indexOf("k")>-1&&(this._castling.b|=u.KSIDE_CASTLE),s[2].indexOf("q")>-1&&(this._castling.b|=u.QSIDE_CASTLE),this._epSquare=s[3]==="-"?-1:d[s[3]],this._halfMoves=parseInt(s[4],10),this._moveNumber=parseInt(s[5],10),this._updateSetup(e),this._incPositionCount(e)}fen(){var i,n;let e=0,t="";for(let o=d.a8;o<=d.h1;o++){if(this._board[o]){e>0&&(t+=e,e=0);let{color:c,type:h}=this._board[o];t+=c===y?h.toUpperCase():h.toLowerCase()}else e++;o+1&136&&(e>0&&(t+=e),o!==d.h1&&(t+="/"),e=0,o+=8)}let r="";this._castling[y]&u.KSIDE_CASTLE&&(r+="K"),this._castling[y]&u.QSIDE_CASTLE&&(r+="Q"),this._castling[x]&u.KSIDE_CASTLE&&(r+="k"),this._castling[x]&u.QSIDE_CASTLE&&(r+="q"),r=r||"-";let s="-";if(this._epSquare!==-1){let o=this._epSquare+(this._turn===y?16:-16),c=[o+1,o-1];for(let h of c){if(h&136)continue;let p=this._turn;if(((i=this._board[h])==null?void 0:i.color)===p&&((n=this._board[h])==null?void 0:n.type)===v){this._makeMove({color:p,from:h,to:this._epSquare,piece:v,captured:v,flags:u.EP_CAPTURE});let g=!this._isKingAttacked(p);if(this._undoMove(),g){s=P(this._epSquare);break}}}}return[t,this._turn,r,s,this._halfMoves,this._moveNumber].join(" ")}_updateSetup(e){this._history.length>0||(e!==F?(this._header.SetUp="1",this._header.FEN=e):(delete this._header.SetUp,delete this._header.FEN))}reset(){this.load(F)}get(e){return this._board[d[e]]||!1}put({type:e,color:t},r){return this._put({type:e,color:t},r)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_put({type:e,color:t},r){if(Ee.indexOf(e.toLowerCase())===-1||!(r in d))return!1;let s=d[r];if(e==E&&!(this._kings[t]==-1||this._kings[t]==s))return!1;let i=this._board[s];return i&&i.type===E&&(this._kings[i.color]=-1),this._board[s]={type:e,color:t},e===E&&(this._kings[t]=s),!0}remove(e){let t=this.get(e);return delete this._board[d[e]],t&&t.type===E&&(this._kings[t.color]=-1),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),t}_updateCastlingRights(){var r,s,i,n,o,c,h,p,g,l,b,f;let e=((r=this._board[d.e1])==null?void 0:r.type)===E&&((s=this._board[d.e1])==null?void 0:s.color)===y,t=((i=this._board[d.e8])==null?void 0:i.type)===E&&((n=this._board[d.e8])==null?void 0:n.color)===x;(!e||((o=this._board[d.a1])==null?void 0:o.type)!==D||((c=this._board[d.a1])==null?void 0:c.color)!==y)&&(this._castling.w&=~u.QSIDE_CASTLE),(!e||((h=this._board[d.h1])==null?void 0:h.type)!==D||((p=this._board[d.h1])==null?void 0:p.color)!==y)&&(this._castling.w&=~u.KSIDE_CASTLE),(!t||((g=this._board[d.a8])==null?void 0:g.type)!==D||((l=this._board[d.a8])==null?void 0:l.color)!==x)&&(this._castling.b&=~u.QSIDE_CASTLE),(!t||((b=this._board[d.h8])==null?void 0:b.type)!==D||((f=this._board[d.h8])==null?void 0:f.color)!==x)&&(this._castling.b&=~u.KSIDE_CASTLE)}_updateEnPassantSquare(){var i,n;if(this._epSquare===-1)return;let e=this._epSquare+(this._turn===y?-16:16),t=this._epSquare+(this._turn===y?16:-16),r=[t+1,t-1];if(this._board[e]!==null||this._board[this._epSquare]!==null||((i=this._board[t])==null?void 0:i.color)!==K(this._turn)||((n=this._board[t])==null?void 0:n.type)!==v){this._epSquare=-1;return}let s=o=>{var c,h;return!(o&136)&&((c=this._board[o])==null?void 0:c.color)===this._turn&&((h=this._board[o])==null?void 0:h.type)===v};r.some(s)||(this._epSquare=-1)}_attacked(e,t){for(let r=d.a8;r<=d.h1;r++){if(r&136){r+=7;continue}if(this._board[r]===void 0||this._board[r].color!==e)continue;let s=this._board[r],i=r-t;if(i===0)continue;let n=i+119;if(me[n]&Se[s.type]){if(s.type===v){if(i>0){if(s.color===y)return!0}else if(s.color===x)return!0;continue}if(s.type==="n"||s.type==="k")return!0;let o=be[n],c=r+o,h=!1;for(;c!==t;){if(this._board[c]!=null){h=!0;break}c+=o}if(!h)return!0}}return!1}_isKingAttacked(e){let t=this._kings[e];return t===-1?!1:this._attacked(K(e),t)}isAttacked(e,t){return this._attacked(t,d[e])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){let e={b:0,n:0,r:0,q:0,k:0,p:0},t=[],r=0,s=0;for(let i=d.a8;i<=d.h1;i++){if(s=(s+1)%2,i&136){i+=7;continue}let n=this._board[i];n&&(e[n.type]=n.type in e?e[n.type]+1:1,n.type===T&&t.push(s),r++)}if(r===2)return!0;if(r===3&&(e[T]===1||e[X]===1))return!0;if(r===e[T]+2){let i=0,n=t.length;for(let o=0;o<n;o++)i+=t[o];if(i===0||i===n)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this.fen())>=3}isDraw(){return this._halfMoves>=100||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isStalemate()||this.isDraw()}moves({verbose:e=!1,square:t=void 0,piece:r=void 0}={}){let s=this._moves({square:t,piece:r});return e?s.map(i=>this._makePretty(i)):s.map(i=>this._moveToSan(i,s))}_moves({legal:e=!0,piece:t=void 0,square:r=void 0}={}){var b;let s=r?r.toLowerCase():void 0,i=t==null?void 0:t.toLowerCase(),n=[],o=this._turn,c=K(o),h=d.a8,p=d.h1,g=!1;if(s)if(s in d)h=p=d[s],g=!0;else return[];for(let f=h;f<=p;f++){if(f&136){f+=7;continue}if(!this._board[f]||this._board[f].color===c)continue;let{type:m}=this._board[f],S;if(m===v){if(i&&i!==m)continue;S=f+G[o][0],this._board[S]||(q(n,o,f,S,v),S=f+G[o][1],Pe[o]===O(f)&&!this._board[S]&&q(n,o,f,S,v,void 0,u.BIG_PAWN));for(let C=2;C<4;C++)S=f+G[o][C],!(S&136)&&(((b=this._board[S])==null?void 0:b.color)===c?q(n,o,f,S,v,this._board[S].type,u.CAPTURE):S===this._epSquare&&q(n,o,f,S,v,v,u.EP_CAPTURE))}else{if(i&&i!==m)continue;for(let C=0,M=ee[m].length;C<M;C++){let _=ee[m][C];for(S=f;S+=_,!(S&136);){if(!this._board[S])q(n,o,f,S,m);else{if(this._board[S].color===o)break;q(n,o,f,S,m,this._board[S].type,u.CAPTURE);break}if(m===X||m===E)break}}}}if((i===void 0||i===E)&&(!g||p===this._kings[o])){if(this._castling[o]&u.KSIDE_CASTLE){let f=this._kings[o],m=f+2;!this._board[f+1]&&!this._board[m]&&!this._attacked(c,this._kings[o])&&!this._attacked(c,f+1)&&!this._attacked(c,m)&&q(n,o,this._kings[o],m,E,void 0,u.KSIDE_CASTLE)}if(this._castling[o]&u.QSIDE_CASTLE){let f=this._kings[o],m=f-2;!this._board[f-1]&&!this._board[f-2]&&!this._board[f-3]&&!this._attacked(c,this._kings[o])&&!this._attacked(c,f-1)&&!this._attacked(c,m)&&q(n,o,this._kings[o],m,E,void 0,u.QSIDE_CASTLE)}}if(!e||this._kings[o]===-1)return n;let l=[];for(let f=0,m=n.length;f<m;f++)this._makeMove(n[f]),this._isKingAttacked(o)||l.push(n[f]),this._undoMove();return l}move(e,{strict:t=!1}={}){let r=null;if(typeof e=="string")r=this._moveFromSan(e,t);else if(typeof e=="object"){let i=this._moves();for(let n=0,o=i.length;n<o;n++)if(e.from===P(i[n].from)&&e.to===P(i[n].to)&&(!("promotion"in i[n])||e.promotion===i[n].promotion)){r=i[n];break}}if(!r)throw typeof e=="string"?new Error("Invalid move: ".concat(e)):new Error("Invalid move: ".concat(JSON.stringify(e)));let s=this._makePretty(r);return this._makeMove(r),this._incPositionCount(s.after),s}_push(e){this._history.push({move:e,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_makeMove(e){let t=this._turn,r=K(t);if(this._push(e),this._board[e.to]=this._board[e.from],delete this._board[e.from],e.flags&u.EP_CAPTURE&&(this._turn===x?delete this._board[e.to-16]:delete this._board[e.to+16]),e.promotion&&(this._board[e.to]={type:e.promotion,color:t}),this._board[e.to].type===E){if(this._kings[t]=e.to,e.flags&u.KSIDE_CASTLE){let s=e.to-1,i=e.to+1;this._board[s]=this._board[i],delete this._board[i]}else if(e.flags&u.QSIDE_CASTLE){let s=e.to+1,i=e.to-2;this._board[s]=this._board[i],delete this._board[i]}this._castling[t]=0}if(this._castling[t]){for(let s=0,i=A[t].length;s<i;s++)if(e.from===A[t][s].square&&this._castling[t]&A[t][s].flag){this._castling[t]^=A[t][s].flag;break}}if(this._castling[r]){for(let s=0,i=A[r].length;s<i;s++)if(e.to===A[r][s].square&&this._castling[r]&A[r][s].flag){this._castling[r]^=A[r][s].flag;break}}e.flags&u.BIG_PAWN?t===x?this._epSquare=e.to-16:this._epSquare=e.to+16:this._epSquare=-1,e.piece===v?this._halfMoves=0:e.flags&(u.CAPTURE|u.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,t===x&&this._moveNumber++,this._turn=r}undo(){let e=this._undoMove();if(e){let t=this._makePretty(e);return this._decPositionCount(t.after),t}return null}_undoMove(){let e=this._history.pop();if(e===void 0)return null;let t=e.move;this._kings=e.kings,this._turn=e.turn,this._castling=e.castling,this._epSquare=e.epSquare,this._halfMoves=e.halfMoves,this._moveNumber=e.moveNumber;let r=this._turn,s=K(r);if(this._board[t.from]=this._board[t.to],this._board[t.from].type=t.piece,delete this._board[t.to],t.captured)if(t.flags&u.EP_CAPTURE){let i;r===x?i=t.to-16:i=t.to+16,this._board[i]={type:v,color:s}}else this._board[t.to]={type:t.captured,color:s};if(t.flags&(u.KSIDE_CASTLE|u.QSIDE_CASTLE)){let i,n;t.flags&u.KSIDE_CASTLE?(i=t.to+1,n=t.to-1):(i=t.to-2,n=t.to+1),this._board[i]=this._board[n],delete this._board[n]}return t}pgn({newline:e="\n",maxWidth:t=0}={}){let r=[],s=!1;for(let l in this._header)r.push("["+l+' "'+this._header[l]+'"]'+e),s=!0;s&&this._history.length&&r.push(e);let i=l=>{let b=this._comments[this.fen()];if(typeof b<"u"){let f=l.length>0?" ":"";l="".concat(l).concat(f,"{").concat(b,"}")}return l},n=[];for(;this._history.length>0;)n.push(this._undoMove());let o=[],c="";for(n.length===0&&o.push(i(""));n.length>0;){c=i(c);let l=n.pop();if(!l)break;if(!this._history.length&&l.color==="b"){let b="".concat(this._moveNumber,". ...");c=c?"".concat(c," ").concat(b):b}else l.color==="w"&&(c.length&&o.push(c),c=this._moveNumber+".");c=c+" "+this._moveToSan(l,this._moves({legal:!0})),this._makeMove(l)}if(c.length&&o.push(i(c)),typeof this._header.Result<"u"&&o.push(this._header.Result),t===0)return r.join("")+o.join(" ");let h=function(){return r.length>0&&r[r.length-1]===" "?(r.pop(),!0):!1},p=function(l,b){for(let f of b.split(" "))if(f){if(l+f.length>t){for(;h();)l--;r.push(e),l=0}r.push(f),l+=f.length,r.push(" "),l++}return h()&&l--,l},g=0;for(let l=0;l<o.length;l++){if(g+o[l].length>t&&o[l].includes("{")){g=p(g,o[l]);continue}g+o[l].length>t&&l!==0?(r[r.length-1]===" "&&r.pop(),r.push(e),g=0):l!==0&&(r.push(" "),g++),r.push(o[l]),g+=o[l].length}return r.join("")}header(...e){for(let t=0;t<e.length;t+=2)typeof e[t]=="string"&&typeof e[t+1]=="string"&&(this._header[e[t]]=e[t+1]);return this._header}loadPgn(e,{strict:t=!1,newlineChar:r="\r?\n"}={}){function s(_){return _.replace(/\\/g,"\\")}function i(_){let N={},w=_.split(new RegExp(s(r))),Y="",Z="";for(let B=0;B<w.length;B++){let V=/^\s*\[\s*([A-Za-z]+)\s*"(.*)"\s*\]\s*$/;Y=w[B].replace(V,"$1"),Z=w[B].replace(V,"$2"),Y.trim().length>0&&(N[Y]=Z)}return N}e=e.trim();let o=new RegExp("^(\\[((?:"+s(r)+")|.)*\\])((?:\\s*"+s(r)+"){2}|(?:\\s*"+s(r)+")*$)").exec(e),c=o&&o.length>=2?o[1]:"";this.reset();let h=i(c),p="";for(let _ in h)_.toLowerCase()==="fen"&&(p=h[_]),this.header(_,h[_]);if(!t)p&&this.load(p,{preserveHeaders:!0});else if(h.SetUp==="1"){if(!("FEN"in h))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(h.FEN,{preserveHeaders:!0})}function g(_){return Array.from(_).map(function(N){return N.charCodeAt(0)<128?N.charCodeAt(0).toString(16):encodeURIComponent(N).replace(/%/g,"").toLowerCase()}).join("")}function l(_){return _.length==0?"":decodeURIComponent("%"+(_.match(/.{1,2}/g)||[]).join("%"))}let b=function(_){return _=_.replace(new RegExp(s(r),"g")," "),"{".concat(g(_.slice(1,_.length-1)),"}")},f=function(_){if(_.startsWith("{")&&_.endsWith("}"))return l(_.slice(1,_.length-1))},m=e.replace(c,"").replace(new RegExp("({[^}]*})+?|;([^".concat(s(r),"]*)"),"g"),function(_,N,w){return N!==void 0?b(N):" "+b("{".concat(w.slice(1),"}"))}).replace(new RegExp(s(r),"g")," "),S=/(\([^()]+\))+?/g;for(;S.test(m);)m=m.replace(S,"");m=m.replace(/\d+\.(\.\.)?/g,""),m=m.replace(/\.\.\./g,""),m=m.replace(/\$\d+/g,"");let C=m.trim().split(new RegExp(/\s+/));C=C.filter(_=>_!=="");let M="";for(let _=0;_<C.length;_++){let N=f(C[_]);if(N!==void 0){this._comments[this.fen()]=N;continue}let w=this._moveFromSan(C[_],t);if(w==null)if(Ne.indexOf(C[_])>-1)M=C[_];else throw new Error("Invalid move in PGN: ".concat(C[_]));else M="",this._makeMove(w),this._incPositionCount(this.fen())}M&&Object.keys(this._header).length&&!this._header.Result&&this.header("Result",M)}_moveToSan(e,t){let r="";if(e.flags&u.KSIDE_CASTLE)r="O-O";else if(e.flags&u.QSIDE_CASTLE)r="O-O-O";else{if(e.piece!==v){let s=we(e,t);r+=e.piece.toUpperCase()+s}e.flags&(u.CAPTURE|u.EP_CAPTURE)&&(e.piece===v&&(r+=P(e.from)[0]),r+="x"),r+=P(e.to),e.promotion&&(r+="="+e.promotion.toUpperCase())}return this._makeMove(e),this.isCheck()&&(this.isCheckmate()?r+="#":r+="+"),this._undoMove(),r}_moveFromSan(e,t=!1){let r=H(e),s=re(r),i=this._moves({legal:!0,piece:s});for(let l=0,b=i.length;l<b;l++)if(r===H(this._moveToSan(i[l],i)))return i[l];if(t)return null;let n,o,c,h,p,g=!1;if(o=r.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),o?(n=o[1],c=o[2],h=o[3],p=o[4],c.length==1&&(g=!0)):(o=r.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),o&&(n=o[1],c=o[2],h=o[3],p=o[4],c.length==1&&(g=!0))),s=re(r),i=this._moves({legal:!0,piece:n||s}),!h)return null;for(let l=0,b=i.length;l<b;l++)if(c){if((!n||n.toLowerCase()==i[l].piece)&&d[c]==i[l].from&&d[h]==i[l].to&&(!p||p.toLowerCase()==i[l].promotion))return i[l];if(g){let f=P(i[l].from);if((!n||n.toLowerCase()==i[l].piece)&&d[h]==i[l].to&&(c==f[0]||c==f[1])&&(!p||p.toLowerCase()==i[l].promotion))return i[l]}}else if(r===H(this._moveToSan(i[l],i)).replace("x",""))return i[l];return null}ascii(){let e="   +------------------------+\n";for(let t=d.a8;t<=d.h1;t++){if(U(t)===0&&(e+=" "+"87654321"[O(t)]+" |"),this._board[t]){let r=this._board[t].type,i=this._board[t].color===y?r.toUpperCase():r.toLowerCase();e+=" "+i+" "}else e+=" . ";t+1&136&&(e+="|\n",t+=8)}return e+="   +------------------------+\n",e+="     a  b  c  d  e  f  g  h",e}perft(e){let t=this._moves({legal:!1}),r=0,s=this._turn;for(let i=0,n=t.length;i<n;i++)this._makeMove(t[i]),this._isKingAttacked(s)||(e-1>0?r+=this.perft(e-1):r++),this._undoMove();return r}_makePretty(e){let{color:t,piece:r,from:s,to:i,flags:n,captured:o,promotion:c}=e,h="";for(let b in u)u[b]&n&&(h+=ge[b]);let p=P(s),g=P(i),l={color:t,piece:r,from:p,to:g,san:this._moveToSan(e,this._moves({legal:!0})),flags:h,lan:p+g,before:this.fen(),after:""};return this._makeMove(e),l.after=this.fen(),this._undoMove(),o&&(l.captured=o),c&&(l.promotion=c,l.lan+=c),l}turn(){return this._turn}board(){let e=[],t=[];for(let r=d.a8;r<=d.h1;r++)this._board[r]==null?t.push(null):t.push({square:P(r),type:this._board[r].type,color:this._board[r].color}),r+1&136&&(e.push(t),t=[],r+=8);return e}squareColor(e){if(e in d){let t=d[e];return(O(t)+U(t))%2===0?"light":"dark"}return null}history({verbose:e=!1}={}){let t=[],r=[];for(;this._history.length>0;)t.push(this._undoMove());for(;;){let s=t.pop();if(!s)break;e?r.push(this._makePretty(s)):r.push(this._moveToSan(s,this._moves())),this._makeMove(s)}return r}_getPositionCount(e){let t=W(e);return this._positionCount[t]||0}_incPositionCount(e){let t=W(e);this._positionCount[t]===void 0&&(this._positionCount[t]=0),this._positionCount[t]+=1}_decPositionCount(e){let t=W(e);this._positionCount[t]===1?delete this._positionCount[t]:this._positionCount[t]-=1}_pruneComments(){let e=[],t={},r=s=>{s in this._comments&&(t[s]=this._comments[s])};for(;this._history.length>0;)e.push(this._undoMove());for(r(this.fen());;){let s=e.pop();if(!s)break;this._makeMove(s),r(this.fen())}this._comments=t}getComment(){return this._comments[this.fen()]}setComment(e){this._comments[this.fen()]=e.replace("{","[").replace("}","]")}deleteComment(){let e=this._comments[this.fen()];return delete this._comments[this.fen()],e}getComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>({fen:e,comment:this._comments[e]}))}deleteComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>{let t=this._comments[e];return delete this._comments[e],{fen:e,comment:t}})}setCastlingRights(e,t){for(let s of[E,I])t[s]!==void 0&&(t[s]?this._castling[e]|=j[s]:this._castling[e]&=~j[s]);this._updateCastlingRights();let r=this.getCastlingRights(e);return(t[E]===void 0||t[E]===r[E])&&(t[I]===void 0||t[I]===r[I])}getCastlingRights(e){return{[E]:(this._castling[e]&j[E])!==0,[I]:(this._castling[e]&j[I])!==0}}moveNumber(){return this._moveNumber}};var Ae=["1-0","0-1","1/2-1/2","*"];function ie(a){if(a=qe(a).replace(/\{[^}]*\}/g,"").replace(/;.+$/gm,"").replace(/\b(-?\d+)\./g,"$1 .").replace(/\.+/g,n=>n.length>2?"... ":"").replace(/\s+/g," ").trim(),a==="")return[];let e=a.split(" ").filter(n=>!n.match(/^\$\d+$/)),t=e[e.length-1];t&&Ae.includes(t)&&e.pop(),e[0]=="..."&&e.shift();let r=[],s,i=0;for(let n=0;n<e.length;n++){let o=e[n];if(z(o))s!=o?(s=o,i=0):e[n+1]=="..."&&n++;else if(o=="...")r.length>0&&(z(e[n-1])||z(e[n+1]))&&(r.push(o),i++);else if(i<2)r.push(o),i++;else break}return r}function z(a){return/^-?\d+$/.test(a)}function qe(a){for(;;){let e=a.replace(/\([^()]*\)/g,"");if(e==a)return a;a=e}}function R(a,...e){let t=a.split(" ");for(let r of e)r(t);return t.join(" ")}var $=a=>{a[1]=a[1]=="b"?"w":"b",a[3]="-"},ne=a=>{a[1]=="w"&&(a[5]=Number(a[5])+1)},ae=a=>{a[4]=0,a[5]=1};var Ie=16;function le(a,e){var f;if(!a)return null;let{from:t,to:r,unpromote:s}=a;if(e.get(r))return null;let i=a.uncapture=="c",n=i?"p":a.uncapture,o=(f=e.get(t))==null?void 0:f.type;if(!Re(o,i,s)||!Fe(e.state.history[e.state.moveNumber],t,r))return null;let c=e.turn()=="b",h=e.getCastlingRights(c?"w":"b");if(!Oe(o,h,c,t))return null;let p=R(e.fen(),$),g=new L(p),l=g.remove(t),b=t[1];return s&&(l.type="p"),l.type=="p"&&(c&&b=="2"||!c&&b=="7")||!g.put(l,r)?null:{type:o,ep:i,uncapture:n,unpromote:s,isWhite:c,temp:g,piece:l,rank:b,from:t,to:r}}function Re(a,e,t){return!(!a||e&&a!="p"||t&&(a=="p"||a=="k"))}function Fe(a,e,t){if(a&&a.flags=="e"){let r=a.to.replace("3","4").replace("6","5"),s=a.to.replace("3","2").replace("6","7");if(e!=r||t!=s)return!1}return!0}function Oe(a,e,t,r){return!(a=="k"&&(e.k||e.q)||a=="r"&&r==(t?"a1":"a8")&&e.q||a=="r"&&r==(t?"h1":"h8")&&e.k)}function he(a,e){let{isWhite:t,uncapture:r,rank:s,ep:i,from:n,temp:o}=a,c=t?"b":"w";if(r=="p"&&(s=="1"||s=="8"))return console.log("Cannot uncapture a pawn at the 1st or the 8th rank."),!1;if(e.board().flat().filter(g=>g&&g.color==c).length>=Ie)return console.log("Too many uncapturing."),!1;let h={type:r,color:c},p=i?Le(n):n;if(i&&s!=(t?"6":"3")||i&&o.get(p)||!o.put(h,p))return!1;if(i){let g=R(o.fen(),l=>l[3]=n);o.load(g)}return!0}function Le(a){return a.replace("3","4").replace("6","5")}function fe(a){let{isWhite:e,piece:t,from:r,to:s,temp:i}=a;if(t.type=="k"&&(e&&s=="e1"||!e&&s=="e8")){let n=s[1];if(r=="g"+n){if(!ce(i,"f"+n,"h"+n))return!1;i.setCastlingRights(t.color,{k:!0})}if(r=="c"+n){if(!ce(i,"d"+n,"a"+n))return!1;i.setCastlingRights(t.color,{q:!0})}}return!0}function ce(a,e,t){if(a.get(t))return!1;let r=a.remove(e);return r?(a.put(r,t),!0):!1}function ue(a){let{type:e,unpromote:t,from:r,to:s,temp:i}=a,o=i.moves({verbose:!0}).find(h=>h.from==s&&h.to==r&&(!t||h.promotion==e));return o?J(o.before).isCheck()?(console.log("must retract checking"),null):o:null}function J(a){return new L(R(a,$))}var Me=(r=>(r[r.notYet=0]="notYet",r[r.checkmate=1]="checkmate",r[r.draw=2]="draw",r))(Me||{}),Q=class extends L{constructor(t={}){super();k(this,"state");this.state=t,this.state.history=this.state.history||[]}checkPromotion(t,r){return this.moves({verbose:!0}).some(i=>i.from==t&&i.to==r&&i.flags.includes("p"))}switchSide(){this.load(R(this.fen(),$))}init(t){try{this.state.initFEN=t,this.state.history.length=0,this.state.moveNumber=-1,this.load(t);let r=this.board(),s=n=>n.some(o=>o&&o.type=="p");if(s(r[0])||s(r[7]))throw new Error("pawns cannot be on the 1st or the 8th rank");let i=J(t);if(i.isCheck()){if(this.isCheck())throw new Error("both kings are under checks");this.state.initFEN=i.fen(),this.load(this.state.initFEN)}}catch(r){if(r instanceof Error){let s=r.message.replace(/^.+:/,"").trim().replace(/[^.]$/,"$&.");throw new Error("The position is not playable: "+s)}}}retract(t){let r=le(t,this);if(!r||r.uncapture&&!he(r,this)||!fe(r))return!1;let s=ue(r);if(!s)return!1;this.state.moveNumber>=0&&(s.before=R(s.before,ne)),this.load(s.before);let i=this.state;return i.history.length=i.moveNumber+1,i.history.push(s),i.moveNumber++,!0}move(t){let r=this.state,s=this.fen(),i=r.history.concat();try{let n=super.move(t);this.isDraw()&&(n.san+="="),r.history.length=r.moveNumber+1;let o=r.history[r.history.length-1];return r.mode=="pass"&&o&&n.color==o.color&&n.color=="w"&&(n.before=n.before.replace(/\d+$/,c=>(Number(c)+1).toString()),n.after=n.after.replace(/\d+$/,c=>(Number(c)+1).toString())),this.load(n.after),r.over=this.overState(),r.history.push(n),r.moveNumber++,n}catch(n){throw r.history=i,this.load(s),n}}addMoves(t){if(!t||t.length==0)return;let r=this.state.mode=="retro"?this.addRetroMoves(t):this.addNormalMoves(t);if(r)throw new Error("Something went wrong in the move: "+r)}addRetroMoves(t){for(let r of t){if(r=="...")continue;let s=je(r);if(!s||!this.retract(s))return r}}addNormalMoves(t){let r=!1,s=this.state.mode=="pass";for(let i of t)if(i=="...")s&&this.switchSide();else if(this.move(i))r=!0;else{if(!r&&s&&(this.switchSide(),this.move(i)))continue;return i}}overState(){return this.isCheckmate()?1:this.isDraw()?2:0}copyGame(t,r){let s=r?r.concat(this.state.history):this.state.history;return Ke(s,t)}copyPGN(t){let r="";if(this.state.mode=="retro"){let s=this.state.history,i=s.length-1,n=s.length>0?s[i].before:this.state.initFEN,o=R(n,ae);o!=F&&(r+='[SetUp "1"]\n[FEN "'.concat(o,'"]\n\n'));let c=1;for(let h=i;h>=0;h--)(s[h].color=="w"||h==i)&&(r+=c+++". ",h==i&&s[h].color=="b"&&(r+="... ")),r+=s[h].san+" "}else{let s=t&&t.length?t[0].before:this.state.initFEN;s!=F&&(r+='[SetUp "1"]\n[FEN "'.concat(s,'"]\n\n')),r+=this.copyGame({},t)}return r}loadGame(t){let r=t.match(/\[fen "([^"]+)"\]/i),s=r?r[1]:F;this.init(s),t=t.replace(/\[[^\]]+\]/g,"").trim();let i=ie(t);this.state.mode=i.includes("...")?"pass":"normal",this.addMoves(i),this.state.over=this.overState(),this.goto()}goto(t){let r=this.getFenOf(t);return this.load(r),this.state.moveNumber=t?this.state.history.indexOf(t):-1,r}getFenOf(t){return t?this.state.mode=="retro"?t.before:t.after:this.state.initFEN}};k(Q,"options");function Ke(a,e){if(a.length==0)return"";let t="";a[0].color=="b"&&(t+=a[0].before.split(" ")[5]+"... ");for(let[r,s]of a.entries())a[r-1]&&a[r-1].color==s.color&&(s.color=="w"?t+="... ":t+=de(s)+"... "),s.color=="w"&&(t+=de(s)+". "),t+=De(s,void 0,e)+" ";return t.trimEnd()}function de(a,e,t=Q.options){if(!a)return"";let r=a.before.match(/\d+$/)[0];return(e=="retro"&&t.negative?"-":"")+r}function De(a,e,t=Q.options){if(!a)return"";let r=e=="retro",s=r?$e(a):a.san,i=Ue(t.symbol);if(i)for(let[n,o]of Object.entries(i))s=s.replace(n,o);return(r||t.ep)&&a.flags.includes("e")&&(s=s.replace(/([+#=]?)$/,"ep$1")),t.zero&&(s=s.replace("O-O-O","0-0-0").replace("O-O","0-0")),a.annotation&&(s+=a.annotation),s}function Ue(a){return a=="unicode"?Qe:a=="german"?Be:null}function $e(a){if(a.flags=="k"||a.flags=="q")return a.san;let e=a.piece.toUpperCase(),t=a.captured?a.captured.toUpperCase():"",r=a.san.match(/[+#=]$/),s=r?r[0]:"";return(e=="P"?"":e)+a.from+(a.captured?"x"+t:"-")+a.to+(a.promotion?"="+a.promotion.toUpperCase():"")+s}var Qe={K:"\u2654",Q:"\u2655",B:"\u2657",N:"\u2658",R:"\u2656",P:"\u2659"},Be={K:"K",Q:"D",B:"L",N:"S",R:"T",P:"B"};function je(a){let e=a.match(/^\w?([a-h][1-8])[-x](\w?)([a-h][1-8])(ep)?(?:=(\w))?/);if(!e)return null;let t;return e[4]?t="c":e[2]&&(t=e[2].toLowerCase()),{from:e[3],to:e[1],uncapture:t,unpromote:!!e[5]}}export{Q as Chess,De as format,Ke as formatGame,de as number,Me as overState,ie as parseMoves};
//# sourceMappingURL=chess.js.map
